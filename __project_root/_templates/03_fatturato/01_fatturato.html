{% extends "01_base.html" %}

{% block title %}Fatturato Clienti{% endblock %}

{% block content %}
<h1 class="mb-4 text-white">Fatturato Clienti</h1>

<!-- Filtro zona e mesi -->
<form method="get" class="mb-4 d-flex align-items-center gap-3 flex-wrap">
  <label for="zona" class="text-white mb-0 fw-semibold">Filtra per zona:</label>
  <select id="zona" name="zona" onchange="this.form.submit()" class="form-select w-auto">
    <option value="tutte" {% if zona_filtro == 'tutte' %}selected{% endif %}>Tutte le zone</option>
    {% for z in zone %}
      <option value="{{ z.zona }}" {% if zona_filtro == z.zona %}selected{% endif %}>{{ z.zona }}</option>
    {% endfor %}
  </select>
</form>

<!-- Cards riepilogo -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card bg-secondary text-white shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Clienti Totali</h5>
        <p class="card-text fs-3 fw-bold">{{ clienti|length }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card bg-secondary text-white shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Fatturato Totale (€)</h5>
        <p class="card-text fs-3 fw-bold">
          € {{ clienti|map(attribute='fatturato_totale')|sum|default(0)|float|round(2) }}
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card bg-secondary text-white shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Media Fatturato (€)</h5>
        <p class="card-text fs-3 fw-bold">
          {% set totale = clienti|map(attribute='fatturato_totale')|sum %}
          € {{ (totale / (clienti|length) if clienti|length > 0 else 0) | round(2) }}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Grafico fatturato mensile totale -->
<div class="card mb-4 bg-secondary text-white shadow-sm rounded-3">
  <div class="card-body">
    <h5 class="card-title mb-4">Fatturato Mensile Totale (ultimi 3 mesi)</h5>
    <canvas id="fatturatoMensileChart" height="150"></canvas>
  </div>
</div>

<!-- Tabella clienti -->
{% if clienti %}
<div class="table-responsive">
  <table class="table table-striped table-dark align-middle rounded-3">
    <thead>
      <tr>
        <th>Nome Cliente</th>
        <th>Zona</th>
        <th class="text-end">Fatturato Totale (€)</th>
      </tr>
    </thead>
    <tbody>
      {% for cliente in clienti %}
        <tr>
          <td>{{ cliente.nome }}</td>
          <td>{{ cliente.zona or '–' }}</td>
          <td class="text-end">€ {{ "%.2f"|format(cliente.fatturato_totale or 0) }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">Nessun cliente disponibile.</p>
{% endif %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const fatturatoMensileRaw = {{ fatturato_mensile|default({})|tojson }};
  const mesiOrdinati = Object.keys(fatturatoMensileRaw).sort();
  const ultimi3Mesi = mesiOrdinati.slice(-3);

  const mesiNomi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
  const labels = ultimi3Mesi.map(m => {
    const [anno, mese] = m.split('-');
    return mesiNomi[parseInt(mese,10)-1] + " '" + anno.slice(2);
  });
  const valori = ultimi3Mesi.map(m => fatturatoMensileRaw[m]);

  const ctx = document.getElementById('fatturatoMensileChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Fatturato (€)',
        data: valori,
        backgroundColor: 'rgba(74,144,226,0.8)',
        borderRadius: 5,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a2638',
          titleColor: '#4a90e2',
          bodyColor: '#cfd8e6',
          cornerRadius: 6,
          padding: 8,
          displayColors: false
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#a0a8b7', font: { weight: '600' } } },
        y: { beginAtZero: true, grid: { color: 'rgba(160,168,183,0.2)' }, ticks: { color: '#a0a8b7' } }
      }
    }
  });
})();
</script>
{% endblock %}


