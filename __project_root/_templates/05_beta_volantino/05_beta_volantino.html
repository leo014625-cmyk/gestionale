{% extends "01_base.html" %}

{% block title %}BETA Volantino - Gestionale Horeca{% endblock %}

{% block content %}

<h1 class="mb-4">üß™ BETA ‚Äì Editor Volantino (Stile InPublish)</h1>

<div class="row">

  <!-- TOOLBAR LATERALE -->
  <div class="col-md-3">

    <!-- Nome volantino -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header fw-bold">
        <i class="bi bi-card-text me-1"></i> Nome volantino
      </div>
      <div class="card-body">
        <input type="text" id="volantino-nome" class="form-control form-control-sm"
               placeholder="Es. VOLANTINO ITTICO NOVEMBRE"
               value="{{ nome_volantino or '' }}">
      </div>
    </div>

    <!-- Pagine -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-journal-text me-1"></i> Pagine</span>
      </div>
      <div class="card-body">
        <div id="lista-pagine" class="mb-2"></div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary btn-sm" id="aggiungi-pagina">
            ‚ûï Aggiungi pagina
          </button>
          <button class="btn btn-outline-primary btn-sm" id="duplica-pagina">
            üìÑ Duplica pagina corrente
          </button>
        </div>
      </div>
    </div>

    <!-- Zoom Header -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header fw-bold">
        <i class="bi bi-aspect-ratio me-1"></i> Zoom immagine header
      </div>
      <div class="card-body">
        <input type="range" id="header-zoom" class="form-range" min="1" max="3" step="0.05" value="1">
        <div class="small text-muted">Agisce sulla pagina corrente (immagine in alto).</div>
      </div>
    </div>

    <!-- Layout griglia -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header fw-bold">
        <i class="bi bi-grid-3x3-gap-fill me-1"></i> Layout griglia pagina
      </div>
      <div class="card-body">
        <!-- Righe fisse = 3: questi bottoni cambiano SOLO le colonne -->
        <button class="btn btn-outline-primary w-100 mb-2" data-grid="2x3">Griglia 2 √ó 3</button>
        <button class="btn btn-outline-primary w-100 mb-2" data-grid="3x3">Griglia 3 √ó 3</button>
        <button class="btn btn-outline-primary w-100 mb-2" data-grid="4x3">Griglia 4 √ó 3</button>
        <small class="text-muted d-block mt-1">
          Righe sempre 3 fisse. Le box sono tutte uguali.
        </small>
      </div>
    </div>

    <!-- Stile prezzo (shortcut rapido) -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header fw-bold">
        <i class="bi bi-tag-fill me-1"></i> Stile prezzo (rapido)
      </div>
      <div class="card-body d-grid gap-2">
        <button class="btn btn-warning btn-sm" data-price-style="yellow">Cartellino giallo</button>
        <button class="btn btn-danger btn-sm" data-price-style="red">Cartellino rosso</button>
        <button class="btn btn-info btn-sm" data-price-style="blue">Cartellino blu</button>
        <button class="btn btn-outline-secondary btn-sm" data-price-style="round">Tondo</button>
        <button class="btn btn-outline-secondary btn-sm" data-price-style="angle">Angolo promo</button>
        <button class="btn btn-outline-secondary btn-sm" data-price-style="strike">Barrato + nuovo</button>
        <button class="btn btn-outline-secondary btn-sm" data-price-style="base">Semplice</button>
        <small class="text-muted">
          Puoi anche gestire il prezzo nel popup della box.
        </small>
      </div>
    </div>

    <!-- Azioni celle / volantino -->
    <div class="card shadow-sm">
      <div class="card-header fw-bold">
        <i class="bi bi-tools me-1"></i> Azioni
      </div>
      <div class="card-body d-grid gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="duplica-cella">
          üìÑ Duplica cella selezionata
        </button>
        <button class="btn btn-outline-danger btn-sm" id="elimina-cella">
          üóëÔ∏è Elimina cella selezionata
        </button>
        <hr>
        <button class="btn btn-outline-primary w-100 mb-2" id="save-layout">
          üíæ Salva Volantino
        </button>
        <button class="btn btn-outline-dark w-100 mb-2" id="export-pdf">
          üìÑ Esporta PDF
        </button>
        <button class="btn btn-outline-success w-100" id="export-png">
          üñºÔ∏è Esporta pagina corrente PNG
        </button>
      </div>
    </div>

  </div>

  <!-- AREA VOLANTINO -->
  <div class="col-md-9">
    <div id="pagine-container" style="width: 800px; margin:auto;">
      <!-- Le pagine verranno iniettate via JS -->
    </div>
  </div>

</div>

<!-- ============================================
     MODAL EDITOR CELLA (stile InPublish)
============================================= -->
<div class="modal fade" id="cellEditorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚úèÔ∏è Modifica box prodotto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Chiudi"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <!-- COLONNA IMMAGINE -->
          <div class="col-md-5">
            <label class="form-label small text-muted">Immagine prodotto</label>

            <div id="modal-image-preview"
                 class="border rounded d-flex align-items-center justify-content-center mb-2 ratio ratio-4x3 bg-light"
                 style="overflow:hidden; cursor:grab;">
              <span class="text-muted small">Clicca per caricare immagine</span>
            </div>

            <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="modal-change-image">
              üñºÔ∏è Cambia immagine
            </button>
            <input type="file" id="modal-image-input" class="d-none" accept="image/*">

            <div class="mt-2">
              <label class="form-label small text-muted">Zoom immagine</label>
              <input type="range" id="modal-image-zoom" class="form-range" min="0.5" max="3" step="0.05" value="1">
            </div>

            <div class="mt-2">
              <label class="form-label small text-muted">Posizione orizzontale</label>
              <input type="range" id="modal-image-pos-x" class="form-range" min="0" max="100" step="1" value="50">
            </div>
            <div class="mt-2">
              <label class="form-label small text-muted">Posizione verticale</label>
              <input type="range" id="modal-image-pos-y" class="form-range" min="0" max="100" step="1" value="50">
            </div>

            <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" id="modal-image-center">
              üéØ Centra immagine
            </button>

            <div class="mt-3">
              <label class="form-label small text-muted">Effetto immagine</label>
              <select id="modal-image-filter" class="form-select form-select-sm">
                <option value="none">Nessuno</option>
                <option value="bw">Bianco e nero</option>
                <option value="warm">Caldo</option>
                <option value="cool">Freddo</option>
                <option value="contrast">Contrasto forte</option>
              </select>
            </div>
          </div>

          <!-- COLONNA DATI PRODOTTO -->
          <div class="col-md-7">

            <div class="mb-2">
              <label class="form-label small">Nome prodotto</label>
              <input type="text" id="modal-title" class="form-control form-control-sm"
                     placeholder="Es. Salmone norvegese intero">
            </div>

            <div class="mb-2">
              <label class="form-label small">Descrizione</label>
              <textarea id="modal-desc" class="form-control form-control-sm" rows="3"
                        placeholder="Esempio: Prodotto ittico fresco, allevato in Norvegia..."></textarea>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label small">Prezzo</label>
                <input type="text" id="modal-price" class="form-control form-control-sm"
                       placeholder="Es. ‚Ç¨ 9,90">
              </div>
              <div class="col-6">
                <label class="form-label small">Stile prezzo</label>
                <select id="modal-price-style" class="form-select form-select-sm">
                  <option value="base">Semplice</option>
                  <option value="yellow">Cartellino giallo</option>
                  <option value="red">Cartellino rosso</option>
                  <option value="blue">Cartellino blu</option>
                  <option value="round">Tondo</option>
                  <option value="angle">Angolo promo</option>
                  <option value="strike">Barrato + nuovo</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label small">Layout box</label>
                <select id="modal-layout" class="form-select form-select-sm">
                  <option value="image-top">Immagine sopra, testo sotto</option>
                  <option value="image-left">Immagine sinistra, testo destra</option>
                  <option value="full-image-price">Immagine piena con prezzo</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label small">Allineamento testo</label>
                <select id="modal-align" class="form-select form-select-sm">
                  <option value="start">Sinistra</option>
                  <option value="center">Centro</option>
                  <option value="end">Destra</option>
                </select>
              </div>
            </div>

            <!-- Tipografia -->
            <div class="border rounded p-2 mb-2 bg-light-subtle">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Font</label>
                  <select id="modal-font-family" class="form-select form-select-sm">
                    <option value="">Default</option>
                    <option value="Roboto, sans-serif">Roboto</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="Montserrat, sans-serif">Montserrat</option>
                    <option value="'Lato', sans-serif">Lato</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label small">Colore testo</label>
                  <input type="color" id="modal-font-color" class="form-control form-control-sm" value="#000000">
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-4">
                  <label class="form-label small">Titolo (px)</label>
                  <input type="number" id="modal-title-size" class="form-control form-control-sm" min="8" max="40" value="14">
                </div>
                <div class="col-4">
                  <label class="form-label small">Descrizione (px)</label>
                  <input type="number" id="modal-desc-size" class="form-control form-control-sm" min="8" max="30" value="11">
                </div>
                <div class="col-4">
                  <label class="form-label small">Prezzo (px)</label>
                  <input type="number" id="modal-price-size" class="form-control form-control-sm" min="8" max="40" value="16">
                </div>
              </div>

              <div class="mt-2 d-flex flex-wrap gap-3">
                <div class="form-check form-check-sm">
                  <input class="form-check-input" type="checkbox" id="modal-title-bold">
                  <label class="form-check-label small">Titolo grassetto</label>
                </div>
                <div class="form-check form-check-sm">
                  <input class="form-check-input" type="checkbox" id="modal-desc-italic">
                  <label class="form-check-label small">Descrizione corsivo</label>
                </div>
                <div class="form-check form-check-sm">
                  <input class="form-check-input" type="checkbox" id="modal-price-bold">
                  <label class="form-check-label small">Prezzo grassetto</label>
                </div>
                <div class="form-check form-check-sm">
                  <input class="form-check-input" type="checkbox" id="modal-text-uppercase">
                  <label class="form-check-label small">TUTTO MAIUSCOLO</label>
                </div>
              </div>
            </div>

            <!-- Stile box -->
            <div class="border rounded p-2 mb-2 bg-light-subtle">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Bordo</label>
                  <select id="modal-border-style" class="form-select form-select-sm">
                    <option value="solid">Solido</option>
                    <option value="dashed">Tratteggiato</option>
                    <option value="none">Nessuno</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label small">Colore bordo</label>
                  <input type="color" id="modal-border-color" class="form-control form-control-sm" value="#dddddd">
                </div>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-4">
                  <label class="form-label small">Radius (px)</label>
                  <input type="number" id="modal-radius" class="form-control form-control-sm" min="0" max="30" value="4">
                </div>
                <div class="col-4">
                  <label class="form-label small">Sfondo</label>
                  <input type="color" id="modal-bgcolor" class="form-control form-control-sm" value="#ffffff">
                </div>
                <div class="col-4 d-flex align-items-end">
                  <div class="form-check form-check-sm">
                    <input class="form-check-input" type="checkbox" id="modal-shadow">
                    <label class="form-check-label small">Ombra</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Libreria demo -->
            <div class="border rounded p-2 bg-light-subtle">
              <label class="form-label small">Libreria prodotti demo</label>
              <select id="modal-product-library" class="form-select form-select-sm">
                <option value="">-- scegli --</option>
                <option value="salmone">Salmone norvegese intero</option>
                <option value="gamberi">Gamberi argentini sgusciati</option>
                <option value="polpo">Polpo mediterraneo decongelato</option>
              </select>
              <small class="text-muted d-block mt-1">Solo esempio: non collegato al gestionale</small>
            </div>

          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" id="modal-save">üíæ Salva box</button>
      </div>

    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:9999;">
  <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body" id="appToastBody">OK</div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  let pagine = [];
  let paginaCorrente = 0;
  let cellaSelezionata = null;

  const pagineContainer = document.getElementById("pagine-container");
  const listaPagine = document.getElementById("lista-pagine");
  const inputNome = document.getElementById("volantino-nome");

  /* ----------------------
       TOAST
  -----------------------*/
  const toastEl = document.getElementById("appToast");
  const toastBody = document.getElementById("appToastBody");
  const toast = toastEl ? new bootstrap.Toast(toastEl, { delay: 1800 }) : null;

  function showToast(msg) {
    if (!toast) return;
    toastBody.textContent = msg;
    toast.show();
  }

  /* ----------------------
       AUTOSAVE (dirty flag + protezione)
  -----------------------*/
  let dirty = false;
  let autosaveTimer = null;

  function markDirty() {
    dirty = true;
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => { /* hook autosave se vuoi */ }, 1200);
  }

  window.addEventListener("beforeunload", (e) => {
    if (!dirty) return;
    e.preventDefault();
    e.returnValue = "";
  });

  /* ----------------------
       SELEZIONE
  -----------------------*/
  let selectedCells = new Set();

  function clearSelection() {
    selectedCells.forEach(c => c.classList.remove("cella-selezionata"));
    selectedCells.clear();
    cellaSelezionata = null;
  }

  function selectCell(cell, add=false) {
    if (!add) clearSelection();
    selectedCells.add(cell);
    cell.classList.add("cella-selezionata");
    cellaSelezionata = cell;
  }

  function applyToSelected(fn) {
    if (!selectedCells.size) return;
    selectedCells.forEach(cell => {
      fn(cell);
      applyCellSize(cell);
      applyPriceStyle(cell);
      applyLayout(cell);
      applyTextAlign(cell);
      applyTypography(cell);
      applyBoxStyle(cell);
      applyImageFilter(cell);
      applyImageTransform(cell);
    });
    markDirty();
  }

  window.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && cellaSelezionata) {
      apriEditorCella(cellaSelezionata);
    }
    if (e.key === "Escape") {
      clearSelection();
    }
    if (e.key === "Delete" && selectedCells.size) {
      selectedCells.forEach(c => c.remove());
      clearSelection();
      markDirty();
      showToast("Celle eliminate");
    }
  });

  /* ----------------------
       HEADER ZOOM (pagina corrente)
  -----------------------*/
  const headerZoomInput = document.getElementById("header-zoom");

  function applyHeaderZoom(pageEl) {
    const z = parseFloat(pageEl.dataset.headerZoom || "1");
    const img = pageEl.querySelector(".page-header img");
    if (!img) return;
    img.style.transform = `scale(${z})`;
  }

  function syncHeaderZoomUI() {
    const page = pagine[paginaCorrente];
    if (!page || !headerZoomInput) return;
    const z = parseFloat(page.dataset.headerZoom || "1");
    headerZoomInput.value = z;
    applyHeaderZoom(page);
  }

  if (headerZoomInput) {
    headerZoomInput.addEventListener("input", () => {
      const page = pagine[paginaCorrente];
      if (!page) return;
      page.dataset.headerZoom = String(parseFloat(headerZoomInput.value));
      applyHeaderZoom(page);
      markDirty();
    });
  }

  /* ----------------------
       VARIABILI MODAL
  -----------------------*/
  const cellEditorModalEl = document.getElementById("cellEditorModal");
  const cellEditorModal = new bootstrap.Modal(cellEditorModalEl);

  const modalImagePreview = document.getElementById("modal-image-preview");
  const modalChangeImage = document.getElementById("modal-change-image");
  const modalImageInput = document.getElementById("modal-image-input");
  const modalImageZoom = document.getElementById("modal-image-zoom");
  const modalImageFilter = document.getElementById("modal-image-filter");

  const modalImagePosX = document.getElementById("modal-image-pos-x");
  const modalImagePosY = document.getElementById("modal-image-pos-y");
  const modalImageCenter = document.getElementById("modal-image-center");

  const modalTitle = document.getElementById("modal-title");
  const modalDesc = document.getElementById("modal-desc");
  const modalPrice = document.getElementById("modal-price");
  const modalPriceStyle = document.getElementById("modal-price-style");

  const modalLayout = document.getElementById("modal-layout");
  const modalAlign = document.getElementById("modal-align");

  const modalFontFamily = document.getElementById("modal-font-family");
  const modalFontColor = document.getElementById("modal-font-color");
  const modalTitleSize = document.getElementById("modal-title-size");
  const modalDescSize = document.getElementById("modal-desc-size");
  const modalPriceSize = document.getElementById("modal-price-size");
  const modalTitleBold = document.getElementById("modal-title-bold");
  const modalDescItalic = document.getElementById("modal-desc-italic");
  const modalPriceBold = document.getElementById("modal-price-bold");
  const modalTextUpper = document.getElementById("modal-text-uppercase");

  const modalBorderStyle = document.getElementById("modal-border-style");
  const modalBorderColor = document.getElementById("modal-border-color");
  const modalRadius = document.getElementById("modal-radius");
  const modalBgColor = document.getElementById("modal-bgcolor");
  const modalShadow = document.getElementById("modal-shadow");

  const modalProductLibrary = document.getElementById("modal-product-library");
  const modalSave = document.getElementById("modal-save");

  let modalImageData = "";
  let modalZoomValue = 1;
  let modalPosX = 50;
  let modalPosY = 50;

  function applyModalImageTransform() {
    const img = document.querySelector("#modal-img");
    if (!img) return;
    img.style.transform = `scale(${modalZoomValue})`;
    img.style.objectPosition = `${modalPosX}% ${modalPosY}%`;
  }

  /* Drag per spostare l'inquadratura nel modal */
  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let startPosX = 50;
  let startPosY = 50;

  modalImagePreview.addEventListener("mousedown", (e) => {
    const img = document.querySelector("#modal-img");
    if (!img) return;
    isDragging = true;
    modalImagePreview.style.cursor = "grabbing";
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    startPosX = modalPosX;
    startPosY = modalPosY;
    e.preventDefault();
  });

  window.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const sensitivity = 0.12 / Math.max(0.6, modalZoomValue);
    const dx = (e.clientX - dragStartX) * sensitivity;
    const dy = (e.clientY - dragStartY) * sensitivity;

    modalPosX = Math.max(0, Math.min(100, startPosX - dx));
    modalPosY = Math.max(0, Math.min(100, startPosY - dy));

    modalImagePosX.value = Math.round(modalPosX);
    modalImagePosY.value = Math.round(modalPosY);

    applyModalImageTransform();
  });

  window.addEventListener("mouseup", () => {
    if (!isDragging) return;
    isDragging = false;
    modalImagePreview.style.cursor = "grab";
  });

  /* ----------------------
     LIBRERIA PRODOTTI DEMO
  -----------------------*/
  const productLibrary = {
    "salmone": {
      titolo: "Salmone norvegese intero",
      descrizione: "Salmone allevato in Norvegia, ideale per forno o carpaccio.",
      prezzo: "‚Ç¨ 9,90"
    },
    "gamberi": {
      titolo: "Gamberi argentini sgusciati",
      descrizione: "Gamberi argentini decongelati, pronti da cucinare.",
      prezzo: "‚Ç¨ 12,50"
    },
    "polpo": {
      titolo: "Polpo mediterraneo decongelato",
      descrizione: "Polpo tenero ideale per insalate e secondi piatti.",
      prezzo: "‚Ç¨ 15,90"
    }
  };

  modalProductLibrary.addEventListener("change", () => {
    const key = modalProductLibrary.value;
    if (!productLibrary[key]) return;
    modalTitle.value = productLibrary[key].titolo;
    modalDesc.value = productLibrary[key].descrizione;
    modalPrice.value = productLibrary[key].prezzo;
  });

  function setModalImage(src) {
    modalImageData = src || "";
    if (!src) {
      modalImagePreview.innerHTML = `<span class="text-muted small">Clicca per caricare immagine</span>`;
    } else {
      modalImagePreview.innerHTML =
        `<img id="modal-img" src="${src}" style="width:100%; height:100%; object-fit:cover;">`;
      applyModalImageTransform();
    }
  }

  modalImageZoom.addEventListener("input", () => {
    modalZoomValue = parseFloat(modalImageZoom.value);
    applyModalImageTransform();
  });
  modalImagePosX.addEventListener("input", () => {
    modalPosX = parseInt(modalImagePosX.value, 10);
    applyModalImageTransform();
  });
  modalImagePosY.addEventListener("input", () => {
    modalPosY = parseInt(modalImagePosY.value, 10);
    applyModalImageTransform();
  });
  modalImageCenter.addEventListener("click", () => {
    modalPosX = 50; modalPosY = 50;
    modalImagePosX.value = 50; modalImagePosY.value = 50;
    applyModalImageTransform();
  });

  modalImagePreview.addEventListener("click", (e) => {
    if (isDragging) return;
    modalChangeImage.click();
  });
  modalChangeImage.addEventListener("click", () => modalImageInput.click());
  modalImageInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => setModalImage(r.result);
    r.readAsDataURL(file);
  });

  /* ----------------------
      FUNZIONI IMMAGINE CELLA
  -----------------------*/
  function applyImageTransform(cell) {
    const img = cell.querySelector(".img-box img");
    if (!img) return;

    const z = parseFloat(cell.dataset.imageZoom || "1");
    const x = parseInt(cell.dataset.imagePosX || "50", 10);
    const y = parseInt(cell.dataset.imagePosY || "50", 10);

    img.style.transform = `scale(${z})`;
    img.style.objectPosition = `${x}% ${y}%`;
  }

  function applyImageFilter(cell) {
    const img = cell.querySelector(".img-box img");
    if (!img) return;

    let f = "none";
    switch (cell.dataset.imageFilter) {
      case "bw": f = "grayscale(1)"; break;
      case "warm": f = "contrast(1.05) saturate(1.2)"; break;
      case "cool": f = "contrast(1.05) saturate(1.1) hue-rotate(-15deg)"; break;
      case "contrast": f = "contrast(1.3) saturate(1.2)"; break;
    }
    img.style.filter = f;
  }

  /* ----------------------
        UPLOAD IMMAGINI HEADER/FOOTER
        + applica zoom header
  -----------------------*/
  function attachImageUpload(box) {
    box.addEventListener("click", (e) => {
      e.stopPropagation();
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = ev => {
        const file = ev.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = () => {
          box.innerHTML = `<img src="${r.result}" style="width:100%; height:100%; object-fit:cover;">`;

          const page = box.closest(".pagina-volantino");
          if (page && box.classList.contains("page-header")) {
            if (!page.dataset.headerZoom) page.dataset.headerZoom = "1";
            applyHeaderZoom(page);
            syncHeaderZoomUI();
          }

          markDirty();
        };
        r.readAsDataURL(file);
      };
      input.click();
    });
  }

  /* ----------------------
       GRIGLIA FISSA: 3 RIGHE
  -----------------------*/
  function setFixedGrid(pageEl, cols, rows = 3) {
    const grid = pageEl.querySelector(".page-grid");
    const header = pageEl.querySelector(".page-header");
    const footer = pageEl.querySelector(".page-footer");

    const gap = 10;

    grid.style.display = "grid";
    grid.style.gap = gap + "px";
    grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    // calcolo altezza righe (3 righe fisse)
    const pageH = pageEl.clientHeight; // 1100px
    const paddingTopBottom = 20; // padding 10 + 10
    const available = pageH - header.offsetHeight - footer.offsetHeight - paddingTopBottom;

    const rowH = Math.floor((available - gap * (rows - 1)) / rows);

    grid.style.gridTemplateRows = `repeat(${rows}, ${rowH}px)`;
    grid.style.alignItems = "stretch";
  }

  /* ----------------------
           PAGINE
  -----------------------*/
  function creaPagina(cols = 3) {
    const page = document.createElement("div");
    page.classList.add("pagina-volantino");
    page.dataset.cols = cols;
    page.dataset.headerZoom = page.dataset.headerZoom || "1";

    page.innerHTML = `
      <div class="page-header img-drop">
        <span class="small text-muted">Clicca per inserire header</span>
      </div>
      <div class="page-grid"></div>
      <div class="page-footer img-drop">
        <span class="small text-muted">Clicca per inserire footer</span>
      </div>
    `;

    const header = page.querySelector(".page-header");
    const footer = page.querySelector(".page-footer");
    const grid   = page.querySelector(".page-grid");

    attachImageUpload(header);
    attachImageUpload(footer);

    // IMPORTANT: griglia fissa 3 righe
    setFixedGrid(page, cols, 3);

    Sortable.create(grid, {
      animation: 150,
      ghostClass: "sortable-ghost",
      onEnd: () => markDirty()
    });

    return page;
  }

  function mostraPaginaCorrente() {
    pagineContainer.innerHTML = "";
    pagineContainer.appendChild(pagine[paginaCorrente]);

    // riallinea grid e header zoom
    const page = pagine[paginaCorrente];
    setFixedGrid(page, parseInt(page.dataset.cols || "3", 10), 3);
    applyHeaderZoom(page);
    syncHeaderZoomUI();
  }

  function aggiornaListaPagine() {
    listaPagine.innerHTML = "";
    pagine.forEach((_, i) => {
      const btn = document.createElement("button");
      btn.classList.add("btn", "btn-sm", "w-100", "mb-2");
      if (i === paginaCorrente) btn.classList.add("btn-primary");
      else btn.classList.add("btn-outline-primary");

      btn.innerText = "Pagina " + (i + 1);
      btn.onclick = () => {
        paginaCorrente = i;
        mostraPaginaCorrente();
        aggiornaListaPagine();
        clearSelection();
      };
      listaPagine.appendChild(btn);
    });
  }
  /* ----------------------
      FUNZIONI STILE CELLE
  -----------------------*/
  function applyCellSize(cell) {
    // ‚úÖ Celle sempre fisse 1x1
    cell.dataset.colspan = "1";
    cell.dataset.rowspan = "1";
    cell.style.gridColumn = "span 1";
    cell.style.gridRow = "span 1";
  }

  function applyPriceStyle(cell) {
    const prezzoEl = cell.querySelector(".prezzo");
    if (!prezzoEl) return;

    prezzoEl.className = "prezzo fw-bold";
    const style = cell.dataset.priceStyle || "base";
    prezzoEl.classList.add("prezzo-" + style);

    if (style === "strike") {
      const old = cell.dataset.oldPrice || "";
      prezzoEl.setAttribute("data-old", old);
    } else {
      prezzoEl.removeAttribute("data-old");
    }
  }

  function applyLayout(cell) {
    const layout = cell.dataset.layout || "image-top";
    const wrapper = cell.querySelector(".cella-inner");
    const imgBox = cell.querySelector(".img-box");
    const textBox = cell.querySelector(".testo-box");
    const prezzoEl = cell.querySelector(".prezzo");

    cell.classList.remove(
      "cella-layout-image-top",
      "cella-layout-image-left",
      "cella-layout-full-image-price"
    );
    cell.classList.add("cella-layout-" + layout);

    if (!wrapper || !imgBox || !textBox) return;

    wrapper.style = "";
    imgBox.style = "";
    textBox.style = "";
    if (prezzoEl) prezzoEl.style = "";

    if (layout === "image-top") {
      wrapper.style.display = "flex";
      wrapper.style.flexDirection = "column";
      // imgBox gestito da flex CSS
    }
    else if (layout === "image-left") {
      wrapper.style.display = "flex";
      wrapper.style.flexDirection = "row";
      imgBox.style.width = "50%";
    }
    else if (layout === "full-image-price") {
      wrapper.style.position = "relative";
      textBox.style.position = "absolute";
      textBox.style.bottom = "6px";
      textBox.style.left = "6px";
      textBox.style.right = "6px";

      if (prezzoEl) {
        prezzoEl.style.position = "absolute";
        prezzoEl.style.top = "6px";
        prezzoEl.style.right = "6px";
      }
    }
  }

  function applyTextAlign(cell) {
    const textBox = cell.querySelector(".testo-box");
    if (!textBox) return;

    textBox.classList.remove("text-start", "text-center", "text-end");
    const align = cell.dataset.textAlign || "start";
    if (align === "center") textBox.classList.add("text-center");
    else if (align === "end") textBox.classList.add("text-end");
    else textBox.classList.add("text-start");
  }

  function applyTypography(cell) {
    const titoloEl = cell.querySelector(".titolo");
    const descEl = cell.querySelector(".descrizione");
    const prezzoEl = cell.querySelector(".prezzo");

    const fontFamily = cell.dataset.fontFamily || "";
    const fontColor = cell.dataset.fontColor || "#000000";
    const titleSize = cell.dataset.titleSize || "14";
    const descSize = cell.dataset.descSize || "11";
    const priceSize = cell.dataset.priceSize || "16";

    const textUpper = cell.dataset.textUpper === "1";
    const titleBold = cell.dataset.titleBold === "1";
    const descItalic = cell.dataset.descItalic === "1";
    const priceBold = cell.dataset.priceBold !== "0";

    [titoloEl, descEl, prezzoEl].forEach(el => {
      if (!el) return;
      el.style.fontFamily = fontFamily;
      el.style.color = fontColor;
      el.style.textTransform = textUpper ? "uppercase" : "none";
    });

    if (titoloEl) {
      titoloEl.style.fontSize = titleSize + "px";
      titoloEl.classList.toggle("fw-bold", titleBold);
    }
    if (descEl) {
      descEl.style.fontSize = descSize + "px";
      descEl.style.fontStyle = descItalic ? "italic" : "normal";
    }
    if (prezzoEl) {
      prezzoEl.style.fontSize = priceSize + "px";
      prezzoEl.classList.toggle("fw-bold", priceBold);
    }
  }

  function applyBoxStyle(cell) {
    cell.style.borderStyle = cell.dataset.borderStyle || "solid";
    cell.style.borderColor = cell.dataset.borderColor || "#dddddd";
    cell.style.borderRadius = (cell.dataset.radius || "4") + "px";
    cell.style.backgroundColor = cell.dataset.bgColor || "#ffffff";
    cell.classList.toggle("cella-shadow", cell.dataset.shadow === "1");
  }

  /* ----------------------
   EVENTI CELLA + CREAZIONE
  -----------------------*/
  function initCellaEvents(cell) {
    cell.addEventListener("click", (e) => {
      e.stopPropagation();
      const add = e.shiftKey || e.ctrlKey || e.metaKey;
      selectCell(cell, add);
    });

    cell.addEventListener("dblclick", (e) => {
      e.stopPropagation();
      selectCell(cell, false);
      apriEditorCella(cell);
    });
  }

  function creaCella() {
    const cell = document.createElement("div");
    cell.classList.add("cella-prodotto");

    // fissi 1x1
    cell.dataset.colspan = "1";
    cell.dataset.rowspan = "1";

    cell.dataset.priceStyle = "base";
    cell.dataset.layout = "image-top";
    cell.dataset.textAlign = "start";

    cell.dataset.fontFamily = "";
    cell.dataset.fontColor = "#000000";
    cell.dataset.titleSize = "14";
    cell.dataset.descSize = "11";
    cell.dataset.priceSize = "16";
    cell.dataset.textUpper = "0";
    cell.dataset.titleBold = "1";
    cell.dataset.descItalic = "0";
    cell.dataset.priceBold = "1";

    cell.dataset.borderStyle = "solid";
    cell.dataset.borderColor = "#dddddd";
    cell.dataset.radius = "4";
    cell.dataset.bgColor = "#ffffff";
    cell.dataset.shadow = "0";

    cell.dataset.imageFilter = "none";
    cell.dataset.imageZoom = "1";
    cell.dataset.imagePosX = "50";
    cell.dataset.imagePosY = "50";

    cell.dataset.oldPrice = "";

    // ‚úÖ Niente resize handle
    cell.innerHTML = `
      <div class="cella-inner">
        <div class="img-box border mb-1 bg-light d-flex align-items-center justify-content-center">
          <span class="text-muted small">Doppio click per modificare</span>
        </div>
        <div class="testo-box">
          <div class="titolo fw-bold small mb-1">TITOLO PRODOTTO</div>
          <div class="descrizione small text-muted mb-1">Descrizione prodotto</div>
          <div class="prezzo fw-bold prezzo-base">‚Ç¨ 0,00</div>
        </div>
      </div>
    `;

    initCellaEvents(cell);

    applyCellSize(cell);
    applyPriceStyle(cell);
    applyLayout(cell);
    applyTextAlign(cell);
    applyTypography(cell);
    applyBoxStyle(cell);

    return cell;
  }

  /* click fuori: deseleziona (ma non nel modal) */
  document.addEventListener("click", e => {
    if (e.target.closest("#cellEditorModal")) return;
    if (e.target.closest(".cella-prodotto")) return;
    clearSelection();
  });

  /* ----------------------
   BOTTONI STILE PREZZO (multi-selezione)
  -----------------------*/
  document.querySelectorAll("[data-price-style]").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!selectedCells.size) return showToast("Seleziona una o pi√π celle");
      const style = btn.dataset.priceStyle;
      applyToSelected(cell => { cell.dataset.priceStyle = style; });
      showToast("Stile prezzo applicato");
    });
  });

  /* ----------------------
       GRIGLIA PAGINA (colonne + 3 righe fisse)
  -----------------------*/
  document.querySelectorAll("[data-grid]").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!pagine.length) return;

      const [cols] = btn.dataset.grid.split("x").map(Number);
      const rows = 3;

      const page = pagine[paginaCorrente];
      const grid = page.querySelector(".page-grid");

      page.dataset.cols = cols;

      setFixedGrid(page, cols, rows);
      grid.innerHTML = "";

      for (let i = 0; i < cols * rows; i++) {
        grid.appendChild(creaCella());
      }

      Sortable.create(grid, { animation: 150, ghostClass: "sortable-ghost", onEnd: () => markDirty() });

      clearSelection();
      markDirty();
      showToast("Griglia aggiornata (3 righe fisse)");
    });
  });

  /* ----------------------
   AGGIUNGI / DUPLICA PAGINA
  -----------------------*/
  document.getElementById("aggiungi-pagina").addEventListener("click", () => {
    const nuova = creaPagina(3);
    pagine.push(nuova);
    paginaCorrente = pagine.length - 1;
    mostraPaginaCorrente();
    aggiornaListaPagine();
    markDirty();
    showToast("Pagina aggiunta");
  });

  document.getElementById("duplica-pagina").addEventListener("click", () => {
    if (!pagine.length) return;

    const originale = pagine[paginaCorrente];
    const clone = originale.cloneNode(true);

    const header = clone.querySelector(".page-header");
    const footer = clone.querySelector(".page-footer");
    attachImageUpload(header);
    attachImageUpload(footer);

    const cols = parseInt(originale.dataset.cols || "3", 10);
    clone.dataset.cols = String(cols);
    clone.dataset.headerZoom = originale.dataset.headerZoom || "1";

    setFixedGrid(clone, cols, 3);
    applyHeaderZoom(clone);

    const grid = clone.querySelector(".page-grid");
    Sortable.create(grid, { animation: 150, ghostClass: "sortable-ghost", onEnd: () => markDirty() });

    clone.querySelectorAll(".cella-prodotto").forEach(c => {
      initCellaEvents(c);
      // re-apply render
      applyCellSize(c);
      applyPriceStyle(c);
      applyLayout(c);
      applyTextAlign(c);
      applyTypography(c);
      applyBoxStyle(c);
      applyImageFilter(c);
      applyImageTransform(c);
    });

    pagine.push(clone);
    paginaCorrente = pagine.length - 1;
    mostraPaginaCorrente();
    aggiornaListaPagine();
    markDirty();
    showToast("Pagina duplicata");
  });

  /* ----------------------
   DUPLICA / ELIMINA CELLA
  -----------------------*/
  document.getElementById("duplica-cella").addEventListener("click", () => {
    if (!cellaSelezionata) return showToast("Seleziona una cella");

    const clone = cellaSelezionata.cloneNode(true);
    initCellaEvents(clone);

    // re-apply
    applyCellSize(clone);
    applyPriceStyle(clone);
    applyLayout(clone);
    applyTextAlign(clone);
    applyTypography(clone);
    applyBoxStyle(clone);
    applyImageFilter(clone);
    applyImageTransform(clone);

    cellaSelezionata.parentElement.appendChild(clone);
    markDirty();
    showToast("Cella duplicata");
  });

  document.getElementById("elimina-cella").addEventListener("click", () => {
    if (!selectedCells.size) return showToast("Seleziona una o pi√π celle");
    selectedCells.forEach(c => c.remove());
    clearSelection();
    markDirty();
    showToast("Celle eliminate");
  });

  /* ----------------------
      APRI EDITOR CELLA
  -----------------------*/
  function apriEditorCella(cell) {
    cellaSelezionata = cell;

    const img = cell.querySelector(".img-box img")?.src || "";
    const titolo = cell.querySelector(".titolo")?.innerText || "";
    const descrizione = cell.querySelector(".descrizione")?.innerText || "";
    const prezzo = cell.querySelector(".prezzo")?.innerText || "";

    modalZoomValue = parseFloat(cell.dataset.imageZoom || "1");
    modalPosX = parseInt(cell.dataset.imagePosX || "50", 10);
    modalPosY = parseInt(cell.dataset.imagePosY || "50", 10);

    modalImageZoom.value = modalZoomValue;
    modalImagePosX.value = modalPosX;
    modalImagePosY.value = modalPosY;

    setModalImage(img);

    modalTitle.value = titolo;
    modalDesc.value = descrizione;
    modalPrice.value = prezzo;

    modalPriceStyle.value = cell.dataset.priceStyle;
    modalLayout.value = cell.dataset.layout;
    modalAlign.value = cell.dataset.textAlign;

    modalFontFamily.value = cell.dataset.fontFamily;
    modalFontColor.value = cell.dataset.fontColor;
    modalTitleSize.value = cell.dataset.titleSize;
    modalDescSize.value = cell.dataset.descSize;
    modalPriceSize.value = cell.dataset.priceSize;
    modalTextUpper.checked = cell.dataset.textUpper === "1";
    modalTitleBold.checked = cell.dataset.titleBold === "1";
    modalDescItalic.checked = cell.dataset.descItalic === "1";
    modalPriceBold.checked = cell.dataset.priceBold !== "0";

    modalBorderStyle.value = cell.dataset.borderStyle;
    modalBorderColor.value = cell.dataset.borderColor;
    modalRadius.value = cell.dataset.radius;
    modalBgColor.value = cell.dataset.bgColor;
    modalShadow.checked = cell.dataset.shadow === "1";

    modalImageFilter.value = cell.dataset.imageFilter;
    modalProductLibrary.value = "";

    cellEditorModal.show();
  }

  /* ----------------------
       SALVA MODIFICHE CELLA
  -----------------------*/
  modalSave.addEventListener("click", () => {
    if (!cellaSelezionata) return;

    const imgBox = cellaSelezionata.querySelector(".img-box");
    const titoloEl = cellaSelezionata.querySelector(".titolo");
    const descEl = cellaSelezionata.querySelector(".descrizione");
    const prezzoEl = cellaSelezionata.querySelector(".prezzo");

    if (modalImageData) {
      // ‚úÖ immagine sempre adattata alla box (cover via CSS)
      imgBox.innerHTML = `<img src="${modalImageData}">`;
    }

    cellaSelezionata.dataset.imageZoom = String(modalZoomValue);
    cellaSelezionata.dataset.imagePosX = String(modalPosX);
    cellaSelezionata.dataset.imagePosY = String(modalPosY);

    titoloEl.innerText = modalTitle.value;
    descEl.innerText = modalDesc.value;
    prezzoEl.innerText = modalPrice.value;

    cellaSelezionata.dataset.priceStyle = modalPriceStyle.value;
    cellaSelezionata.dataset.layout = modalLayout.value;
    cellaSelezionata.dataset.textAlign = modalAlign.value;

    cellaSelezionata.dataset.fontFamily = modalFontFamily.value;
    cellaSelezionata.dataset.fontColor = modalFontColor.value;
    cellaSelezionata.dataset.titleSize = modalTitleSize.value;
    cellaSelezionata.dataset.descSize = modalDescSize.value;
    cellaSelezionata.dataset.priceSize = modalPriceSize.value;

    cellaSelezionata.dataset.textUpper = modalTextUpper.checked ? "1" : "0";
    cellaSelezionata.dataset.titleBold = modalTitleBold.checked ? "1" : "0";
    cellaSelezionata.dataset.descItalic = modalDescItalic.checked ? "1" : "0";
    cellaSelezionata.dataset.priceBold = modalPriceBold.checked ? "1" : "0";

    cellaSelezionata.dataset.borderStyle = modalBorderStyle.value;
    cellaSelezionata.dataset.borderColor = modalBorderColor.value;
    cellaSelezionata.dataset.radius = modalRadius.value;
    cellaSelezionata.dataset.bgColor = modalBgColor.value;
    cellaSelezionata.dataset.shadow = modalShadow.checked ? "1" : "0";

    cellaSelezionata.dataset.imageFilter = modalImageFilter.value;

    applyLayout(cellaSelezionata);
    applyPriceStyle(cellaSelezionata);
    applyTextAlign(cellaSelezionata);
    applyTypography(cellaSelezionata);
    applyBoxStyle(cellaSelezionata);
    applyImageFilter(cellaSelezionata);
    applyImageTransform(cellaSelezionata);

    markDirty();
    cellEditorModal.hide();
    showToast("Box salvata");
  });

  /* ----------------------
       SALVATAGGIO VOLANTINO
  -----------------------*/
  let volantinoID = "{{ volantino_id or '' }}";

  document.getElementById("save-layout").addEventListener("click", () => {

    const data = pagine.map(page => {
      const grid = page.querySelector(".page-grid");
      const header = page.querySelector(".page-header");
      const footer = page.querySelector(".page-footer");

      const headerImg = header.querySelector("img")?.src || "";
      const footerImg = footer.querySelector("img")?.src || "";
      const cols = parseInt(page.dataset.cols || "3", 10);
      const headerZoom = page.dataset.headerZoom || "1";

      const cells = [];
      grid.querySelectorAll(".cella-prodotto").forEach(c => {
        cells.push({
          img: c.querySelector(".img-box img")?.src || "",
          titolo: c.querySelector(".titolo")?.innerText || "",
          descrizione: c.querySelector(".descrizione")?.innerText || "",
          prezzo: c.querySelector(".prezzo")?.innerText || "",
          priceStyle: c.dataset.priceStyle,
          layout: c.dataset.layout,
          textAlign: c.dataset.textAlign,
          fontFamily: c.dataset.fontFamily,
          fontColor: c.dataset.fontColor,
          titleSize: c.dataset.titleSize,
          descSize: c.dataset.descSize,
          priceSize: c.dataset.priceSize,
          textUpper: c.dataset.textUpper,
          titleBold: c.dataset.titleBold,
          descItalic: c.dataset.descItalic,
          priceBold: c.dataset.priceBold,
          borderStyle: c.dataset.borderStyle,
          borderColor: c.dataset.borderColor,
          radius: c.dataset.radius,
          bgColor: c.dataset.bgColor,
          shadow: c.dataset.shadow,
          imageFilter: c.dataset.imageFilter,
          imageZoom: c.dataset.imageZoom,
          imagePosX: c.dataset.imagePosX,
          imagePosY: c.dataset.imagePosY,
          oldPrice: c.dataset.oldPrice || ""
        });
      });

      return { cols, headerImg, headerZoom, footerImg, cells };
    });

    fetch("/salva-volantino-beta", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: volantinoID || null,
        nome: inputNome.value || "Volantino BETA",
        layout: data
      })
    })
    .then(r => r.json())
    .then(d => {
      showToast("Volantino salvato!");
      dirty = false;
      if (d.id) volantinoID = d.id;
    })
    .catch(err => {
      console.error("Errore salvataggio:", err);
      showToast("Errore salvataggio (console)");
    });

  });

  /* ----------------------
     RICOSTRUZIONE VOLANTINO
  -----------------------*/
  {% if layout_json %}
    const salvato = {{ layout_json | safe }};
    if (Array.isArray(salvato)) {
      salvato.forEach(pData => {
        const page = creaPagina(pData.cols || 3);
        const grid = page.querySelector(".page-grid");

        page.dataset.headerZoom = pData.headerZoom || "1";

        if (pData.headerImg) {
          page.querySelector(".page-header").innerHTML =
            `<img src="${pData.headerImg}" style="width:100%; height:100%; object-fit:cover;">`;
          applyHeaderZoom(page);
        }

        if (pData.footerImg) {
          page.querySelector(".page-footer").innerHTML =
            `<img src="${pData.footerImg}" style="width:100%; height:100%; object-fit:cover;">`;
        }

        setFixedGrid(page, parseInt(pData.cols || "3", 10), 3);

        (pData.cells || []).forEach(item => {
          const cell = creaCella();

          if (item.img) {
            cell.querySelector(".img-box").innerHTML = `<img src="${item.img}">`;
          }

          cell.querySelector(".titolo").innerText = item.titolo || "";
          cell.querySelector(".descrizione").innerText = item.descrizione || "";
          cell.querySelector(".prezzo").innerText = item.prezzo || "";

          Object.assign(cell.dataset, {
            priceStyle: item.priceStyle || "base",
            layout: item.layout || "image-top",
            textAlign: item.textAlign || "start",
            fontFamily: item.fontFamily || "",
            fontColor: item.fontColor || "#000000",
            titleSize: item.titleSize || "14",
            descSize: item.descSize || "11",
            priceSize: item.priceSize || "16",
            textUpper: item.textUpper || "0",
            titleBold: item.titleBold || "1",
            descItalic: item.descItalic || "0",
            priceBold: item.priceBold || "1",
            borderStyle: item.borderStyle || "solid",
            borderColor: item.borderColor || "#dddddd",
            radius: item.radius || "4",
            bgColor: item.bgColor || "#ffffff",
            shadow: item.shadow || "0",
            imageFilter: item.imageFilter || "none",
            imageZoom: item.imageZoom || "1",
            imagePosX: item.imagePosX || "50",
            imagePosY: item.imagePosY || "50",
            oldPrice: item.oldPrice || ""
          });

          applyCellSize(cell);
          applyPriceStyle(cell);
          applyLayout(cell);
          applyTextAlign(cell);
          applyTypography(cell);
          applyBoxStyle(cell);
          applyImageFilter(cell);
          applyImageTransform(cell);

          grid.appendChild(cell);
        });

        pagine.push(page);
      });
    }
  {% endif %}

  if (!pagine.length) pagine.push(creaPagina(3));

  mostraPaginaCorrente();
  aggiornaListaPagine();

  /* ----------------------
        EXPORT PDF
        - temporaneamente rimuove outline selezione
  -----------------------*/
  document.getElementById("export-pdf").addEventListener("click", async () => {
    const pdf = new jspdf.jsPDF("p", "px", [800, 1100]);
    const originalPage = paginaCorrente;

    const prevSelected = [...selectedCells];
    clearSelection();

    for (let i = 0; i < pagine.length; i++) {
      if (i > 0) pdf.addPage();

      paginaCorrente = i;
      mostraPaginaCorrente();

      const canvas = await html2canvas(pagine[i], { scale: 2, backgroundColor: "#ffffff" });
      pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 800, 1100);
    }

    paginaCorrente = originalPage;
    mostraPaginaCorrente();
    prevSelected.forEach(c => selectCell(c, true));

    pdf.save((inputNome.value || "volantino") + ".pdf");
  });

  /* ----------------------
        EXPORT PNG
  -----------------------*/
  document.getElementById("export-png").addEventListener("click", async () => {
    const prevSelected = [...selectedCells];
    clearSelection();

    const canvas = await html2canvas(pagine[paginaCorrente], { scale: 2, backgroundColor: "#ffffff" });
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = (inputNome.value || "volantino") + "_pag" + (paginaCorrente + 1) + ".png";
    a.click();

    prevSelected.forEach(c => selectCell(c, true));
  });

});
</script>

<style>
.pagina-volantino {
  width: 800px;
  height: 1100px;
  background: #ffffff;
  border: 1px solid #ddd;
  box-shadow: 0 0 10px rgba(0,0,0,0.15);
  display: grid;
  grid-template-rows: auto 1fr auto;
  padding: 10px;
  margin-bottom: 40px;
  position: relative;
}

.page-header,
.page-footer {
  height: 80px;
  border: 1px dashed #ccc;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  overflow: hidden;
}

.page-footer { margin-top: 8px; }

.page-header img{
  width:100%;
  height:100%;
  object-fit:cover;
  transform-origin:center center;
}

.page-grid { min-height: 0; }

/* Celle prodotto: tutte uguali e fisse */
.cella-prodotto {
  background: #fff;
  border: 1px solid #ddd;
  padding: 6px;
  cursor: pointer;
  transition: box-shadow 0.15s ease, transform 0.15s ease;
  position: relative;
  height: 100%;
}

.cella-prodotto:hover {
  box-shadow: 0 0 8px rgba(0,0,0,0.15);
  transform: translateY(-1px);
}

/* ‚úÖ Immagine sempre adattata alla box */
.cella-inner { height: 100%; display: flex; flex-direction: column; }
.img-box { flex: 1 1 auto; min-height: 0; overflow: hidden; }
.img-box img { width:100%; height:100%; object-fit:cover; display:block; }
.testo-box { flex: 0 0 auto; padding-top: 3px; }

/* Selezione */
.cella-selezionata {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

/* Ombra extra */
.cella-shadow { box-shadow: 0 4px 10px rgba(0,0,0,0.18); }

/* Prezzi */
.prezzo-base { background: transparent; padding: 2px 4px; border-radius: 4px; }
.prezzo-yellow { background: #ffeb3b; color: #000; padding: 2px 6px; border-radius: 4px; }
.prezzo-red { background: #f44336; color: #fff; padding: 2px 6px; border-radius: 4px; }
.prezzo-blue { background: #2196f3; color: #fff; padding: 2px 6px; border-radius: 4px; }
.prezzo-round { background: #ff9800; color: #fff; padding: 4px 10px; border-radius: 999px; }
.prezzo-angle { position: relative; padding: 4px 10px; background: #e91e63; color: #fff; }
.prezzo-angle::before {
  content: "";
  position: absolute;
  left: -10px;
  top: 0;
  border-top: 14px solid #e91e63;
  border-left: 10px solid transparent;
}

.prezzo-strike { display: inline-block; }
.prezzo-strike::before {
  content: attr(data-old);
  display: block;
  text-decoration: line-through;
  font-size: 0.7em;
  opacity: 0.8;
}

/* Layout */
.cella-layout-image-left .cella-inner { flex-direction: row; }
.cella-layout-image-left .img-box { width: 50%; margin-right: 4px; flex: 0 0 auto; }
.cella-layout-full-image-price .cella-inner { position: relative; }
.cella-layout-full-image-price .testo-box {
  position: absolute;
  bottom: 6px;
  left: 6px;
  right: 6px;
  text-shadow: 0 0 3px rgba(0,0,0,0.6);
  color: #fff;
}

.sortable-ghost { opacity: 0.4; }

#modal-image-preview img { display: block; }
</style>

{% endblock %}
