{% extends "01_base.html" %}

{% block title %}BETA Volantino - Gestionale Horeca{% endblock %}

{% block content %}

<h1 class="mb-4">üß™ BETA ‚Äì Editor Volantino Avanzato</h1>

<div class="row">

  <!-- ----------------------------------------------- -->
  <!-- SIDEBAR SINISTRA -->
  <!-- ----------------------------------------------- -->
  <div class="col-md-3">

    <!-- Nome volantino -->
    <div class="card mb-3">
      <div class="card-header fw-bold">Nome volantino</div>
      <div class="card-body">
        <input type="text" id="volantino-nome" class="form-control"
               placeholder="Nome volantino"
               value="{{ nome_volantino or '' }}">
      </div>
    </div>

    <!-- Pagine -->
    <div class="card mb-3">
      <div class="card-header fw-bold">Pagine</div>
      <div class="card-body">
        <div id="lista-pagine" class="mb-2"></div>
        <button class="btn btn-primary btn-sm w-100 mb-2" id="aggiungi-pagina">‚ûï Aggiungi pagina</button>
        <button class="btn btn-outline-primary btn-sm w-100" id="duplica-pagina">üìÑ Duplica pagina</button>
      </div>
    </div>

    <!-- Layout griglia -->
    <div class="card mb-3">
      <div class="card-header fw-bold">Layout griglia</div>
      <div class="card-body">
        <button class="btn btn-primary w-100 mb-2" data-grid="2x3">Griglia 2√ó3</button>
        <button class="btn btn-primary w-100 mb-2" data-grid="3x3">Griglia 3√ó3</button>
        <button class="btn btn-primary w-100 mb-2" data-grid="4x3">Griglia 4√ó3</button>
      </div>
    </div>

    <!-- Formato cella -->
    <div class="card mb-3">
      <div class="card-header fw-bold">Formato cella</div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary btn-sm" data-cell-size="1x1">1√ó1</button>
          <button class="btn btn-outline-secondary btn-sm" data-cell-size="2x1">2√ó1</button>
          <button class="btn btn-outline-secondary btn-sm" data-cell-size="1x2">1√ó2</button>
          <button class="btn btn-outline-secondary btn-sm" data-cell-size="2x2">2√ó2</button>
        </div>
      </div>
    </div>

    <!-- Stile prezzo -->
    <div class="card mb-3">
      <div class="card-header fw-bold">Stile prezzo</div>
      <div class="card-body d-grid gap-2">
        <button class="btn btn-warning btn-sm" data-price-style="yellow">Cartellino giallo</button>
        <button class="btn btn-danger btn-sm" data-price-style="red">Cartellino rosso</button>
        <button class="btn btn-info btn-sm" data-price-style="blue">Cartellino blu</button>
        <button class="btn btn-outline-secondary btn-sm" data-price-style="base">Semplice</button>
      </div>
    </div>

    <!-- Azioni -->
    <div class="card">
      <div class="card-header fw-bold">Azioni</div>
      <div class="card-body d-grid gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="duplica-cella">üìÑ Duplica cella</button>
        <button class="btn btn-outline-danger btn-sm" id="elimina-cella">üóëÔ∏è Elimina cella</button>
        <hr>
        <button class="btn btn-outline-primary w-100" id="save-layout">üíæ Salva Volantino</button>
        <button class="btn btn-outline-dark w-100" id="export-pdf">üìÑ Esporta PDF</button>
      </div>
    </div>

  </div>

  <!-- ----------------------------------------------- -->
  <!-- AREA VOLANTINO -->
  <!-- ----------------------------------------------- -->
  <div class="col-md-9">
    <div id="pagine-container" style="width:800px; margin:auto;">
      <!-- Le pagine saranno inserite qui -->
    </div>
  </div>

</div>


<!-- ====================================================================== -->
<!-- POPUP MODERNO PER MODIFICA CELLA (stile Canva / InPublish) -->
<!-- ====================================================================== -->
<div id="popup-editor" class="popup-overlay d-none">
  <div class="popup-window">
    <h5 class="fw-bold mb-3">Modifica Box Prodotto</h5>

    <!-- Immagine -->
    <label class="fw-bold">Immagine</label>
    <div id="popup-img-box"
         class="popup-img mb-3">
      <span class="text-muted">Clicca per caricare</span>
    </div>

    <label class="fw-bold mt-2">Titolo</label>
    <input type="text" id="popup-titolo" class="form-control mb-2">

    <label class="fw-bold">Descrizione</label>
    <textarea id="popup-descrizione" class="form-control mb-2"></textarea>

    <label class="fw-bold">Prezzo</label>
    <input type="text" id="popup-prezzo" class="form-control mb-3">

    <div class="text-end">
      <button class="btn btn-secondary" id="popup-annulla">Annulla</button>
      <button class="btn btn-primary" id="popup-salva">Salva</button>
    </div>
  </div>
</div>

{% endblock %}




{% block scripts %}
{{ super() }}

<!-- Sortable drag&drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<!-- html2canvas e jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ======================================================================
   LOGICA COMPLETA DEL NUOVO EDITOR VOLANTINO
   MODERNO, INTUITIVO, CON POPUP EDITOR
====================================================================== */

document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------------------------------------------
     VARIABILI GLOBALI
  ------------------------------------------------------------- */
  let pagine = [];
  let paginaCorrente = 0;
  let cellaSelezionata = null;

  const pagineContainer = document.getElementById("pagine-container");
  const listaPagine = document.getElementById("lista-pagine");

  /* -------------------------------------------------------------
     FUNZIONE UPLOAD IMMAGINI (riutilizzabile)
  ------------------------------------------------------------- */
  function uploadImage(callback) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => callback(reader.result);
      reader.readAsDataURL(file);
    };
    input.click();
  }

  /* -------------------------------------------------------------
     POPUP EDITOR
  ------------------------------------------------------------- */
  const popup = document.getElementById("popup-editor");
  const popupImgBox = document.getElementById("popup-img-box");
  const popupTitolo = document.getElementById("popup-titolo");
  const popupDescrizione = document.getElementById("popup-descrizione");
  const popupPrezzo = document.getElementById("popup-prezzo");
  const popupAnnulla = document.getElementById("popup-annulla");
  const popupSalva = document.getElementById("popup-salva");

  function apriPopup(cella) {
    cellaSelezionata = cella;

    popupTitolo.value = cella.querySelector(".titolo")?.innerText || "";
    popupDescrizione.value = cella.querySelector(".descrizione")?.innerText || "";
    popupPrezzo.value = cella.querySelector(".prezzo")?.innerText || "";

    const img = cella.querySelector(".img-box img")?.src;
    popupImgBox.innerHTML = img
      ? `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">`
      : `<span class="text-muted small">Clicca per caricare</span>`;

    popup.classList.remove("d-none");
  }

  popupImgBox.addEventListener("click", () => {
    uploadImage(src => {
      popupImgBox.innerHTML =
        `<img src="${src}" style="width:100%; height:100%; object-fit:cover;">`;
    });
  });

  popupAnnulla.onclick = () => popup.classList.add("d-none");

  popupSalva.onclick = () => {
    if (!cellaSelezionata) return;

    // Salva contenuti nella cella
    cellaSelezionata.querySelector(".titolo").innerText = popupTitolo.value;
    cellaSelezionata.querySelector(".descrizione").innerText = popupDescrizione.value;
    cellaSelezionata.querySelector(".prezzo").innerText = popupPrezzo.value;

    const img = popupImgBox.querySelector("img")?.src;
    if (img) {
      cellaSelezionata.querySelector(".img-box").innerHTML =
        `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">`;
    }

    popup.classList.add("d-none");
  };


  /* -------------------------------------------------------------
     CELLA PRODOTTO
  ------------------------------------------------------------- */
  function creaCella() {
    const cell = document.createElement("div");
    cell.classList.add("cella-prodotto");

    cell.innerHTML = `
      <div class="img-box cell-img">
        <span class="text-muted small">Clicca per aggiungere</span>
      </div>
      <div class="titolo fw-bold">Titolo prodotto</div>
      <div class="descrizione small text-muted">Descrizione prodotto</div>
      <div class="prezzo text-success fw-bold prezzo-base">‚Ç¨ 0,00</div>
    `;

    cell.onclick = e => {
      e.stopPropagation();
      apriPopup(cell);
    };

    return cell;
  }

  /* -------------------------------------------------------------
     CREAZIONE PAGINA
  ------------------------------------------------------------- */
  function creaPagina(cols = 3) {
    const page = document.createElement("div");
    page.classList.add("pagina-volantino");
    page.dataset.cols = cols;

    page.innerHTML = `
      <div class="page-grid"
           style="display:grid; grid-template-columns:repeat(${cols},1fr); gap:10px;"></div>
    `;

    Sortable.create(page.querySelector(".page-grid"), {
      animation: 150,
      ghostClass: "sortable-ghost"
    });

    return page;
  }

  function mostraPagina() {
    pagineContainer.innerHTML = "";
    pagineContainer.appendChild(pagine[paginaCorrente]);
  }

  function aggiornaListaPagine() {
    listaPagine.innerHTML = "";
    pagine.forEach((_, i) => {
      const btn = document.createElement("button");
      btn.classList.add("btn", "btn-sm", "w-100", "mb-2", i === paginaCorrente ? "btn-primary" : "btn-outline-primary");
      btn.innerText = `Pagina ${i + 1}`;
      btn.onclick = () => {
        paginaCorrente = i;
        mostraPagina();
        aggiornaListaPagine();
      };
      listaPagine.appendChild(btn);
    });
  }

  /* -------------------------------------------------------------
     BOTTONI: AGGIUNGI PAGINA
  ------------------------------------------------------------- */
  document.getElementById("aggiungi-pagina").onclick = () => {
    pagine.push(creaPagina(3));
    paginaCorrente = pagine.length - 1;
    mostraPagina();
    aggiornaListaPagine();
  };

  document.getElementById("duplica-pagina").onclick = () => {
    const clone = pagine[paginaCorrente].cloneNode(true);
    pagine.push(clone);
    paginaCorrente = pagine.length - 1;
    mostraPagina();
    aggiornaListaPagine();
  };

  /* -------------------------------------------------------------
     GRIGLIE
  ------------------------------------------------------------- */
  document.querySelectorAll("[data-grid]").forEach(btn => {
    btn.onclick = () => {
      const [cols, rows] = btn.dataset.grid.split("x").map(Number);
      const page = pagine[paginaCorrente];
      const grid = page.querySelector(".page-grid");
      page.dataset.cols = cols;

      grid.innerHTML = "";
      grid.style.gridTemplateColumns = `repeat(${cols},1fr)`;

      for (let i = 0; i < cols * rows; i++) grid.appendChild(creaCella());
    };
  });

  /* -------------------------------------------------------------
     FORMATO CELLA
  ------------------------------------------------------------- */
  document.querySelectorAll("[data-cell-size]").forEach(btn => {
    btn.onclick = () => {
      if (!cellaSelezionata) return alert("Seleziona una cella!");
      const [c, r] = btn.dataset.cellSize.split("x");
      cellaSelezionata.style.gridColumn = `span ${c}`;
      cellaSelezionata.style.gridRow = `span ${r}`;
    };
  });

  /* -------------------------------------------------------------
     STILE PREZZO
  ------------------------------------------------------------- */
  document.querySelectorAll("[data-price-style]").forEach(btn => {
    btn.onclick = () => {
      if (!cellaSelezionata) return alert("Seleziona una cella!");
      const style = btn.dataset.priceStyle;

      const p = cellaSelezionata.querySelector(".prezzo");
      p.className = "prezzo fw-bold prezzo-" + style;
    };
  });


  /* -------------------------------------------------------------
     SALVATAGGIO LAYOUT
  ------------------------------------------------------------- */
  document.getElementById("save-layout").onclick = () => {
    const data = pagine.map(page => {
      const grid = page.querySelector(".page-grid");
      const cols = parseInt(page.dataset.cols || "3");

      const cells = [];
      grid.querySelectorAll(".cella-prodotto").forEach(c => {
        cells.push({
          img: c.querySelector(".img-box img")?.src || "",
          titolo: c.querySelector(".titolo").innerText,
          descrizione: c.querySelector(".descrizione").innerText,
          prezzo: c.querySelector(".prezzo").innerText,
          colSpan: c.style.gridColumn.replace("span", "").trim() || "1",
          rowSpan: c.style.gridRow.replace("span", "").trim() || "1",
          priceStyle: [...c.querySelector(".prezzo").classList].find(k => k.includes("prezzo-")) || "prezzo-base"
        });
      });

      return { cols, cells };
    });

    fetch("/salva-volantino-beta", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id: {{ volantino_id or "null" }},
        nome: document.getElementById("volantino-nome").value || "Volantino BETA",
        layout: data
      })
    })
    .then(r => r.json())
    .then(() => alert("Volantino salvato!"));
  };


  /* -------------------------------------------------------------
     CARICA LAYOUT SALVATO
  ------------------------------------------------------------- */
  {% if layout_json %}
  const salvato = {{ layout_json | safe }};
  salvato.forEach(pData => {
    const page = creaPagina(pData.cols || 3);
    const grid = page.querySelector(".page-grid");

    (pData.cells || []).forEach(c => {
      const cell = creaCella();
      if (c.img) cell.querySelector(".img-box").innerHTML =
        `<img src="${c.img}" style="width:100%; height:100%; object-fit:cover;">`;

      cell.querySelector(".titolo").innerText = c.titolo;
      cell.querySelector(".descrizione").innerText = c.descrizione;
      cell.querySelector(".prezzo").innerText = c.prezzo;

      cell.style.gridColumn = `span ${c.colSpan}`;
      cell.style.gridRow = `span ${c.rowSpan}`;
      cell.querySelector(".prezzo").className = "prezzo fw-bold " + c.priceStyle;

      grid.appendChild(cell);
    });

    pagine.push(page);
  });
  {% endif %}

  if (pagine.length === 0) pagine.push(creaPagina(3));

  mostraPagina();
  aggiornaListaPagine();

  /* -------------------------------------------------------------
     ESPORTA PDF MULTIPAGINA
  ------------------------------------------------------------- */
  document.getElementById("export-pdf").onclick = async () => {
    const pdf = new jspdf.jsPDF("p", "px", [800, 1100]);

    for (let i = 0; i < pagine.length; i++) {
      if (i > 0) pdf.addPage();
      pagineContainer.innerHTML = "";
      pagineContainer.appendChild(pagine[i]);
      const canvas = await html2canvas(pagine[i], { scale: 2 });
      pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 800, 1100);
    }

    // ripristina pagina attuale
    mostraPagina();

    pdf.save((document.getElementById("volantino-nome").value || "volantino") + ".pdf");
  };
});
</script>


<!-- ====================================================================== -->
<!-- STILI -->
<!-- ====================================================================== -->
<style>
.pagina-volantino {
  width: 800px;
  height: 1100px;
  background: #fff;
  border: 1px solid #ddd;
  padding: 10px;
  margin-bottom: 40px;
  box-shadow: 0 0 10px rgba(0,0,0,0.15);
}

/* ---------------------------------------------------------------------------------------------------------------- */
/* CELLE */
/* ---------------------------------------------------------------------------------------------------------------- */
.cella-prodotto {
  background: #ffffff;
  border: 1px solid #ddd;
  padding: 6px;
  cursor: pointer;
  transition: 0.15s;
}

.cella-prodotto:hover {
  transform: scale(1.01);
}

.cell-img {
  width: 100%;
  height: 150px;
  border: 1px dashed #bbb;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
}

/* PRICE STYLES */
.prezzo-base { background:none; color:green; }
.prezzo-yellow { background:#ffeb3b; color:#000; padding:3px 6px; border-radius:4px; }
.prezzo-red { background:#f44336; color:#fff; padding:3px 6px; border-radius:4px; }
.prezzo-blue { background:#2196f3; color:#fff; padding:3px 6px; border-radius:4px; }

/* POPUP */
.popup-overlay {
  position:fixed;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.popup-window {
  width:420px;
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 20px rgba(0,0,0,0.3);
  animation:popup 0.2s ease-out;
}

@keyframes popup {
  from { transform:scale(0.8); opacity:0; }
  to { transform:scale(1); opacity:1; }
}

.popup-img {
  width:100%;
  height:150px;
  border:1px dashed #bbb;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow:hidden;
  cursor:pointer;
}
</style>

{% endblock %}
