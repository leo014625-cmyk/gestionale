{% extends "01_base.html" %}

{% block title %}Modifica Cliente - Gestionale Horeca{% endblock %}

{% block content %}

{% set mesi = {
1: 'Gennaio', 2: 'Febbraio', 3: 'Marzo', 4: 'Aprile',
5: 'Maggio', 6: 'Giugno', 7: 'Luglio', 8: 'Agosto',
9: 'Settembre', 10: 'Ottobre', 11: 'Novembre', 12: 'Dicembre'
} %}

<h1 class="mb-4">Modifica Cliente</h1>

<form method="POST" novalidate>
<!-- Nome cliente -->
<div class="mb-3">
<label for="nome" class="form-label">Nome cliente</label>
<input type="text" class="form-control" id="nome" name="nome" value="{{ cliente.nome }}" required autofocus>
</div>

<!-- Zona -->
<div class="mb-3">
    <label for="zona" class="form-label">Zona</label>
    <select class="form-select" id="zona" name="zona" required>
        {% for z in zone %}
            <option value="{{ z.nome }}" {% if z.nome == cliente.zona %}selected{% endif %}>{{ z.nome }}</option>
        {% endfor %}
        <option disabled>──────────</option>
        <option value="nuova_zona" {% if nuova_zona_selected %}selected{% endif %}>+ Aggiungi nuova zona</option>
    </select>
    <div class="form-text">Seleziona una zona esistente o aggiungine una nuova.</div>
</div>

<!-- Nuova zona -->
<div class="mb-3 {% if not nuova_zona_selected %}d-none{% endif %}" id="nuova-zona-wrapper">
    <label for="nuova_zona" class="form-label">Nuova Zona</label>
    <input type="text" class="form-control" id="nuova_zona" name="nuova_zona" placeholder="Inserisci nuova zona" value="{{ nuova_zona_value or '' }}">
</div>

<!-- Fatturato -->
<fieldset class="mb-4">
    <legend>Fatturato Mensile</legend>
    <div class="row g-3 align-items-center mb-3">
        <div class="col-auto">
            <label for="mese" class="col-form-label">Mese</label>
        </div>
        <div class="col-auto">
            <select id="mese" name="mese" class="form-select" required>
                {% for k, v in mesi.items() %}
                    <option value="{{ k }}" {% if k == (fatturato_mese or current_month) %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="anno" class="col-form-label">Anno</label>
        </div>
        <div class="col-auto">
            <input type="number" id="anno" name="anno" class="form-control" value="{{ fatturato_anno or current_year }}" min="2000" max="2100" required>
        </div>
    </div>

    <div class="mb-3">
        <label for="fatturato_mensile" class="form-label">Importo (€)</label>
        <input type="number" step="0.01" min="0" class="form-control" id="fatturato_mensile" name="fatturato_mensile" placeholder="Inserisci fatturato mensile" value="{{ fatturato_importo or '' }}">
        <div class="form-text">Lascia vuoto se non vuoi aggiungere un fatturato.</div>
    </div>

    <button type="button" class="btn btn-outline-secondary mt-2" data-bs-toggle="modal" data-bs-target="#modalFatturato">
        Visualizza e modifica fatturati
    </button>
</fieldset>

<!-- Prodotti con card moderne -->
<div class="mb-4">
    <h4 class="mb-3">Prodotti</h4>

    {% if categorie %}
        <ul class="nav nav-tabs mb-3" id="prodottiTabs" role="tablist">
            {% for categoria in categorie %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ categoria.id }}" data-bs-toggle="tab" data-bs-target="#cat-{{ categoria.id }}" type="button" role="tab">
                        {{ categoria.nome }}
                        {% if categoria.id|string in categorie_lavorate %}
                            <i class="bi bi-check-circle-fill text-success ms-1"></i>
                        {% endif %}
                    </button>
                </li>
            {% endfor %}
        </ul>

        <div class="tab-content">
            {% for categoria in categorie %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="cat-{{ categoria.id }}" role="tabpanel">
                    {% set prodotti_cat = prodotti|selectattr("categoria_id", "equalto", categoria.id)|list %}
                    {% if prodotti_cat %}
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                            {% for prodotto in prodotti_cat %}
                                <div class="col">
                                    <div class="card h-100 shadow-sm prodotto-card {% if prodotto.id|string in prodotti_lavorati %}bg-success bg-opacity-10{% else %}bg-white{% endif %}">
                                        <div class="card-body d-flex flex-column">
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="prodotto{{ prodotto.id }}" name="prodotti_lavorati[]" value="{{ prodotto.id }}" {% if prodotto.id|string in prodotti_lavorati %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="prodotto{{ prodotto.id }}">
                                                    {{ prodotto.nome }}
                                                </label>
                                                <span class="badge bg-secondary ms-1">{{ prodotto.categoria_nome }}</span>
                                            </div>
                                            <div class="mt-auto prezzi-wrapper {% if prodotto.id|string in prodotti_lavorati %}d-none{% endif %}" id="prezzi-{{ prodotto.id }}">
                                                <div class="mb-2">
                                                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="prezzo_attuale[{{ prodotto.id }}]" placeholder="Prezzo attuale €" value="{{ prezzi_attuali.get(prodotto.id|string, '') }}">
                                                </div>
                                                <div>
                                                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" name="prezzo_offerta[{{ prodotto.id }}]" placeholder="Prezzo offerta €" value="{{ prezzi_offerta.get(prodotto.id|string, '') }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Nessun prodotto in questa categoria.</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">Nessuna categoria disponibile.</p>
    {% endif %}
</div>

<!-- Tabelle Prodotti -->
<hr>
<div class="row">
    <div class="col-md-6">
        <h5>Prodotti Lavorati</h5>
        <table class="table table-bordered table-striped mb-4" id="tabella-lavorati">
            <thead class="table-success">
                <tr><th>Prodotto</th><th>Categoria</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="col-md-6">
        <h5>Prodotti Non Lavorati</h5>
        <table class="table table-bordered table-striped" id="tabella-non-lavorati">
            <thead class="table-danger">
                <tr><th>Prodotto</th><th>Categoria</th><th>Prezzo Attuale</th><th>Prezzo Offerta</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Pulsanti -->
<button type="submit" class="btn btn-primary">Salva modifiche</button>
<a href="{{ url_for('clienti') }}" class="btn btn-secondary ms-2">Annulla</a>


</form>

<!-- Modal Fatturato -->

<div class="modal fade" id="modalFatturato" tabindex="-1" aria-labelledby="modalFatturatoLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalFatturatoLabel">Fatturati Mensili</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
</div>
<div class="modal-body">
<table class="table table-striped align-middle">
<thead>
<tr><th>Mese</th><th>Anno</th><th>Importo (€)</th><th>Azione</th></tr>
</thead>
<tbody>
{% for f in fatturati_cliente %}
<tr data-id="{{ f.id }}">
<td>{{ mesi[f.mese] }}</td>
<td>{{ f.anno }}</td>
<td>
<input type="number" step="0.01" min="0" class="form-control form-control-sm" value="{{ f.totale | default('0.00', True) }}" data-fatt-id="{{ f.id }}">
</td>
<td>
<button type="button" class="btn btn-danger btn-sm delete-fatturato" data-fatt-id="{{ f.id }}">
<i class="bi bi-trash"></i>
</button>
</td>
</tr>
{% else %}
<tr><td colspan="4" class="text-muted">Nessun fatturato inserito</td></tr>
{% endfor %}
</tbody>
</table>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-primary" id="salvaFatturatiModal">Salva modifiche</button>
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
</div>
</div>
</div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script>
document.addEventListener('DOMContentLoaded', function () {
// --- Nuova zona ---
const zonaSelect = document.getElementById('zona');
const nuovaZonaWrapper = document.getElementById('nuova-zona-wrapper');
const nuovaZonaInput = document.getElementById('nuova_zona');

zonaSelect.addEventListener(&#39;change&#39;, function () {
    const isNew = zonaSelect.value === &#39;nuova_zona&#39;;
    nuovaZonaWrapper.classList.toggle(&#39;d-none&#39;, !isNew);
    nuovaZonaInput.required = isNew;
    if (isNew) nuovaZonaInput.focus();
});

// --- Prodotti ---
const prodotti = [
    {% for prodotto in prodotti %}
        { id: &#39;{{ prodotto.id }}&#39;, nome: &#39;{{ prodotto.nome }}&#39;, categoria: &#39;{{ prodotto.categoria_nome }}&#39; },
    {% endfor %}
];

const lavoratiTbody = document.querySelector(&#39;#tabella-lavorati tbody&#39;);
const nonLavoratiTbody = document.querySelector(&#39;#tabella-non-lavorati tbody&#39;);

function aggiornaTabelle() {
    lavoratiTbody.innerHTML = &#39;&#39;;
    nonLavoratiTbody.innerHTML = &#39;&#39;;

    prodotti.forEach(p =&gt; {
        const checkbox = document.querySelector(`input[name=&quot;prodotti_lavorati[]&quot;][value=&quot;${p.id}&quot;]`);
        if (checkbox &amp;&amp; checkbox.checked) {
            lavoratiTbody.insertAdjacentHTML(&#39;beforeend&#39;, `&lt;tr&gt;&lt;td&gt;${p.nome}&lt;/td&gt;&lt;td&gt;${p.categoria}&lt;/td&gt;&lt;/tr&gt;`);
        } else {
            const attuale = document.querySelector(`input[name=&quot;prezzo_attuale[${p.id}]&quot;]`)?.value || &#39;–&#39;;
            const offerta = document.querySelector(`input[name=&quot;prezzo_offerta[${p.id}]&quot;]`)?.value || &#39;–&#39;;
            nonLavoratiTbody.insertAdjacentHTML(&#39;beforeend&#39;, `&lt;tr&gt;&lt;td&gt;${p.nome}&lt;/td&gt;&lt;td&gt;${p.categoria}&lt;/td&gt;&lt;td&gt;${attuale}&lt;/td&gt;&lt;td&gt;${offerta}&lt;/td&gt;&lt;/tr&gt;`);
        }
    });
}

// Inizializza tabelle
aggiornaTabelle();

// Listener per prodotti
document.querySelectorAll(&#39;input[name=&quot;prodotti_lavorati[]&quot;]&#39;).forEach(chk =&gt; {
    chk.addEventListener(&#39;change&#39;, function () {
        const wrapper = document.getElementById(&#39;prezzi-&#39; + this.value);
        // Toggle the visibility of the price inputs
        if (wrapper) {
             wrapper.classList.toggle(&#39;d-none&#39;, this.checked);
        }
        aggiornaTabelle();
    });
});

// --- Gestione API Fatturati ---

// 1. Salvataggio fatturati dal modal via fetch
document.getElementById(&#39;salvaFatturatiModal&#39;).addEventListener(&#39;click&#39;, function() {
    const inputs = document.querySelectorAll(&#39;#modalFatturato tbody input[data-fatt-id]&#39;);
    const data = [];

    inputs.forEach(i =&gt; {
        // Conversione a float sicura
        const importo = i.value ? parseFloat(i.value) : 0;
        data.push({ id: i.dataset.fattId, importo: importo });
    });

    fetch(&quot;{{ url_for(&#39;aggiorna_fatturati&#39;) }}&quot;, {
        method: &quot;POST&quot;,
        headers: { &quot;Content-Type&quot;: &quot;application/json&quot; },
        body: JSON.stringify({ fatturati: data })
    })
    .then(res =&gt; res.json())
    .then(resp =&gt; {
        if (resp.success) {
            console.log(&quot;Fatturati aggiornati correttamente! Ricarico la pagina.&quot;);
            location.reload();
        } else {
            console.error(&quot;Errore nel salvataggio:&quot;, resp.message);
            alert(&quot;Errore nel salvataggio: &quot; + resp.message); // Usare alert come fallback per l&#39;errore
        }
    })
    .catch(err =&gt; {
        console.error(&quot;Errore di comunicazione con il server:&quot;, err);
        alert(&quot;Errore di comunicazione con il server.&quot;);
    });
});

// 2. Eliminazione fatturato
document.querySelectorAll(&#39;.delete-fatturato&#39;).forEach(btn =&gt; {
    btn.addEventListener(&#39;click&#39;, function(event) {
        const fatturatoId = event.currentTarget.dataset.fattId;
        
        // Requisito: Sostituire il confirm() con una custom modal UI. 
        // Per ora, useremo un alert con messaggio per simulare.
        if (!confirm(`Sei sicuro di voler eliminare il fatturato ID ${fatturatoId}?`)) {
            return;
        }

        fetch(&quot;{{ url_for(&#39;elimina_fatturato&#39;) }}&quot;, {
            method: &quot;POST&quot;,
            headers: { &quot;Content-Type&quot;: &quot;application/json&quot; },
            body: JSON.stringify({ fatturato_id: fatturatoId })
        })
        .then(res =&gt; res.json())
        .then(resp =&gt; {
            if (resp.success) {
                console.log(&quot;Fatturato eliminato con successo. Ricarico la pagina.&quot;);
                location.reload();
            } else {
                console.error(&quot;Errore nell&#39;eliminazione:&quot;, resp.message);
                alert(&quot;Errore nell&#39;eliminazione: &quot; + resp.message);
            }
        })
        .catch(err =&gt; {
            console.error(&quot;Errore di comunicazione con il server durante l&#39;eliminazione:&quot;, err);
            alert(&quot;Errore di comunicazione con il server durante l&#39;eliminazione.&quot;);
        });
    });
});


});
</script>

<style>
/* Card prodotti moderna */
.prodotto-card {
transition: transform 0.2s, box-shadow 0.2s;
}
.prodotto-card:hover {
transform: translateY(-3px);
box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
}
.card .form-check { cursor: pointer; }
.card .form-check-input { margin-top: 0.2rem; }
.card .badge { font-size: 0.75rem; }
.prezzi-wrapper input { width: 100%; }

/* Colore più chiaro per prodotti lavorati /
.prodotto-card.bg-success.bg-opacity-10 {
background-color: #d4edda !important; / verde chiaro */
}

/* Allinea elementi nel modal */
.modal-body .table.align-middle td, .modal-body .table.align-middle th {
vertical-align: middle;
}
</style>

{% endblock %}
