{% extends "01_base.html" %}

{% block title %}Clienti - Gestionale Horeca{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <h1 class="mb-0">Lista Clienti</h1>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <a href="{{ url_for('nuovo_cliente') }}" class="btn btn-success rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-person-plus"></i> Aggiungi Cliente
      </a>
      <a href="{{ url_for('index') }}" class="btn btn-outline-secondary rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-house-door"></i> Home
      </a>
    </div>
  </div>

  <!-- Messaggi flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show rounded-4" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {# ============================
     KPI / Badge conteggi stato
     ============================ #}
  {% set tot_clienti = stati_clienti|length %}
  {% set attivi = stati_clienti.values()|select('equalto', 'attivo')|list|length %}
  {% set bloccati = stati_clienti.values()|select('equalto', 'bloccato')|list|length %}
  {% set inattivi = stati_clienti.values()|select('equalto', 'inattivo')|list|length %}

  <div class="d-flex flex-wrap gap-2 mb-4">
    <span class="badge rounded-pill text-bg-primary px-3 py-2">
      Totali: {{ tot_clienti }}
    </span>
    <span class="badge rounded-pill text-bg-success px-3 py-2">
      Attivi: {{ attivi }}
    </span>
    <span class="badge rounded-pill text-bg-danger px-3 py-2">
      Bloccati: {{ bloccati }}
    </span>
    <span class="badge rounded-pill text-bg-secondary px-3 py-2">
      Inattivi: {{ inattivi }}
    </span>
  </div>

  <!-- Filtri -->
  <form method="get" class="mb-4 d-flex flex-wrap gap-3 align-items-end">

    <!-- Ricerca -->
    <div class="d-flex flex-column">
      <label class="form-label mb-1">Cerca cliente</label>
      <input type="text" name="search" class="form-control"
             placeholder="Inserisci nome cliente..." value="{{ request.args.get('search', '') }}">
    </div>

    <!-- Zona -->
    <div class="d-flex flex-column">
      <label class="form-label mb-1">Filtra per zona</label>
      <select name="zona" class="form-select" onchange="this.form.submit()">
        <option value="">Tutte le zone</option>
        {% for z in zone %}
          <option value="{{ z }}" {% if request.args.get('zona') == z %}selected{% endif %}>{{ z }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Stato cliente -->
    <div class="d-flex flex-column">
      <label class="form-label mb-1">Stato cliente</label>
      <select name="stato" class="form-select" onchange="this.form.submit()">
        <option value="">Tutti</option>
        <option value="attivo" {% if request.args.get('stato') == 'attivo' %}selected{% endif %}>Attivo</option>
        <option value="bloccato" {% if request.args.get('stato') == 'bloccato' %}selected{% endif %}>Bloccato</option>
        <option value="inattivo" {% if request.args.get('stato') == 'inattivo' %}selected{% endif %}>Inattivo</option>
      </select>
    </div>

    <!-- Ordine -->
    <div class="d-flex flex-column">
      <label class="form-label mb-1">Ordina per</label>
      <select name="order" class="form-select" onchange="this.form.submit()">
        <option value="zona" {% if request.args.get('order') == 'zona' or not request.args.get('order') %}selected{% endif %}>Zona</option>
        <option value="fatturato" {% if request.args.get('order') == 'fatturato' %}selected{% endif %}>Fatturato totale</option>
      </select>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary rounded-4">Applica</button>
      <a href="{{ url_for('clienti') }}" class="btn btn-outline-secondary rounded-4">Reset</a>
    </div>
  </form>

  <!-- =============================== -->
  <!-- LISTA CLIENTI PER ZONA -->
  <!-- =============================== -->
  {% if clienti_per_zona %}
    {% for zona, clienti in clienti_per_zona.items() %}

      {% set zona_label = zona if zona else 'Senza zona' %}

      {% if not request.args.get('zona') or request.args.get('zona') == zona %}
        <div class="d-flex align-items-center justify-content-between mt-5 mb-3">
          <h3 class="mb-0">{{ zona_label }}</h3>
          <span class="badge text-bg-light">{{ clienti|length }} clienti</span>
        </div>

        {% if clienti|length > 0 %}
        <div class="table-responsive shadow-sm rounded-4 overflow-hidden">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-primary">
              <tr>
                <th class="text-center">Stato</th>
                <th>Nome cliente</th>
                <th>Zona</th>
                <th class="text-center">Andamento</th>
                <th class="text-end">Fatturato totale (€)</th>
                <th class="text-center">Azioni</th>
              </tr>
            </thead>

            <tbody>
              {% for cliente in clienti %}

                <tr>
                  <!-- Stato -->
                  <td class="text-center fs-6">
                    {% set stato = stati_clienti.get(cliente.id, 'inattivo') %}
                    {% if stato == 'attivo' %}
                      <span class="px-2 py-1 bg-success text-white rounded-pill">Attivo</span>
                    {% elif stato == 'bloccato' %}
                      <span class="px-2 py-1 bg-danger text-white rounded-pill">Bloccato</span>
                    {% else %}
                      <span class="px-2 py-1 bg-secondary text-white rounded-pill">Inattivo</span>
                    {% endif %}
                  </td>

                  <!-- Nome -->
                  <td>
                    <a class="text-decoration-none fw-semibold"
                       href="{{ url_for('cliente_scheda', id=cliente.id) }}">
                      {{ cliente.nome }}
                    </a>
                  </td>

                  <!-- Zona -->
                  <td>{{ cliente.zona or '–' }}</td>

                  <!-- Andamento -->
                  <td class="text-center fs-6">
                    {% set andamento = andamento_clienti.get(cliente.id) %}

                    {% if andamento is not none %}
                      {% if andamento > 0 %}
                        <span class="text-success fw-bold">
                          <i class="bi bi-arrow-up"></i> {{ andamento }}%
                        </span>
                      {% elif andamento < 0 %}
                        <span class="text-danger fw-bold">
                          <i class="bi bi-arrow-down"></i> {{ andamento }}%
                        </span>
                      {% else %}
                        <span class="text-muted fw-bold">0%</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>

                  <!-- Fatturato totale -->
                  <td class="text-end">
                    {% if cliente.fatturato_totale is not none %}
                      <span class="fw-bold text-success">{{ "%.2f"|format(cliente.fatturato_totale) }}</span>
                    {% else %}
                      <span class="text-muted fst-italic">N/A</span>
                    {% endif %}
                  </td>

                  <!-- Azioni -->
                  <td class="text-center">
                    <div class="btn-group">
                      <a href="{{ url_for('cliente_scheda', id=cliente.id) }}" class="btn btn-sm btn-primary" title="Apri scheda">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{{ url_for('modifica_cliente', id=cliente.id) }}" class="btn btn-sm btn-warning" title="Modifica">
                        <i class="bi bi-pencil-square"></i>
                      </a>
                      <form action="{{ url_for('elimina_cliente', id=cliente.id) }}" method="POST"
                            onsubmit="return confirm('Sei sicuro di voler eliminare questo cliente?');"
                            style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger" title="Elimina">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

              {% endfor %}
            </tbody>

          </table>
        </div>

        {% else %}
          <p class="text-muted fst-italic">Nessun cliente in questa zona.</p>
        {% endif %}

      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted fst-italic">Nessun cliente registrato.</p>
  {% endif %}

  <a href="{{ url_for('index') }}" class="btn btn-secondary mt-5 rounded-4 d-flex align-items-center gap-2">
    <i class="bi bi-house-door"></i> Torna alla home
  </a>
</div>

<style>
.table-hover tbody tr:hover {
  background-color: #e9f5ff;
  transition: background 0.3s;
}
.table-striped tbody tr:nth-of-type(odd) {
  background-color: #f8f9fa;
}
.btn-group .btn:hover {
  transform: translateY(-2px);
}
</style>

{% endblock %}
