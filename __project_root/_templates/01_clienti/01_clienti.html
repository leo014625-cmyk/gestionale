{% extends "01_base.html" %}

{% block title %}Clienti - Gestionale Horeca{% endblock %}

{% block content %}
<div class="container py-5">

  <h1 class="mb-4">Lista Clienti</h1>

  <!-- Messaggi flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show rounded-4" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Filtri e ricerca -->
  <form method="get" class="mb-4 d-flex flex-wrap gap-3 align-items-end">
    <div class="d-flex flex-column">
      <label class="form-label mb-1">Cerca cliente</label>
      <input type="text" name="search" class="form-control"
             placeholder="Inserisci nome cliente..." value="{{ request.args.get('search', '') }}">
    </div>

    <div class="d-flex flex-column">
      <label class="form-label mb-1">Filtra per zona</label>
      <select name="zona" class="form-select" onchange="this.form.submit()">
        <option value="" {% if not request.args.get('zona') %}selected{% endif %}>Tutte le zone</option>
        {% for z in clienti_per_zona.keys()|sort %}
          <option value="{{ z }}" {% if request.args.get('zona') == z %}selected{% endif %}>{{ z }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="d-flex flex-column">
      <label class="form-label mb-1">Ordina per</label>
      <select name="order" class="form-select" onchange="this.form.submit()">
        <option value="zona" {% if request.args.get('order') == 'zona' or not request.args.get('order') %}selected{% endif %}>Zona</option>
        <option value="fatturato" {% if request.args.get('order') == 'fatturato' %}selected{% endif %}>Fatturato totale</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary mt-2 rounded-4">Applica</button>
  </form>

  <a href="{{ url_for('nuovo_cliente') }}" class="btn btn-success mb-4 rounded-4 d-flex align-items-center gap-2">
    <i class="bi bi-person-plus"></i> Aggiungi Cliente
  </a>

  {% if clienti_per_zona %}
    {% for zona, clienti in clienti_per_zona.items() %}
      {% if not request.args.get('zona') or request.args.get('zona') == zona %}

        <h3 class="mt-5 mb-3">{{ zona }}</h3>

        {% if clienti|length > 0 %}
        <div class="table-responsive shadow-sm rounded-4 overflow-hidden">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-primary">
              <tr>
                <th class="text-center">Stato</th>
                <th>Nome cliente</th>
                <th>Zona</th>

                <!-- ðŸŒŸ NUOVA COLONNA ANDAMENTO -->
                <th class="text-center">Andamento</th>

                <th class="text-end">Fatturato totale (â‚¬)</th>
                <th class="text-center">Azioni</th>
              </tr>
            </thead>
            <tbody>

              {% for cliente in clienti %}
              <tr>
                <!-- STATO -->
                <td class="text-center fs-6">
                  {% set stato = stati_clienti.get(cliente.id, 'inattivo') %}
                  {% if stato == 'attivo' %}
                    <span class="px-2 py-1 bg-success text-white rounded-pill">Attivo</span>
                  {% elif stato == 'bloccato' %}
                    <span class="px-2 py-1 bg-danger text-white rounded-pill">Bloccato</span>
                  {% else %}
                    <span class="px-2 py-1 bg-secondary text-white rounded-pill">Inattivo</span>
                  {% endif %}
                </td>

                <td>{{ cliente.nome }}</td>
                <td>{{ cliente.zona or 'â€“' }}</td>

                <!-- ðŸŒŸ ANDAMENTO FATTURATO (Freccia â†‘â†“) -->
                <td class="text-center fs-4">
                  {% set andamento = andamento_clienti.get(cliente.id) %}
                  
                  {% if andamento is not none %}
                    {% if andamento > 0 %}
                      <span class="text-success fw-bold">
                        <i class="bi bi-arrow-up"></i> {{ andamento }}%
                      </span>
                    {% elif andamento < 0 %}
                      <span class="text-danger fw-bold">
                        <i class="bi bi-arrow-down"></i> {{ andamento }}%
                      </span>
                    {% else %}
                      <span class="text-muted fw-bold">0%</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>

                <!-- FATTURATO TOTALE -->
                <td class="text-end">
                  {% if cliente.fatturato_totale %}
                    <span class="fw-bold text-success">{{ "%.2f"|format(cliente.fatturato_totale) }}</span>
                  {% else %}
                    <span class="text-muted fst-italic">N/A</span>
                  {% endif %}
                </td>

                <!-- AZIONI -->
                <td class="text-center">
                  <div class="btn-group">
                    <a href="{{ url_for('cliente_scheda', id=cliente.id) }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('modifica_cliente', id=cliente.id) }}" class="btn btn-sm btn-warning">
                      <i class="bi bi-pencil-square"></i>
                    </a>
                    <form action="{{ url_for('elimina_cliente', id=cliente.id) }}" method="POST"
                          onsubmit="return confirm('Sei sicuro di voler eliminare questo cliente?');"
                          style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>

              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>

        {% else %}
          <p class="text-muted fst-italic">Nessun cliente in questa zona.</p>
        {% endif %}

      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted fst-italic">Nessun cliente registrato.</p>
  {% endif %}

  <a href="{{ url_for('index') }}" class="btn btn-secondary mt-5 rounded-4 d-flex align-items-center gap-2">
    <i class="bi bi-house-door"></i> Torna alla home
  </a>
</div>

<style>
.table-hover tbody tr:hover { background-color: #e9f5ff; transition: background 0.3s; }
.table-striped tbody tr:nth-of-type(odd) { background-color: #f8f9fa; }
.btn-group .btn:hover { transform: translateY(-2px); }
</style>

{% endblock %}
