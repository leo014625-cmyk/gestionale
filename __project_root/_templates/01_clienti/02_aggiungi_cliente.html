{% extends "01_base.html" %}

{% block title %}Aggiungi Cliente - Gestionale Horeca{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <h1 class="mb-0">Aggiungi Cliente</h1>

    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('clienti') }}" class="btn btn-outline-secondary rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-arrow-left"></i> Lista clienti
      </a>
      <a href="{{ url_for('index') }}" class="btn btn-outline-secondary rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-house-door"></i> Home
      </a>
    </div>
  </div>

  <form method="POST" novalidate>

    <!-- DATI BASE -->
    <div class="card shadow-sm rounded-4 mb-4">
      <div class="card-header bg-white border-0 pt-4 px-4">
        <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Dati Cliente</h5>
        <div class="text-muted small">Inserisci nome e zona. Se serve, crea una nuova zona.</div>
      </div>
      <div class="card-body px-4 pb-4">

        <!-- Nome cliente -->
        <div class="mb-3">
          <label for="nome" class="form-label">Nome cliente</label>
          <input type="text" class="form-control rounded-4" id="nome" name="nome" required autofocus
                 placeholder="Es. Bar Centrale">
        </div>

        <!-- Zona -->
        <div class="mb-3">
          <label for="zona" class="form-label">Zona</label>
          <select class="form-select rounded-4" id="zona" name="zona" required>
            {% for z in zone %}
              <option value="{{ z.nome }}">{{ z.nome }}</option>
            {% endfor %}
            <option disabled>──────────</option>
            <option value="nuova_zona">+ Aggiungi nuova zona</option>
          </select>
          <div class="form-text">Seleziona una zona esistente o aggiungine una nuova.</div>
        </div>

        <!-- Nuova zona -->
        <div class="mb-3 d-none" id="nuova-zona-wrapper">
          <label for="nuova_zona" class="form-label">Nuova Zona</label>
          <input type="text" class="form-control rounded-4" id="nuova_zona" name="nuova_zona"
                 placeholder="Inserisci nuova zona">
        </div>

      </div>
    </div>

    <!-- FATTURATO -->
    <div class="card shadow-sm rounded-4 mb-4">
      <div class="card-header bg-white border-0 pt-4 px-4">
        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Fatturato Mensile</h5>
        <div class="text-muted small">Opzionale: puoi inserire un mese/anno iniziale.</div>
      </div>

      <div class="card-body px-4 pb-4">
        {% set mesi = {
          1: 'Gennaio', 2: 'Febbraio', 3: 'Marzo', 4: 'Aprile',
          5: 'Maggio', 6: 'Giugno', 7: 'Luglio', 8: 'Agosto',
          9: 'Settembre', 10: 'Ottobre', 11: 'Novembre', 12: 'Dicembre'
        } %}

        <div class="row g-3 align-items-end mb-3">
          <div class="col-12 col-md-3">
            <label for="mese" class="form-label">Mese</label>
            <select id="mese" name="mese" class="form-select rounded-4">
              {% for k, v in mesi.items() %}
                <option value="{{ k }}">{{ v }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label for="anno" class="form-label">Anno</label>
            <input type="number" id="anno" name="anno" class="form-control rounded-4"
                   value="{{ current_year }}" min="2000" max="2100">
          </div>

          <div class="col-12 col-md-6">
            <label for="fatturato_mensile" class="form-label">Importo (€)</label>
            <input type="number" step="0.01" min="0" class="form-control rounded-4"
                   id="fatturato_mensile" name="fatturato_mensile"
                   placeholder="Inserisci fatturato mensile (opzionale)">
          </div>
        </div>

        <div class="small text-muted">
          Se lo lasci vuoto, il cliente verrà creato senza fatturato.
        </div>
      </div>
    </div>

    <!-- PRODOTTI -->
    <div class="card shadow-sm rounded-4 mb-4">
      <div class="card-header bg-white border-0 pt-4 px-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Prodotti</h5>
            <div class="text-muted small">Seleziona i prodotti lavorati. Il riepilogo sotto si aggiorna in tempo reale.</div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <input id="search-prodotti" type="text" class="form-control form-control-sm rounded-4"
                   style="min-width:240px" placeholder="Cerca prodotto...">
          </div>
        </div>
      </div>

      <div class="card-body px-4 pb-4">

        {% if categorie %}
          <ul class="nav nav-pills mb-3 flex-wrap" id="prodottiTabs" role="tablist">
            {% for categoria in categorie %}
              <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %} rounded-pill"
                        id="tab-{{ categoria.id }}"
                        data-bs-toggle="tab"
                        data-bs-target="#cat-{{ categoria.id }}"
                        type="button" role="tab">
                  {{ categoria.nome }}
                </button>
              </li>
            {% endfor %}
          </ul>

          <div class="tab-content border rounded-4 p-3 bg-light-subtle">
            {% for categoria in categorie %}
              <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                   id="cat-{{ categoria.id }}" role="tabpanel">

                {% set prodotti_cat = prodotti|selectattr("categoria_id", "equalto", categoria.id)|list %}
                {% if prodotti_cat %}
                  <div class="row g-2">
                    {% for prodotto in prodotti_cat %}
                      <div class="col-12 col-md-6 col-lg-4 prodotto-item">
                        <div class="form-check bg-white border rounded-4 p-3 h-100 d-flex align-items-start gap-2">
                          <input class="form-check-input mt-1" type="checkbox"
                                 id="prodotto{{ prodotto.id }}" name="prodotti[]" value="{{ prodotto.id }}">
                          <label class="form-check-label" for="prodotto{{ prodotto.id }}">
                            <div class="fw-semibold">{{ prodotto.nome }}</div>
                            <div class="text-muted small">{{ categoria.nome }}</div>
                          </label>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="text-muted fst-italic mb-0">Nessun prodotto in questa categoria.</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted fst-italic mb-0">Nessuna categoria disponibile.</p>
        {% endif %}

      </div>
    </div>

    <!-- RIEPILOGO -->
    <div class="row g-3 mb-4">

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0"><i class="bi bi-check2-circle me-2 text-success"></i>Prodotti Lavorati</h5>
              <span class="badge text-bg-success" id="count-lavorati">0</span>
            </div>
          </div>
          <div class="card-body px-4 pb-4">
            <div class="table-responsive">
              <table class="table table-bordered mb-0" id="tabella-lavorati">
                <thead class="table-success">
                  <tr><th>Prodotto</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm rounded-4 h-100">
          <div class="card-header bg-white border-0 pt-4 px-4">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0"><i class="bi bi-x-circle me-2 text-danger"></i>Prodotti Non Lavorati</h5>
              <span class="badge text-bg-danger" id="count-non-lavorati">0</span>
            </div>
          </div>
          <div class="card-body px-4 pb-4">
            <div class="table-responsive">
              <table class="table table-bordered mb-0" id="tabella-non-lavorati">
                <thead class="table-danger">
                  <tr><th>Prodotto</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="d-flex flex-wrap gap-2">
      <button type="submit" class="btn btn-primary rounded-4">
        <i class="bi bi-save me-1"></i> Salva
      </button>
      <a href="{{ url_for('clienti') }}" class="btn btn-secondary rounded-4 ms-2">
        Annulla
      </a>
    </div>

  </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {

  // Gestione nuova zona
  const zonaSelect = document.getElementById('zona');
  const nuovaZonaWrapper = document.getElementById('nuova-zona-wrapper');
  const nuovaZonaInput = document.getElementById('nuova_zona');

  zonaSelect.addEventListener('change', function () {
    if (zonaSelect.value === 'nuova_zona') {
      nuovaZonaWrapper.classList.remove('d-none');
      nuovaZonaInput.required = true;
      nuovaZonaInput.focus();
    } else {
      nuovaZonaWrapper.classList.add('d-none');
      nuovaZonaInput.required = false;
      nuovaZonaInput.value = '';
    }
  });

  // Tabelle prodotti lavorati / non lavorati
  const prodottiCheckbox = document.querySelectorAll('input[name="prodotti[]"]');
  const tabellaLavorati = document.querySelector('#tabella-lavorati tbody');
  const tabellaNonLavorati = document.querySelector('#tabella-non-lavorati tbody');
  const countL = document.getElementById('count-lavorati');
  const countN = document.getElementById('count-non-lavorati');

  const prodotti = [
    {% for prodotto in prodotti %}
    { id: '{{ prodotto.id }}', nome: '{{ prodotto.nome|e }}' },
    {% endfor %}
  ];

  function aggiornaTabelle() {
    tabellaLavorati.innerHTML = '';
    tabellaNonLavorati.innerHTML = '';

    let nL = 0, nN = 0;

    prodotti.forEach(p => {
      const checkbox = Array.from(prodottiCheckbox).find(chk => chk.value === p.id);
      const riga = `<tr><td>${p.nome}</td></tr>`;

      if (checkbox && checkbox.checked) {
        nL++;
        tabellaLavorati.insertAdjacentHTML('beforeend', riga);
      } else {
        nN++;
        tabellaNonLavorati.insertAdjacentHTML('beforeend', riga);
      }
    });

    countL.textContent = nL;
    countN.textContent = nN;
  }

  aggiornaTabelle();
  prodottiCheckbox.forEach(chk => chk.addEventListener('change', aggiornaTabelle));

  // Ricerca prodotti (testo) - filtra i box
  const search = document.getElementById('search-prodotti');
  if (search) {
    search.addEventListener('input', () => {
      const q = search.value.toLowerCase().trim();
      document.querySelectorAll('.prodotto-item').forEach(el => {
        const txt = el.innerText.toLowerCase();
        el.style.display = txt.includes(q) ? '' : 'none';
      });
    });
  }
});
</script>
{% endblock %}
