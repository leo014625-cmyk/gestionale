{% extends "01_base.html" %}

{% block title %}Scheda Cliente - {{ cliente.nome }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
  :root {
    --primary: #0d6efd;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #fd7e14;
    --gray: #6c757d;
    --light-bg: #f8f9fa;
    --shadow: 0 4px 10px rgba(0,0,0,0.08);
    --radius: 10px;
  }

  body {
    background-color: var(--light-bg);
    font-family: "Inter", system-ui, sans-serif;
  }

  h1, h5 {
    font-weight: 600;
  }

  /* ------------------ Categoria Card ------------------ */
  .categoria-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    border-radius: var(--radius);
    background: #fff;
    padding: 1.5rem;
    box-shadow: var(--shadow);
    text-align: center;
  }

  .categoria-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.12);
  }

  .categoria-card i {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 0.5rem;
  }

  /* ------------------ Search Bar ------------------ */
  .search-bar {
    padding: 0.6rem 1rem;
    border: 1px solid #ddd;
    border-radius: var(--radius);
    width: 100%;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    transition: 0.2s;
  }

  .search-bar:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.15rem rgba(13,110,253,0.25);
    outline: none;
  }

  /* ------------------ Badges ------------------ */
  .badge-soft {
    padding: 0.4em 0.6em;
    font-size: 0.8rem;
    border-radius: var(--radius);
    font-weight: 500;
  }

  .badge-soft-success { background-color: rgba(40,167,69,0.15); color: var(--success); }
  .badge-soft-danger  { background-color: rgba(220,53,69,0.15); color: var(--danger); }
  .badge-soft-warning { background-color: rgba(253,126,20,0.15); color: var(--warning); }

  /* ------------------ Tabelle ------------------ */
  table tbody tr {
    transition: all 0.2s ease;
  }

  table tbody tr:hover {
    background-color: #f1f3f5 !important;
  }

  /* ------------------ Log Cliente ------------------ */
  .log-container {
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid #eaeaea;
    border-radius: var(--radius);
    padding: 0.5rem 0.75rem;
    background-color: #fff;
  }

  .log-container li {
    font-size: 0.9rem;
  }

  /* ------------------ Card generiche ------------------ */
  .card {
    border: none;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .card-header {
    border-radius: var(--radius) var(--radius) 0 0 !important;
  }

  /* ------------------ Tooltip ------------------ */
  .tooltip-inner {
    background-color: var(--gray);
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
  <h1 class="mb-0 flex-grow-1">
    {{ cliente.nome }}
    {% if stato_cliente == 'attivo' %}
      <span class="badge bg-success ms-3"><i class="bi bi-circle-fill"></i> Attivo</span>
    {% elif stato_cliente == 'bloccato' %}
      <span class="badge bg-danger ms-3"><i class="bi bi-circle-fill"></i> Bloccato</span>
    {% else %}
      <span class="badge bg-secondary ms-3"><i class="bi bi-circle-fill"></i> Inattivo</span>
    {% endif %}
  </h1>
</div>

<div class="row g-4 mb-4">
  <!-- Dati cliente -->
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <p><strong>Zona:</strong> {{ cliente.zona or '–' }}</p>
        <p><strong>Fatturato Totale:</strong>
          {% if fatturato_totale and fatturato_totale|float > 0 %}
            <span class="fw-bold text-success">{{ "%.2f"|format(fatturato_totale) }} €</span>
          {% else %}
            <span class="text-muted fst-italic">Nessun dato disponibile</span>
          {% endif %}
        </p>

        <h6 class="mt-4 mb-2">Ultimi 5 Log</h6>
        {% if log_cliente %}
          <div class="log-container">
            <ul class="list-unstyled mb-0">
              {% for log in log_cliente|sort(attribute='data', reverse=true)[:5] %}
                <li class="d-flex justify-content-between align-items-center border-bottom py-1">
                  <div>
                    {% if 'Aggiunto prodotto' in log.descrizione %}
                      <i class="bi bi-plus-circle-fill text-success me-2"></i>
                    {% elif 'Rimosso prodotto' in log.descrizione %}
                      <i class="bi bi-dash-circle-fill text-danger me-2"></i>
                    {% elif 'Fatturato aggiornato' in log.descrizione %}
                      <i class="bi bi-currency-euro text-primary me-2"></i>
                    {% else %}
                      <i class="bi bi-info-circle-fill text-secondary me-2"></i>
                    {% endif %}
                    {{ log.descrizione }}
                  </div>
                  <small class="text-muted">{{ log.data.strftime("%d/%m/%Y %H:%M") if log.data else '–' }}</small>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          <p class="text-muted fst-italic">Nessun log disponibile.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grafico -->
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-graph-up-arrow me-2"></i> Andamento Fatturato</span>
        <select id="filtro-mesi" class="form-select form-select-sm w-auto bg-light text-dark">
          <option value="ultimi3" selected>Ultimi 3 mesi</option>
          <option value="tutti">Tutti</option>
        </select>
      </div>
      <div class="card-body">
        <canvas id="fatturatoMensileChart" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Categorie -->
<div class="row g-4 mb-4">
  {% for cat in categorie %}
    <div class="col-md-4">
      <div class="categoria-card" data-cat-id="{{ cat.id }}">
        <i class="bi bi-box-seam"></i>
        <h5 class="mb-1">{{ cat.nome }}</h5>
        <small class="text-muted">Clicca per vedere i prodotti</small>
      </div>
    </div>
  {% endfor %}
</div>

<div id="contenitore-tabella" class="mt-4"></div>

<!-- Templates nascosti -->
{% for cat in categorie %}
  <template id="tabella-template-{{ cat.id }}">
    <div class="card">
      <div class="card-body">
        <h5 class="border-bottom pb-2 mb-3">{{ cat.nome }}</h5>
        <input type="text" class="search-bar" placeholder="Cerca prodotto..." onkeyup="filtraProdotti(this, '{{ cat.id }}')">

        <div class="table-responsive">
          <table class="table align-middle" id="tabella-prodotti-{{ cat.id }}">
            <thead class="table-light">
              <tr>
                <th>Prodotto</th>
                <th>Stato</th>
                <th>Prezzo Attuale (€)</th>
                <th>Offerta (€)</th>
                <th>Ultima Modifica</th>
              </tr>
            </thead>
            <tbody>
              {% for p in prodotti|sort(attribute='nome') if p.categoria_id == cat.id %}
                {% set pid = p.id|string %}
                {% set lavorato = pid in (prodotti_lavorati | map('string') | list) %}
                <tr class="{% if lavorato %}table-success{% else %}table-danger{% endif %}">
                  <td><strong>{{ p.nome }}</strong></td>
                  <td>
                    {% if lavorato %}
                      <span class="badge-soft badge-soft-success">Lavorato</span>
                    {% else %}
                      <span class="badge-soft badge-soft-danger">Non Lavorato</span>
                    {% endif %}
                  </td>
                  <td>{{ "%.2f"|format(prezzi_attuali.get(pid) or 0) }}</td>
                  <td>
                    {% if prezzi_offerta.get(pid) %}
                      <span class="badge-soft badge-soft-warning" data-bs-toggle="tooltip" title="Ultima modifica: {{ prodotti_data.get(pid) }}">
                        {{ "%.2f"|format(prezzi_offerta[pid]) }}
                      </span>
                    {% else %}–{% endif %}
                  </td>
                  <td>{{ prodotti_data.get(pid) or '–' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-center text-muted fst-italic">Nessun prodotto</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </template>
{% endfor %}

<a href="{{ url_for('clienti') }}" class="btn btn-outline-secondary mt-4">
  <i class="bi bi-arrow-left me-1"></i> Torna alla lista clienti
</a>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const fatturato = {{ fatturato_mensile|default({})|tojson }};
  const mesi = Object.keys(fatturato).sort();
  const mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
  const ctx = document.getElementById('fatturatoMensileChart').getContext('2d');
  let chart;

  const formatta = m => {
    const [anno, mese] = m.split('-');
    return mesiNomi[parseInt(mese)-1]+" '"+anno.slice(2);
  };

  const getData = tipo => {
    const subset = tipo==='ultimi3' ? mesi.slice(-3) : mesi;
    return { labels: subset.map(formatta), dati: subset.map(m=>fatturato[m]) };
  };

  const gradient = ctx.createLinearGradient(0,0,0,200);
  gradient.addColorStop(0, 'rgba(13,110,253,0.8)');
  gradient.addColorStop(1, 'rgba(13,110,253,0.2)');

  const aggiornaGrafico = tipo => {
    const d = getData(tipo);
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: d.labels,
        datasets: [{ data: d.dati, backgroundColor: gradient, borderRadius: 6, borderSkipped: false }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  };

  document.getElementById('filtro-mesi').addEventListener('change', e => aggiornaGrafico(e.target.value));
  aggiornaGrafico('ultimi3');

  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

  document.querySelectorAll(".categoria-card").forEach(card => {
    card.addEventListener("click", () => {
      const template = document.getElementById(`tabella-template-${card.dataset.catId}`);
      document.getElementById("contenitore-tabella").innerHTML = template.innerHTML;
    });
  });
})();

function filtraProdotti(input, catId) {
  const filtro = input.value.toLowerCase();
  document.querySelectorAll(`#tabella-prodotti-${catId} tbody tr`).forEach(riga => {
    const nome = riga.querySelector("td")?.innerText.toLowerCase() || "";
    riga.style.display = nome.includes(filtro) ? "" : "none";
  });
}
</script>
{% endblock %}
