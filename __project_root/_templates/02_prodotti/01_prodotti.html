{% extends "01_base.html" %}

{% block title %}Prodotti - Gestionale Horeca{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="mb-1">Gestione Prodotti</h1>
      <div class="text-muted">Categorie, ricerca rapida e azioni sui prodotti.</div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('aggiungi_prodotto') }}" class="btn btn-success rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-plus-circle"></i> Aggiungi Prodotto
      </a>

      <!-- âœ… NUOVO: prodotti senza categoria (ðŸŸ  ARANCIONE) -->
      <button type="button"
              class="btn btn-outline-warning rounded-4 d-flex align-items-center gap-2"
              data-bs-toggle="modal"
              data-bs-target="#categoriaModal"
              data-categoria="__SENZA__">
        <i class="bi bi-exclamation-triangle"></i> Prodotti senza categoria
        <span class="badge text-bg-warning ms-1">{{ (prodotti_senza_categoria|length) if prodotti_senza_categoria else 0 }}</span>
      </button>

      <a href="{{ url_for('gestisci_categorie') }}" class="btn btn-secondary rounded-4 d-flex align-items-center gap-2">
        <i class="bi bi-folder2-open"></i> Gestisci Categorie
      </a>
    </div>
  </div>

  <!-- Ricerca globale + quick filters -->
  <div class="card shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-lg-7">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="searchGlobale" class="form-control"
                   placeholder="Cerca per nome, codice o categoria...">
            <button type="button" class="btn btn-outline-secondary" id="btnClearSearch" title="Pulisci">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="form-text">Suggerimento: cerca anche per <b>codice prodotto</b>.</div>
        </div>

        <div class="col-12 col-lg-5">
          <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
            <button type="button" class="btn btn-outline-primary rounded-4" id="btnMostraTutte">
              <i class="bi bi-grid-3x3-gap"></i> Tutte
            </button>
            <button type="button" class="btn btn-outline-primary rounded-4" id="btnSoloPiene" title="Categorie con prodotti">
              <i class="bi bi-check2-circle"></i> Con prodotti
            </button>
            <button type="button" class="btn btn-outline-primary rounded-4" id="btnSoloVuote" title="Categorie senza prodotti">
              <i class="bi bi-slash-circle"></i> Vuote
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cards categorie -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="categorieCardContainer">
    {% if categorie %}
      {% for categoria in categorie %}
        {% set n_prod = prodotti_per_categoria.get(categoria.nome, [])|length %}
        <div class="col categoria-col"
             data-categoria="{{ categoria.nome }}"
             data-count="{{ n_prod }}">
          <div class="card shadow-sm hover-scale cursor-pointer border-0 text-center position-relative categoria-card"
               {% if categoria.immagine %}
                 style="background-image: url('{{ categoria.immagine }}');"
               {% else %}
                 style="background: linear-gradient(135deg, #6c757d, #343a40);"
               {% endif %}
               data-bs-toggle="modal"
               data-bs-target="#categoriaModal"
               data-categoria="{{ categoria.nome }}">

            <div class="overlay d-flex flex-column justify-content-center align-items-center p-3">
              <div class="chip mb-2">
                <i class="bi bi-tags me-1"></i> Categoria
              </div>

              <h5 class="card-title fw-bold mb-1">{{ categoria.nome }}</h5>

              <div class="d-flex align-items-center gap-2 mt-1">
                {% if n_prod > 0 %}
                  <span class="badge text-bg-light">
                    <i class="bi bi-box-seam me-1"></i> {{ n_prod }} prodotti
                  </span>
                {% else %}
                  <span class="badge text-bg-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i> Nessun prodotto
                  </span>
                {% endif %}
              </div>

              <div class="small text-white-50 mt-3">
                Clicca per vedere i prodotti
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <div class="alert alert-warning text-center rounded-4">
          Nessuna categoria disponibile.
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal prodotti -->
  <div class="modal fade" id="categoriaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content modal-animate rounded-4 overflow-hidden">
        <div class="modal-header bg-primary text-white">
          <div>
            <h5 class="modal-title mb-0" id="categoriaModalLabel">Prodotti</h5>
            <div class="small text-white-50" id="categoriaModalSub">â€”</div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>

        <div class="modal-body p-0">
          <div class="p-3 bg-light border-bottom sticky-top">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-lg-7">
                <div class="input-group">
                  <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                  <input type="text" id="searchProdotti" class="form-control"
                         placeholder="Cerca per nome o codice...">
                  <button type="button" class="btn btn-outline-secondary" id="btnClearSearchModal" title="Pulisci">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>

              <div class="col-12 col-lg-5">
                <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                  <button type="button" class="btn btn-outline-secondary btn-sm rounded-4" id="btnSortAZ">
                    <i class="bi bi-sort-alpha-down"></i> A-Z
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm rounded-4" id="btnSortZA">
                    <i class="bi bi-sort-alpha-up"></i> Z-A
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="p-2">
            <div id="listaProdotti" class="list-group list-group-flush max-height-520 overflow-auto"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary rounded-4" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <a href="{{ url_for('index') }}" class="btn btn-secondary mt-5 rounded-4 d-flex align-items-center gap-2">
    <i class="bi bi-house-door"></i> Torna alla home
  </a>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const prodottiPerCategoria = {{ prodotti_per_categoria|tojson }};
  const prodottiSenzaCategoria = {{ (prodotti_senza_categoria or [])|tojson }};

  const modal = document.getElementById('categoriaModal');
  const modalTitle = document.getElementById('categoriaModalLabel');
  const modalSub = document.getElementById('categoriaModalSub');
  const listaProdotti = document.getElementById('listaProdotti');

  const searchInput = document.getElementById('searchProdotti');
  const searchGlobale = document.getElementById('searchGlobale');

  const btnClearSearch = document.getElementById('btnClearSearch');
  const btnClearSearchModal = document.getElementById('btnClearSearchModal');

  const btnSortAZ = document.getElementById('btnSortAZ');
  const btnSortZA = document.getElementById('btnSortZA');

  const btnMostraTutte = document.getElementById('btnMostraTutte');
  const btnSoloPiene = document.getElementById('btnSoloPiene');
  const btnSoloVuote = document.getElementById('btnSoloVuote');

  let categoriaCorrente = null;
  let prodottiCorrenti = [];

  function escapeHtml(str) {
    return (str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function norm(s) {
    return (s || "").toLowerCase().trim();
  }

  function renderProdotti(prodotti) {
    listaProdotti.innerHTML = '';
    if (!prodotti || prodotti.length === 0) {
      listaProdotti.innerHTML = `<div class="text-center text-muted py-4">Nessun prodotto.</div>`;
      return;
    }

    prodotti.forEach(p => {
      const nome = escapeHtml(p.nome);
      const codice = escapeHtml(p.codice || "â€”");

      const item = document.createElement('div');
      item.className = 'list-group-item prodotto-row rounded-4 mx-2 my-2';
      item.innerHTML = `
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex align-items-center gap-2">
            <span class="icon-pill"><i class="bi bi-box-seam"></i></span>
            <div>
              <div class="fw-semibold">${nome}</div>
              <div class="small text-muted mt-1">
                <span class="badge text-bg-light border">
                  <i class="bi bi-upc-scan me-1"></i> COD: ${codice}
                </span>
              </div>
            </div>
          </div>

          <div class="btn-group btn-group-sm" role="group">
            <a href="/prodotti/clienti/${p.id}" class="btn btn-outline-info" title="Clienti">
              <i class="bi bi-people"></i>
            </a>
            <a href="/prodotti/modifica/${p.id}" class="btn btn-outline-warning" title="Modifica">
              <i class="bi bi-pencil-square"></i>
            </a>
            <form action="/prodotti/elimina/${p.id}" method="POST" class="d-inline"
                  onsubmit="return confirm('Sei sicuro di voler eliminare questo prodotto?');">
              <button type="submit" class="btn btn-outline-danger" title="Elimina">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </div>
        </div>
      `;
      listaProdotti.appendChild(item);
    });
  }

  function applyModalFilter() {
    const q = norm(searchInput.value);
    const filtered = prodottiCorrenti.filter(p => {
      const nome = norm(p.nome);
      const codice = norm(p.codice);
      return nome.includes(q) || codice.includes(q);
    });
    renderProdotti(filtered);
    modalSub.textContent = `${filtered.length} / ${prodottiCorrenti.length} prodotti`;
  }

  function filterCategorieCards() {
    const q = norm(searchGlobale.value);

    // filtro card categorie (come prima)
    document.querySelectorAll('#categorieCardContainer .categoria-col').forEach(col => {
      const nomeCat = norm(col.dataset.categoria);
      const prodotti = prodottiPerCategoria[col.dataset.categoria] || [];

      const matchCategoria = nomeCat.includes(q);
      const matchProdotto = prodotti.some(p => {
        const nome = norm(p.nome);
        const codice = norm(p.codice);
        return nome.includes(q) || codice.includes(q);
      });

      col.style.display = (matchCategoria || matchProdotto) ? '' : 'none';
    });

    // âœ… se cerchi qualcosa che matcha prodotti senza categoria, non abbiamo una "card",
    // ma almeno lâ€™utente puÃ² cliccare il bottone sopra e trovarli.
  }

  function filterByCount(mode) {
    document.querySelectorAll('#categorieCardContainer .categoria-col').forEach(col => {
      const count = parseInt(col.dataset.count || "0", 10);
      if (mode === "piene") col.style.display = count > 0 ? "" : "none";
      else if (mode === "vuote") col.style.display = count === 0 ? "" : "none";
      else col.style.display = "";
    });
  }

  modal.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget;
    categoriaCorrente = button.getAttribute('data-categoria');

    if (categoriaCorrente === "__SENZA__") {
      prodottiCorrenti = (prodottiSenzaCategoria || []).slice();
      modalTitle.textContent = `Prodotti - Senza categoria`;
    } else {
      prodottiCorrenti = (prodottiPerCategoria[categoriaCorrente] || []).slice();
      modalTitle.textContent = `Prodotti - ${categoriaCorrente}`;
    }

    modalSub.textContent = `${prodottiCorrenti.length} prodotti`;
    searchInput.value = '';
    renderProdotti(prodottiCorrenti);
  });

  searchInput.addEventListener('input', applyModalFilter);

  btnClearSearchModal.addEventListener('click', () => {
    searchInput.value = '';
    applyModalFilter();
    searchInput.focus();
  });

  btnSortAZ.addEventListener('click', () => {
    prodottiCorrenti.sort((a,b) => (a.nome || "").localeCompare(b.nome || "", 'it', { sensitivity:'base' }));
    applyModalFilter();
  });

  btnSortZA.addEventListener('click', () => {
    prodottiCorrenti.sort((a,b) => (b.nome || "").localeCompare(a.nome || "", 'it', { sensitivity:'base' }));
    applyModalFilter();
  });

  searchGlobale.addEventListener('input', filterCategorieCards);

  btnClearSearch.addEventListener('click', () => {
    searchGlobale.value = '';
    filterCategorieCards();
    searchGlobale.focus();
  });

  btnMostraTutte.addEventListener('click', () => filterByCount("tutte"));
  btnSoloPiene.addEventListener('click', () => filterByCount("piene"));
  btnSoloVuote.addEventListener('click', () => filterByCount("vuote"));
});
</script>

<style>
.hover-scale { transition: transform 0.25s ease, box-shadow 0.25s ease; }
.hover-scale:hover { transform: translateY(-6px); box-shadow: 0 18px 36px rgba(0,0,0,0.18); }

.categoria-card{
  border-radius: 1rem;
  height: 300px;
  position: relative;
  overflow: hidden;
  color: white;
  background-size: cover;
  background-position: center;
}

.overlay{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.40);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  z-index: 2;
  transition: background 0.25s ease;
}
.categoria-card:hover .overlay{ background: rgba(0,0,0,0.20); }

.chip{
  display: inline-flex;
  align-items: center;
  gap: .35rem;
  padding: .25rem .6rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.22);
  backdrop-filter: blur(6px);
  font-size: .8rem;
}

.card-title { font-size: 1.6rem; text-shadow: 0 6px 22px rgba(0,0,0,0.30); }

.modal-animate { transform: scale(0.98); opacity: 0; transition: transform 0.2s ease, opacity 0.2s ease; }
.modal.show .modal-animate { transform: scale(1); opacity: 1; }

.max-height-520 { max-height: 520px; }

.prodotto-row{
  border: 1px solid rgba(0,0,0,0.06);
  background: #fff;
  transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}
.prodotto-row:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 22px rgba(0,0,0,0.10);
  background: #f8f9fa;
}

.icon-pill{
  width: 32px;
  height: 32px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(13,110,253,0.10);
  color: #0d6efd;
}

.cursor-pointer { cursor: pointer; }
</style>
{% endblock %}
