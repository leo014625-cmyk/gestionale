{% extends "01_base.html" %}

{% block title %}Dashboard - Gestionale Horeca{% endblock %}

{% block styles %}
{{ super() }}
<style>
body { background: #f6f8fa; }

.dashboard-header {
  background: linear-gradient(135deg, #0d6efd 0%, #2a5bd7 100%);
  color: #fff;
  border-radius: 1rem;
  padding: 3rem 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.metric-card {
  border: none;
  transition: all 0.25s ease;
  background: #fff;
  border-radius: 1rem !important;
  height: 100%;
}
.metric-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}
.metric-card h6 { font-size: 0.95rem; color: #6c757d; }

.chart-card { border-radius: 1rem; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; }

.link-card { transition: all 0.25s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.link-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
.link-clienti:hover { background-color: #0d6efd; color: #fff !important; border-color: #0d6efd; }
.link-prodotti:hover { background-color: #198754; color: #fff !important; border-color: #198754; }
.link-fatturato:hover { background-color: #ffc107; color: #212529 !important; border-color: #ffc107; }
.link-card i { transition: transform 0.2s ease; }
.link-card:hover i { transform: scale(1.15); }

.list-group-item { border-radius: 0.5rem; margin-bottom: 0.3rem; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Header -->
  <div class="dashboard-header text-center mb-5 position-relative">
    <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3"
            data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifiche">
      <i class="bi bi-bell-fill fs-4 text-primary"></i>
      {% set not_unread = notifiche|selectattr('letto', 'equalto', False)|list %}
      {% if not_unread|length > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill notification-badge" id="notifica-badge">
        {{ not_unread|length }}
      </span>
      {% endif %}
    </button>
    <h1 class="display-5 fw-bold mb-2">Bentornato, Leonardo ðŸ‘‹</h1>
    <p class="lead mb-0 text-white">Gestisci in un colpo dâ€™occhio clienti, prodotti e fatturato.</p>
  </div>

  <!-- Quick Links -->
  <div class="row quick-links justify-content-center g-4 mb-5">
    <div class="col-12 col-md-3">
      <a href="{{ url_for('clienti') }}" class="btn btn-outline-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-clienti">
        <i class="bi bi-people-fill fs-3"></i> <span class="fw-semibold">Clienti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('prodotti') }}" class="btn btn-outline-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-prodotti">
        <i class="bi bi-box-seam fs-3"></i> <span class="fw-semibold">Prodotti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('fatturato') }}" class="btn btn-outline-warning btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-fatturato text-warning fw-semibold">
        <i class="bi bi-cash-stack fs-3 text-warning"></i> <span>Fatturato</span>
      </a>
    </div>
  </div>

  <!-- Metriche Card -->
  <div class="row g-4 mb-5">
    {% set metriche = [
      {'titolo': 'Variazione Fatturato', 'valore': variazione_fatturato, 'tipo': 'percent', 'modal': 'modalFatturato', 'classe': 'text-dark'},
      {'titolo': 'Clienti Nuovi (30gg)', 'valore': clienti_nuovi|length if clienti_nuovi is iterable else clienti_nuovi, 'modal': 'modalClientiNuovi', 'classe': 'text-dark'},
      {'titolo': 'Clienti Bloccati', 'valore': clienti_bloccati|length if clienti_bloccati is iterable else clienti_bloccati, 'modal': 'modalClientiBloccati', 'classe': 'text-danger'},
      {'titolo': 'Clienti Inattivi', 'valore': clienti_inattivi|length if clienti_inattivi is iterable else clienti_inattivi, 'modal': 'modalClientiInattivi', 'classe': 'text-secondary'},
      {'titolo': 'Prodotti Inseriti (30gg)', 'valore': prodotti_inseriti|length if prodotti_inseriti is iterable else prodotti_inseriti, 'modal': 'modalProdottiTotali', 'classe': 'text-dark'},
      {'titolo': 'Prodotti Rimossi', 'valore': prodotti_rimossi|length if prodotti_rimossi is iterable else prodotti_rimossi, 'modal': 'modalProdottiRimossi', 'classe': 'text-dark'}
    ] %}
    
    {% for m in metriche %}
      <div class="col-6 col-md-3">
        <div class="card metric-card text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#{{ m.modal }}">
          <h6>{{ m.titolo }}</h6>
          {% if m.tipo == 'percent' and m.valore is not none %}
            <div class="fs-3 fw-bold {{ 'text-success' if m.valore > 0 else 'text-danger' }}">
              {{ "%.2f"|format(m.valore) }}%
              {% if m.valore > 0 %}<i class="bi bi-arrow-up"></i>{% elif m.valore < 0 %}<i class="bi bi-arrow-down"></i>{% endif %}
            </div>
          {% else %}
            <div class="fs-3 fw-bold {{ m.classe }}">{{ m.valore or 0 }}</div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Grafici: 12 mesi e per zona -->
  <div class="row g-4 mb-5">
    <div class="col-12 col-lg-6 d-flex">
      <div class="card chart-card w-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title"><i class="bi bi-graph-up-arrow me-2 text-primary"></i> Andamento Fatturato (12 mesi)</h5>
          <canvas id="fatturatoChart" class="flex-grow-1"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 d-flex">
      <div class="card chart-card w-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title"><i class="bi bi-pie-chart-fill me-2 text-warning"></i> Fatturato per Zona</h5>
          <canvas id="fatturatoZonaChart" class="flex-grow-1"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modali dettagli metriche -->
{% macro dettaglio_lista(modal_id, lista, tipo='') %}
<div class="modal fade" id="{{ modal_id }}" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ modal_id.replace('modal','') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if lista %}
        <ul class="list-group">
          {% for item in lista %}
            {% if tipo == 'prodotto' %}
              <li class="list-group-item">{{ item.cliente }}: {{ item.prodotto }}</li>
            {% else %}
              <li class="list-group-item {{ 'text-danger' if tipo=='bloccato' else '' }}">{{ item.nome }}</li>
            {% endif %}
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-muted">Nessun dato disponibile</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endmacro %}

{{ dettaglio_lista('modalClientiNuovi', clienti_nuovi_dettaglio) }}
{{ dettaglio_lista('modalClientiBloccati', clienti_bloccati_dettaglio, 'bloccato') }}
{{ dettaglio_lista('modalClientiInattivi', clienti_inattivi_dettaglio, 'inattivo') }}
{{ dettaglio_lista('modalProdottiTotali', prodotti_inseriti, 'prodotto') }}
{{ dettaglio_lista('modalProdottiRimossi', prodotti_rimossi, 'prodotto') }}

<!-- Offcanvas Notifiche -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifiche">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Centro Notifiche</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    {% if notifiche %}
      <ul class="list-group list-group-flush">
        {% for notifica in notifiche %}
          <li class="list-group-item d-flex justify-content-between align-items-start" id="notifica-{{ notifica.id }}">
            <div class="me-auto">
              <strong>{{ notifica.titolo }}</strong>
              <div class="small text-muted">{{ notifica.descrizione }}</div>
            </div>
            <span class="badge bg-{{ notifica.tipo or 'primary' }} rounded-pill">{{ notifica.data.strftime("%d/%m/%Y") }}</span>
            <button type="button" class="btn-close ms-2" onclick="chiudiNotifica({{ notifica.id }});"></button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Nessuna notifica disponibile.</p>
    {% endif %}
  </div>
</div>

<script>
function chiudiNotifica(id) {
    const elem = document.getElementById('notifica-' + id);
    if(elem) elem.remove();
    const badge = document.getElementById('notifica-badge');
    if(badge) {
        let count = parseInt(badge.textContent);
        count--;
        if(count > 0) badge.textContent = count;
        else badge.remove();
    }
}
</script>

<!-- Grafici Chart.js -->
{% if fatturato_mensile is defined %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    // Fatturato ultimi 12 mesi
    const dati12 = {{ fatturato_mensile|tojson }};
    const labels12 = Object.keys(dati12).sort().map(m => {
        const [anno, mese] = m.split('-');
        const mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
        return mesiNomi[parseInt(mese,10)-1] + " '" + anno.slice(2);
    });
    const valori12 = Object.keys(dati12).sort().map(m => dati12[m]);
    const ctx12 = document.getElementById('fatturatoChart').getContext('2d');
    new Chart(ctx12, {
        type: 'bar',
        data: { labels: labels12, datasets: [{ label: 'Fatturato (â‚¬)', data: valori12, backgroundColor: 'rgba(74,144,226,0.8)', borderRadius: 8, borderSkipped: false }] },
        options: { responsive: true, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a2638', titleColor: '#4a90e2', bodyColor: '#cfd8e6', cornerRadius: 6, padding: 10, displayColors: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6c757d', font: { weight: 600 } } }, y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#6c757d' } } } }
    });

    // Fatturato per zona
    const datiZona = {{ fatturato_per_zona|default({})|tojson }};
    const labelsZona = Object.keys(datiZona);
    const valoriZona = Object.values(datiZona);
    if(labelsZona.length > 0){
        const ctxZona = document.getElementById('fatturatoZonaChart').getContext('2d');
        new Chart(ctxZona, {
            type: 'pie',
            data: { labels: labelsZona, datasets: [{ data: valoriZona, backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1','#fd7e14'] }] },
            options: { responsive: true, plugins: { legend: { position: 'right', labels: { color: '#6c757d' } }, tooltip: { backgroundColor: '#1a2638', titleColor: '#4a90e2', bodyColor: '#cfd8e6', cornerRadius: 6, padding: 10 } }, maintainAspectRatio: false }
        });
    }
})();
</script>
{% endif %}
{% endblock %}
