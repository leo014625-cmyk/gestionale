{% extends "01_base.html" %}

{% block title %}Home - Gestionale Horeca{% endblock %}

{% block content %}
<div class="text-center py-5 position-relative">

  <!-- Centro Notifiche -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
    <button type="button" class="btn btn-outline-primary position-relative" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifiche" aria-controls="offcanvasNotifiche">
      <i class="bi bi-bell-fill fs-4"></i>
      {% if notifiche|length > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{ notifiche|length }}
        <span class="visually-hidden">nuove notifiche</span>
      </span>
      {% endif %}
    </button>
  </div>

  <h1 class="display-4 fw-bold mb-3">Bentornato Leonardo</h1>
  <p class="lead mb-5">Gestisci i tuoi clienti, prodotti e fatturato con facilità e rapidità.</p>

  <div class="row justify-content-center g-4 mb-5">
    <div class="col-12 col-md-3">
      <a href="{{ url_for('clienti') }}" class="btn btn-primary btn-lg w-100 shadow-sm d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-people-fill fs-3"></i> Clienti
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('prodotti') }}" class="btn btn-success btn-lg w-100 shadow-sm d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-box-seam fs-3"></i> Prodotti
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('fatturato') }}" class="btn btn-warning btn-lg w-100 shadow-sm text-dark d-flex align-items-center justify-content-center gap-2">
        <i class="bi bi-cash-stack fs-3"></i> Fatturato
      </a>
    </div>
  </div>

  <!-- CARD METRICHE -->
  <div class="row g-4 justify-content-center mb-5">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalFatturato">
        <h6>Variazione Fatturato</h6>
        {% if variazione_fatturato is not none %}
          <div class="fs-3 fw-bold {{ 'text-success' if variazione_fatturato > 0 else 'text-danger' }}">
            {{ "%.2f"|format(variazione_fatturato) }}%
            {% if variazione_fatturato > 0 %}
              <i class="bi bi-arrow-up"></i>
            {% elif variazione_fatturato < 0 %}
              <i class="bi bi-arrow-down"></i>
            {% endif %}
          </div>
        {% else %}
          <div class="fs-5 text-muted">N/D</div>
        {% endif %}
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalClientiNuovi">
        <h6>Clienti Nuovi (Ultimo Mese)</h6>
        <div class="fs-3 fw-bold">{{ clienti_nuovi or 0 }}</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalClientiBloccati">
        <h6>Clienti Bloccati (Ultimo Mese)</h6>
        <div class="fs-3 fw-bold text-danger">{{ clienti_bloccati or 0 }}</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalClientiInattivi">
        <h6>Clienti Inattivi</h6>
        <div class="fs-3 fw-bold text-secondary">{{ clienti_inattivi_dettaglio|length or 0 }}</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalProdottiTotali">
        <h6>Prodotti Totali Inseriti (Ultimo Mese)</h6>
        <div class="fs-3 fw-bold">{{ prodotti_totali_mese or 0 }}</div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card shadow-sm rounded-3 text-center p-3 h-100" role="button" data-bs-toggle="modal" data-bs-target="#modalProdottiRimossi">
        <h6>Prodotti Rimossi Ultimo Mese</h6>
        <div class="fs-3 fw-bold">{{ prodotti_rimossi_mese or 0 }}</div>
      </div>
    </div>
  </div>

  <!-- Grafico -->
  <div class="card mb-4 bg-secondary text-white shadow-sm rounded-3">
    <div class="card-body">
      <h5 class="card-title mb-4">Andamento Fatturato (Ultimi 12 mesi)</h5>
      <canvas id="fatturatoChart" height="150"></canvas>
    </div>
  </div>
</div>

<!-- Offcanvas Notifiche -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifiche" aria-labelledby="offcanvasNotificheLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasNotificheLabel">Centro Notifiche</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    {% if notifiche %}
      <ul class="list-group list-group-flush">
        {% for notifica in notifiche %}
          <li id="notifica-{{ loop.index }}" class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
              <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#modalNotifica{{ loop.index }}">
                <div class="fw-bold">{{ notifica.titolo }}</div>
                <small class="text-muted">{{ notifica.descrizione }}</small>
              </a>
            </div>
            <span class="badge bg-{{ notifica.tipo or 'primary' }} rounded-pill">{{ notifica.data.strftime("%d/%m/%Y") }}</span>
            <button type="button" class="btn-close ms-2" aria-label="Rimuovi" onclick="document.getElementById('notifica-{{ loop.index }}').remove();"></button>
          </li>

          <!-- Modal Dettaglio Notifica -->
          <div class="modal fade" id="modalNotifica{{ loop.index }}" tabindex="-1" aria-labelledby="modalNotificaLabel{{ loop.index }}">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalNotificaLabel{{ loop.index }}">{{ notifica.titolo }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start">
                  <p>{{ notifica.descrizione }}</p>

                  {% if notifica.tipo == 'inattivi' %}
                    <h6>Clienti Inattivi</h6>
                    <ul class="list-group">
                      {% for cliente in notifica.clienti %}
                        <li class="list-group-item">{{ cliente.nome }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <h6>Clienti da Aggiornare</h6>
                    <ul class="list-group">
                      {% for cliente in notifica.clienti_attivi %}
                        <li class="list-group-item"><strong>{{ cliente.nome }}</strong> - Attivo</li>
                      {% endfor %}
                      {% for cliente in notifica.clienti_bloccati %}
                        <li class="list-group-item text-danger"><strong>{{ cliente.nome }}</strong> - Bloccato</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Nessuna notifica disponibile.</p>
    {% endif %}
  </div>
</div>

<!-- Grafico Chart.js rimane invariato -->
{% if fatturato_mensile is defined %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
    const fatturatoMensileRaw = {
        {% for mese, valore in fatturato_mensile.items() %}
        "{{ mese }}": {{ valore }},
        {% endfor %}
    };

    const mesiOrdinati = Object.keys(fatturatoMensileRaw).sort((a, b) => {
        const [annoA, meseA] = a.split('-').map(Number);
        const [annoB, meseB] = b.split('-').map(Number);
        return annoA !== annoB ? annoA - annoB : meseA - meseB;
    });

    const mesiNomi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    const labels = mesiOrdinati.map(m => {
        const [anno, mese] = m.split('-');
        return mesiNomi[parseInt(mese, 10) - 1] + " '" + anno.slice(2);
    });
    const valori = mesiOrdinati.map(m => fatturatoMensileRaw[m]);

    const ctx = document.getElementById('fatturatoChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Fatturato (€)', data: valori, backgroundColor: 'rgba(74,144,226,0.8)', borderRadius: 5, borderSkipped: false }] },
        options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a2638', titleColor: '#4a90e2', bodyColor: '#cfd8e6', cornerRadius: 6, padding: 8, displayColors: false } },
            scales: { x: { grid: { display: false }, ticks: { color: '#a0a8b7', font: { weight: '600' } } }, y: { beginAtZero: true, grid: { color: 'rgba(160,168,183,0.2)' }, ticks: { color: '#a0a8b7' } } }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
