{% extends "01_base.html" %}

{% block title %}Dashboard - Gestionale Horeca{% endblock %}

{% block styles %}
{{ super() }}
<style>
body { background: #0f172a; color: #fff; }

.dashboard-header {
  background: linear-gradient(135deg, #0d6efd 0%, #2a5bd7 100%);
  color: #fff;
  border-radius: 1rem;
  padding: 3rem 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.metric-card {
  border: none;
  transition: all 0.25s ease;
  background: #1e293b;
  border-radius: 1rem !important;
  height: 100%;
  color: #fff;
  cursor: pointer;
}
.metric-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}
.metric-card h6 { font-size: 0.95rem; color: #a0a8b7; }

.modal-body {
  background: #1e293b;
  color: #fff;
}
.modal-header, .modal-footer {
  border-color: rgba(255,255,255,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Header -->
  <div class="dashboard-header text-center mb-5 position-relative">
    <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3"
            data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifiche">
      <i class="bi bi-bell-fill fs-4 text-primary"></i>
      {% set not_unread = notifiche|selectattr('letto', 'equalto', False)|list %}
      {% if not_unread|length > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifica-badge">
        {{ not_unread|length }}
      </span>
      {% endif %}
    </button>
    <h1 class="display-5 fw-bold mb-2">Bentornato, Leonardo ðŸ‘‹</h1>
    <p class="lead mb-0 text-white">Gestisci in un colpo dâ€™occhio clienti, prodotti e fatturato.</p>
  </div>

  <!-- Quick Links -->
  <div class="row quick-links justify-content-center g-4 mb-5">
    <div class="col-12 col-md-3">
      <a href="{{ url_for('clienti') }}" class="btn btn-outline-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-clienti">
        <i class="bi bi-people-fill fs-3"></i> <span class="fw-semibold">Clienti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('prodotti') }}" class="btn btn-outline-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-prodotti">
        <i class="bi bi-box-seam fs-3"></i> <span class="fw-semibold">Prodotti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('fatturato') }}" class="btn btn-outline-warning btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-fatturato text-warning fw-semibold">
        <i class="bi bi-cash-stack fs-3 text-warning"></i> <span>Fatturato</span>
      </a>
    </div>
  </div>

  <!-- Metriche con modali -->
  <div class="row g-4 mb-5">
    <!-- Clienti Nuovi -->
    <div class="col-6 col-md-3">
      <div class="card metric-card text-center p-3 h-100" data-bs-toggle="modal" data-bs-target="#modalClientiNuovi">
        <h6>Clienti Nuovi (30gg)</h6>
        <div class="fs-3 fw-bold text-success">{{ clienti_nuovi or 0 }}</div>
      </div>
    </div>

    <!-- Clienti Bloccati -->
    <div class="col-6 col-md-3">
      <div class="card metric-card text-center p-3 h-100" data-bs-toggle="modal" data-bs-target="#modalClientiBloccati">
        <h6>Clienti Bloccati</h6>
        <div class="fs-3 fw-bold text-danger">{{ clienti_bloccati or 0 }}</div>
      </div>
    </div>

    <!-- Clienti Inattivi -->
    <div class="col-6 col-md-3">
      <div class="card metric-card text-center p-3 h-100" data-bs-toggle="modal" data-bs-target="#modalClientiInattivi">
        <h6>Clienti Inattivi</h6>
        <div class="fs-3 fw-bold text-secondary">{{ clienti_inattivi or 0 }}</div>
      </div>
    </div>

    <!-- Variazione Fatturato -->
    <div class="col-6 col-md-3">
      <div class="card metric-card text-center p-3 h-100">
        <h6>Variazione Fatturato</h6>
        {% if variazione_fatturato is not none %}
        <div class="fs-3 fw-bold {{ 'text-success' if variazione_fatturato > 0 else 'text-danger' }}">
          {{ "%.2f"|format(variazione_fatturato) }}%
          {% if variazione_fatturato > 0 %}<i class="bi bi-arrow-up"></i>{% elif variazione_fatturato < 0 %}<i class="bi bi-arrow-down"></i>{% endif %}
        </div>
        {% else %}
        <div class="fs-3 fw-bold text-light">--</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grafici -->
  <div class="row g-4 mb-5">
    <div class="col-lg-8">
      <div class="card chart-card">
        <div class="card-body">
          <h5 class="card-title mb-3 fw-semibold">
            <i class="bi bi-graph-up me-2 text-info"></i> Andamento Fatturato Mensile
          </h5>
          <canvas id="fatturatoChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card chart-card">
        <div class="card-body">
          <h5 class="card-title mb-3 fw-semibold">
            <i class="bi bi-pie-chart me-2 text-warning"></i> Fatturato per Zona
          </h5>
          <canvas id="fatturatoZonaChart"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- ==================== MODALI DETTAGLIO CLIENTI ==================== -->
<!-- Clienti Nuovi -->
<div class="modal fade" id="modalClientiNuovi" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Clienti Nuovi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if clienti_nuovi_dettaglio %}
          <ul class="list-group list-group-flush">
            {% for c in clienti_nuovi_dettaglio %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ c.nome }}
              <span class="badge bg-success rounded-pill">{{ c.data_registrazione.strftime('%d/%m/%Y') }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-center text-muted">Nessun cliente nuovo in questo periodo.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Clienti Bloccati -->
<div class="modal fade" id="modalClientiBloccati" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Clienti Bloccati</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if clienti_bloccati_dettaglio %}
          <ul class="list-group list-group-flush">
            {% for c in clienti_bloccati_dettaglio %}
            <li class="list-group-item">{{ c.nome }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-center text-muted">Nessun cliente bloccato.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Clienti Inattivi -->
<div class="modal fade" id="modalClientiInattivi" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Clienti Inattivi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if clienti_inattivi_dettaglio %}
          <ul class="list-group list-group-flush">
            {% for c in clienti_inattivi_dettaglio %}
            <li class="list-group-item">{{ c.nome }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-center text-muted">Nessun cliente inattivo.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];

  const fatturatoMensile = {{ fatturato_mensile|tojson }};
  const mesi = Object.keys(fatturatoMensile).sort();
  const labels = mesi.map(m => {
    const [anno,mese] = m.split('-');
    return mesiNomi[parseInt(mese,10)-1]+" '"+anno.slice(2);
  });
  const valori = Object.values(fatturatoMensile);

  const ctx1 = document.getElementById('fatturatoChart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Fatturato (â‚¬)', data: valori, backgroundColor: 'rgba(74,144,226,0.8)', borderRadius: 8, borderSkipped: false }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ x:{ grid:{ display:false }, ticks:{ color:'#a0a8b7', font:{ weight:'600' } } }, y:{ beginAtZero:true, grid:{ color:'rgba(160,168,183,0.15)' }, ticks:{ color:'#a0a8b7' } } }
    }
  });

  const fatturatoZona = {{ fatturato_per_zona|default({})|tojson }};
  const ctx2 = document.getElementById('fatturatoZonaChart').getContext('2d');
  new Chart(ctx2, {
    type:'doughnut',
    data:{ labels:Object.keys(fatturatoZona), datasets:[{ data:Object.values(fatturatoZona), backgroundColor:['#4a90e2','#50e3c2','#f5a623','#e94e77','#7b61ff','#b8e986'], borderWidth:0 }] },
    options:{ plugins:{ legend:{ labels:{ color:'#a0a8b7', padding:15 } }, tooltip:{ backgroundColor:'#1a2638', titleColor:'#4a90e2', bodyColor:'#cfd8e6', displayColors:false } }, cutout:'70%' }
  });
})();
</script>
{% endblock %}
