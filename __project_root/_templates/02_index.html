{% extends "01_base.html" %}

{% block title %}Dashboard - Gestionale Horeca{% endblock %}

{% block styles %}
{{ super() }}
<style>
  body {
    background: #f6f8fa;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #0d6efd 0%, #2a5bd7 100%);
    color: #fff;
    border-radius: 1rem;
    padding: 3rem 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }

  .dashboard-header h1 {
    font-weight: 700;
  }

  .metric-card {
    border: none;
    transition: all 0.25s ease;
    background: #fff;
    border-radius: 1rem !important;
  }

  .metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  }

  .metric-card h6 {
    font-size: 0.95rem;
    color: #6c757d;
  }

  .offcanvas {
    border-left: 2px solid #0d6efd;
  }

  .chart-card {
    border-radius: 1rem;
    background: #fff;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  .chart-card h5 {
    font-weight: 600;
    color: #000;
  }

  .notification-badge {
    background: #ff3b3b;
    font-size: 0.75rem;
  }

  .bi {
    vertical-align: middle;
  }

  /* --- Quick Links Moderni --- */
  .link-card {
    transition: all 0.25s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }

  .link-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  }

  /* Clienti (blu) */
  .link-clienti:hover {
    background-color: #0d6efd;
    color: #fff !important;
    border-color: #0d6efd;
  }

  /* Prodotti (verde) */
  .link-prodotti:hover {
    background-color: #198754;
    color: #fff !important;
    border-color: #198754;
  }

  /* Fatturato (giallo) */
  .link-fatturato:hover {
    background-color: #ffc107;
    color: #212529 !important;
    border-color: #ffc107;
  }

  /* Icone animate */
  .link-card i {
    transition: transform 0.2s ease;
  }

  .link-card:hover i {
    transform: scale(1.15);
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Header -->
  <div class="dashboard-header text-center mb-5 position-relative">
    <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3"
            data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifiche">
      <i class="bi bi-bell-fill fs-4 text-primary"></i>
      {% set not_unread = notifiche|selectattr('letto', 'equalto', False)|list %}
      {% if not_unread|length > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill notification-badge"
            id="notifica-badge">
        {{ not_unread|length }}
      </span>
      {% endif %}
    </button>

    <h1 class="display-5 fw-bold mb-2">Bentornato, Leonardo ðŸ‘‹</h1>
    <p class="lead mb-0 text-white">Gestisci in un colpo dâ€™occhio clienti, prodotti e fatturato.</p>
  </div>

  <!-- Quick links -->
  <div class="row quick-links justify-content-center g-4 mb-5">
    <div class="col-12 col-md-3">
      <a href="{{ url_for('clienti') }}" 
         class="btn btn-outline-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-clienti">
        <i class="bi bi-people-fill fs-3"></i> 
        <span class="fw-semibold">Clienti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('prodotti') }}" 
         class="btn btn-outline-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-prodotti">
        <i class="bi bi-box-seam fs-3"></i> 
        <span class="fw-semibold">Prodotti</span>
      </a>
    </div>
    <div class="col-12 col-md-3">
      <a href="{{ url_for('fatturato') }}" 
         class="btn btn-outline-warning btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-fatturato text-warning fw-semibold">
        <i class="bi bi-cash-stack fs-3 text-warning"></i> 
        <span>Fatturato</span>
      </a>
    </div>
  </div>

  <!-- Include metriche -->
  <div class="row g-4 mb-5">
    {% include "03_metriche.html" %}
  </div>

  <!-- Grafico -->
  <div class="card chart-card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">
          <i class="bi bi-graph-up-arrow me-2 text-primary"></i> Andamento Fatturato (12 mesi)
        </h5>
      </div>
      <canvas id="fatturatoChart" height="150"></canvas>
    </div>
  </div>

</div>

<!-- Offcanvas Notifiche -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifiche">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Centro Notifiche</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    {% if notifiche %}
      <ul class="list-group list-group-flush" id="lista-notifiche">
        {% for notifica in notifiche %}
          <li class="list-group-item d-flex justify-content-between align-items-start" id="notifica-{{ notifica.id }}">
            <div class="me-auto">
              <strong>{{ notifica.titolo }}</strong>
              <div class="small text-muted">{{ notifica.descrizione }}</div>
            </div>
            <span class="badge bg-{{ notifica.tipo or 'primary' }} rounded-pill">
              {{ notifica.data.strftime("%d/%m/%Y") }}
            </span>
            <button type="button" class="btn-close ms-2" onclick="chiudiNotifica({{ notifica.id }});"></button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Nessuna notifica disponibile.</p>
    {% endif %}
  </div>
</div>

<!-- JS notifiche -->
<script>
function chiudiNotifica(id) {
  const el = document.getElementById('notifica-' + id);
  if (el) el.remove();
  const badge = document.getElementById('notifica-badge');
  if (badge) {
    let c = parseInt(badge.textContent);
    if (--c > 0) badge.textContent = c;
    else badge.remove();
  }
  const mese = new Date().toISOString().slice(0,7);
  let chiuse = JSON.parse(localStorage.getItem('notificheChiuse') || '{}');
  chiuse[mese] = chiuse[mese] || [];
  chiuse[mese].push(id);
  localStorage.setItem('notificheChiuse', JSON.stringify(chiuse));
}

document.addEventListener('DOMContentLoaded', () => {
  const mese = new Date().toISOString().slice(0,7);
  const chiuse = JSON.parse(localStorage.getItem('notificheChiuse') || '{}')[mese] || [];
  chiuse.forEach(id => {
    const el = document.getElementById('notifica-' + id);
    if (el) el.remove();
  });
});
</script>

{% if fatturato_mensile is defined %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const dati = {
    {% for mese, valore in fatturato_mensile.items() %}
      "{{ mese }}": {{ valore }},
    {% endfor %}
  };
  const mesi = Object.keys(dati).sort((a,b)=>a.localeCompare(b));
  const labels = mesi.map(m => {
    const [anno, mese] = m.split('-');
    const mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    return mesiNomi[parseInt(mese,10)-1] + " '" + anno.slice(2);
  });
  const valori = mesi.map(m=>dati[m]);

  const ctx = document.getElementById('fatturatoChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { 
      labels, 
      datasets: [{ 
        label: 'Fatturato (â‚¬)',
        data: valori,
        fill: true,
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13,110,253,0.15)',
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#0d6efd'
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { 
        x: { grid: { display: false } },
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
      }
    }
  });
})();
</script>
{% endif %}
{% endblock %}
