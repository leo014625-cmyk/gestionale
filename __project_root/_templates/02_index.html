{% extends "01_base.html" %}

{% block title %}Dashboard - Gestionale Horeca{% endblock %}

{% block styles %}
{{ super() }}
<style>
body { background: #0f172a; color: #fff; }

.dashboard-header {
Â  background: linear-gradient(135deg, #0d6efd 0%, #2a5bd7 100%);
Â  color: #fff;
Â  border-radius: 1rem;
Â  padding: 3rem 2rem;
Â  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

/* === Metriche === */
.metric-card {
Â  border: none;
Â  transition: all 0.25s ease;
Â  background: #1e293b;
Â  border-radius: 1rem !important;
Â  height: 100%;
Â  color: #fff;
}
.metric-card:hover {
Â  transform: translateY(-5px);
Â  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}
.metric-card h6 { font-size: 0.95rem; color: #a0a8b7; }

/* === Grafici in stile "fatturato.html" === */
.chart-card {
Â  border-radius: 1rem;
Â  background: #1e293b;
Â  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
Â  height: 420px;
Â  display: flex;
Â  flex-direction: column;
Â  color: #fff;
}
.chart-card .card-body {
Â  flex: 1;
Â  display: flex;
Â  flex-direction: column;
Â  justify-content: space-between;
Â  padding: 1.5rem;
}
.chart-card canvas {
Â  flex-grow: 1;
Â  height: 280px !important;
Â  width: 100% !important;
}

/* === Link cards === */
.link-card { transition: all 0.25s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
.link-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
.link-clienti:hover { background-color: #0d6efd; color: #fff !important; border-color: #0d6efd; }
.link-prodotti:hover { background-color: #198754; color: #fff !important; border-color: #198754; }
.link-fatturato:hover { background-color: #ffc107; color: #212529 !important; border-color: #ffc107; }
.link-card i { transition: transform 0.2s ease; }
.link-card:hover i { transform: scale(1.15); }

.list-group-item { border-radius: 0.5rem; margin-bottom: 0.3rem; }

/* Stile per modali scuri */
.modal-content { background-color: #1e293b; color: #fff; border: 1px solid #334155; border-radius: 1rem; }
.modal-header { border-bottom: 1px solid #334155; }
.modal-footer { border-top: 1px solid #334155; }
.table-dark { --bs-table-bg: #1e293b; --bs-table-striped-bg: #334155; --bs-table-hover-bg: #475569; }

/* Override per metriche */
.metric-card .text-dark { color: #fff !important; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">

Â  <!-- Header -->
Â  <div class="dashboard-header text-center mb-5 position-relative">
Â  Â  <button type="button" class="btn btn-light position-absolute top-0 end-0 m-3"
Â  Â  Â  Â  Â  Â  data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifiche">
Â  Â  Â  <i class="bi bi-bell-fill fs-4 text-primary"></i>
Â  Â  Â  {% set not_unread = notifiche|selectattr('letto', 'equalto', False)|list %}
Â  Â  Â  {% if not_unread|length > 0 %}
Â  Â  Â  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifica-badge">
Â  Â  Â  Â  {{ not_unread|length }}
Â  Â  Â  </span>
Â  Â  Â  {% endif %}
Â  Â  </button>
Â  Â  <h1 class="display-5 fw-bold mb-2">Bentornato, Leonardo ðŸ‘‹</h1>
Â  Â  <p class="lead mb-0 text-white">Gestisci in un colpo dâ€™occhio clienti, prodotti e fatturato.</p>
Â  </div>

Â  <!-- Quick Links -->
Â  <div class="row quick-links justify-content-center g-4 mb-5">
Â  Â  <div class="col-12 col-md-3">
Â  Â  Â  <a href="{{ url_for('clienti') }}" class="btn btn-outline-primary btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-clienti">
Â  Â  Â  Â  <i class="bi bi-people-fill fs-3"></i> <span class="fw-semibold">Clienti</span>
Â  Â  Â  </a>
Â  Â  </div>
Â  Â  <div class="col-12 col-md-3">
Â  Â  Â  <a href="{{ url_for('prodotti') }}" class="btn btn-outline-success btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-prodotti">
Â  Â  Â  Â  <i class="bi bi-box-seam fs-3"></i> <span class="fw-semibold">Prodotti</span>
Â  Â  Â  </a>
Â  Â  </div>
Â  Â  <div class="col-12 col-md-3">
Â  Â  Â  <a href="{{ url_for('fatturato') }}" class="btn btn-outline-warning btn-lg w-100 py-3 d-flex align-items-center justify-content-center gap-2 rounded-4 link-card link-fatturato text-warning fw-semibold">
Â  Â  Â  Â  <i class="bi bi-cash-stack fs-3 text-warning"></i> <span>Fatturato</span>
Â  Â  Â  </a>
Â  Â  </div>
Â  </div>

Â  <!-- Metriche con Modali Attivate -->
Â  <div class="row g-4 mb-5">
Â  Â  {% set metriche = [
Â  Â  Â  {'titolo': 'Variazione Fatturato', 'valore': variazione_fatturato, 'tipo': 'percent', 'modal': 'modalFatturato', 'classe': 'text-light'},
Â  Â  Â  {'titolo': 'Clienti Nuovi (30gg)', 'valore': clienti_nuovi|length if clienti_nuovi is iterable else clienti_nuovi, 'modal': 'modalClientiNuovi', 'classe': 'text-info'},
Â  Â  Â  {'titolo': 'Clienti Bloccati', 'valore': clienti_bloccati|length if clienti_bloccati is iterable else clienti_bloccati, 'modal': 'modalClientiBloccati', 'classe': 'text-danger'},
Â  Â  Â  {'titolo': 'Clienti Inattivi', 'valore': clienti_inattivi|length if clienti_inattivi is iterable else clienti_inattivi, 'modal': 'modalClientiInattivi', 'classe': 'text-secondary'},
Â  Â  Â  {'titolo': 'Prodotti Inseriti (30gg)', 'valore': prodotti_inseriti|length if prodotti_inseriti is iterable else prodotti_inseriti, 'modal': 'modalProdottiTotali', 'classe': 'text-success'},
Â  Â  Â  {'titolo': 'Prodotti Rimossi', 'valore': prodotti_rimossi|length if prodotti_rimossi is iterable else prodotti_rimossi, 'modal': 'modalProdottiRimossi', 'classe': 'text-warning'}
Â  Â  ] %}

Â  Â  {% for m in metriche %}
Â  Â  Â  <div class="col-6 col-md-3 col-lg-2">
Â  Â  Â  Â  <!-- Aggiunto data-bs-toggle e data-bs-target per attivare la modale al click -->
Â  Â  Â  Â  <div class="card metric-card text-center p-3 h-100" 
Â  Â  Â  Â  Â  Â  Â  Â  role="button" 
Â  Â  Â  Â  Â  Â  Â  Â  data-bs-toggle="modal" 
Â  Â  Â  Â  Â  Â  Â  Â  data-bs-target="#{{ m.modal }}">
Â  Â  Â  Â  Â  <h6 class="text-muted">{{ m.titolo }}</h6>
Â  Â  Â  Â  Â  {% if m.tipo == 'percent' and m.valore is not none %}
Â  Â  Â  Â  Â  Â  <div class="fs-3 fw-bold {{ 'text-success' if m.valore > 0 else 'text-danger' }}">
Â  Â  Â  Â  Â  Â  Â  {{ "%.2f"|format(m.valore) }}%
Â  Â  Â  Â  Â  Â  Â  {% if m.valore > 0 %}<i class="bi bi-arrow-up"></i>{% elif m.valore < 0 %}<i class="bi bi-arrow-down"></i>{% endif %}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  <div class="fs-3 fw-bold {{ m.classe }}">{{ m.valore or 0 }}</div>
Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  {% endfor %}
Â  </div>

Â  <!-- Grafici -->
Â  <div class="row g-4 mb-5">
Â  Â  <div class="col-lg-8">
Â  Â  Â  <div class="card chart-card">
Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  <h5 class="card-title mb-3 fw-semibold">
Â  Â  Â  Â  Â  Â  <i class="bi bi-graph-up me-2 text-info"></i> Andamento Fatturato Mensile
Â  Â  Â  Â  Â  </h5>
Â  Â  Â  Â  Â  <canvas id="fatturatoChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="col-lg-4">
Â  Â  Â  <div class="card chart-card">
Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  <h5 class="card-title mb-3 fw-semibold">
Â  Â  Â  Â  Â  Â  <i class="bi bi-pie-chart me-2 text-warning"></i> Fatturato per Zona
Â  Â  Â  Â  Â  </h5>
Â  Â  Â  Â  Â  <canvas id="fatturatoZonaChart"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

</div>

<!-- INIZIO MACRO PER MODAL (necessarie per generare le modali) -->
{% macro client_modal(id, title, list_data, date_label, type_icon) %}
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-labelledby="{{ id }}Label" aria-hidden="true">
Â  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h5 class="modal-title" id="{{ id }}Label"><i class="{{ type_icon }} me-2"></i> {{ title }} ({{ list_data|length }})</h5>
Â  Â  Â  Â  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-body p-0">
Â  Â  Â  Â  {% if list_data|length > 0 %}
Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  <table class="table table-dark table-striped table-hover align-middle mb-0">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">Nome Cliente</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">Zona</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">{{ date_label }}</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  {% for item in list_data %}
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.nome }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.zona }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.data_stato }}</td>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  <p class="p-4 text-center text-muted">Nessun dato da visualizzare.</p>
Â  Â  Â  Â  {% endif %}
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">Chiudi</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>
{% endmacro %}

{% macro product_modal(id, title, list_data, date_label, type_icon) %}
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-labelledby="{{ id }}Label" aria-hidden="true">
Â  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h5 class="modal-title" id="{{ id }}Label"><i class="{{ type_icon }} me-2"></i> {{ title }} ({{ list_data|length }})</h5>
Â  Â  Â  Â  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-body p-0">
Â  Â  Â  Â  {% if list_data|length > 0 %}
Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  <table class="table table-dark table-striped table-hover align-middle mb-0">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">Cliente</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">Prodotto</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col">{{ date_label }}</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  {% for item in list_data %}
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.cliente }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.prodotto }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.data_operazione }}</td>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  <p class="p-4 text-center text-muted">Nessun dato da visualizzare.</p>
Â  Â  Â  Â  {% endif %}
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">Chiudi</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  </div>
</div>
{% endmacro %}
<!-- FINE MACRO PER MODAL -->

<!-- CHIAMATE ALLE MACRO PER GENERARE LE MODALI NECESSARIE -->
<!-- NB: Queste modali sono rese solo se i dati (clienti_nuovi, clienti_bloccati, etc.) sono definiti nel contesto. -->
{{ client_modal('modalClientiNuovi', 'Dettaglio Clienti Nuovi (30 giorni)', clienti_nuovi, 'Data Registrazione', 'bi bi-person-check-fill text-info') }}
{{ client_modal('modalClientiBloccati', 'Dettaglio Clienti Bloccati', clienti_bloccati, 'Ultimo Fatturato', 'bi bi-exclamation-triangle-fill text-danger') }}
{{ client_modal('modalClientiInattivi', 'Dettaglio Clienti Inattivi', clienti_inattivi, 'Ultimo Fatturato', 'bi bi-person-x-fill text-secondary') }}
{{ product_modal('modalProdottiTotali', 'Prodotti Inseriti (30 giorni)', prodotti_inseriti, 'Data Inserimento', 'bi bi-box-arrow-in-right text-success') }}
{{ product_modal('modalProdottiRimossi', 'Prodotti Rimossi', prodotti_rimossi, 'Data Rimozione', 'bi bi-box-arrow-up-left text-warning') }}
<!-- Modale fittizia per Variazione Fatturato (non ha una lista di clienti associata, ma serve per completezza) -->
<div class="modal fade" id="modalFatturato" tabindex="-1" aria-labelledby="modalFatturatoLabel" aria-hidden="true">
Â  <div class="modal-dialog modal-dialog-centered">
Â  Â  <div class="modal-content">
Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  <h5 class="modal-title" id="modalFatturatoLabel">Variazione Fatturato</h5>
Â  Â  Â  Â  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-body text-center">
Â  Â  Â  Â  <p>Questa metrica mostra la variazione percentuale del fatturato rispetto al mese precedente.</p>
Â  Â  Â  Â  <h3 class="fw-bold {{ 'text-success' if variazione_fatturato > 0 else 'text-danger' }}">
Â  Â  Â  Â  Â  {{ "%.2f"|format(variazione_fatturato) }}%
Â  Â  Â  Â  </h3>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<!-- Grafici Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if fatturato_mensile is defined %}
<script>
(() => {
Â  // Funzione per parsare JSON in modo sicuro
Â  const safeParseJson = (jsonString, defaultValue = {}) => {
Â  Â  try {
Â  Â  Â  // Rimuove eventuali doppie virgolette esterne che potrebbero essere aggiunte dall'ambiente
Â  Â  Â  const cleanedString = jsonString.trim().replace(/^"|"$/g, '');
Â  Â  Â  return JSON.parse(cleanedString);
Â  Â  } catch (e) {
Â  Â  Â  console.error("Errore nel parsing JSON:", e);
Â  Â  Â  return defaultValue;
Â  Â  }
Â  };
Â  
Â  const fatturatoMensile = safeParseJson('{{ fatturato_mensile|tojson | safe }}');
Â  const mesi = Object.keys(fatturatoMensile).sort();
Â  const mesiNomi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
Â  const labels = mesi.map(m => {
Â  Â  const [anno, mese] = m.split('-');
Â  Â  return mesiNomi[parseInt(mese,10)-1] + " '" + anno.slice(2);
Â  });
Â  const valori = Object.values(fatturatoMensile);

Â  if (document.getElementById('fatturatoChart')) {
Â  Â  const ctx1 = document.getElementById('fatturatoChart').getContext('2d');
Â  Â  new Chart(ctx1, {
Â  Â  Â  type: 'bar',
Â  Â  Â  data: {
Â  Â  Â  Â  labels,
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: 'Fatturato (â‚¬)',
Â  Â  Â  Â  Â  data: valori,
Â  Â  Â  Â  Â  backgroundColor: 'rgba(74,144,226,0.8)',
Â  Â  Â  Â  Â  borderRadius: 8,
Â  Â  Â  Â  Â  borderSkipped: false
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  plugins: { legend: { display: false } },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  x: { grid: { display: false }, ticks: { color: '#a0a8b7', font: { weight: '600' } } },
Â  Â  Â  Â  Â  y: { beginAtZero: true, grid: { color: 'rgba(160,168,183,0.15)' }, ticks: { color: '#a0a8b7' } }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }

Â  const fatturatoZona = safeParseJson('{{ fatturato_per_zona|default({})|tojson | safe }}');

Â  if (document.getElementById('fatturatoZonaChart')) {
Â  Â  const ctx2 = document.getElementById('fatturatoZonaChart').getContext('2d');
Â  Â  new Chart(ctx2, {
Â  Â  Â  type: 'doughnut',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: Object.keys(fatturatoZona),
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  data: Object.values(fatturatoZona),
Â  Â  Â  Â  Â  backgroundColor: ['#4a90e2','#50e3c2','#f5a623','#e94e77','#7b61ff','#b8e986'],
Â  Â  Â  Â  Â  borderWidth: 0
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: { labels: { color: '#a0a8b7', padding: 15 } },
Â  Â  Â  Â  Â  tooltip: { backgroundColor: '#1a2638', titleColor: '#4a90e2', bodyColor: '#cfd8e6', displayColors: false }
Â  Â  Â  Â  },
Â  Â  Â  Â  cutout: '70%'
Â  Â  Â  }
Â  Â  });
Â  }
})();
</script>
{% endif %}
{% endblock %}
