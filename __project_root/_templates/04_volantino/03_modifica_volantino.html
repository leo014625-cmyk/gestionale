{% extends "01_base.html" %}
{% block content %}

<div class="container mt-4">
    <h2 class="mb-4">‚úèÔ∏è Modifica Volantino</h2>

    <!-- Modifica dati base -->
    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <!-- Titolo -->
        <div class="mb-3">
            <label for="titolo" class="form-label">üìù Titolo Volantino</label>
            <input type="text" class="form-control" id="titolo" name="titolo"
                   value="{{ volantino['titolo'] }}" placeholder="Inserisci un titolo" required>
            <div class="invalid-feedback">Inserisci un titolo valido.</div>
        </div>

        <!-- Sfondo -->
        <div class="mb-3">
            <label for="sfondo" class="form-label">üñº Sfondo Volantino</label><br>
            {% if volantino['sfondo'] %}
                <img src="{{ url_for('serve_volantino_file', filename=volantino['sfondo']) }}"
                     alt="Sfondo attuale"
                     class="img-thumbnail mb-2"
                     style="max-height: 200px;">
            {% endif %}
            <input type="file" class="form-control" id="sfondo" name="sfondo" accept="image/*">
            <div class="form-text">Lascia vuoto se non vuoi cambiare lo sfondo.</div>
        </div>

        <!-- Pulsanti -->
        <div class="d-flex gap-2 mb-4">
            <button type="submit" class="btn btn-primary">üíæ Salva Modifiche</button>
            <a href="{{ url_for('lista_volantini') }}" class="btn btn-secondary">‚Ü© Torna alla Lista</a>
            <a href="{{ url_for('editor_volantino', volantino_id=volantino['id']) }}"
               class="btn btn-success">üñå Apri Editor</a>
            <a href="{{ url_for('visualizza_volantino', volantino_id=volantino['id']) }}"
               class="btn btn-info">üëÅ Anteprima</a>
        </div>
    </form>

    <hr class="my-4">

    <!-- Gestione prodotti -->
    <h4>üõí Prodotti nel Volantino</h4>

    <div class="mb-3 d-flex gap-2">
        <a href="{{ url_for('aggiungi_prodotto_volantino', volantino_id=volantino['id']) }}" 
           class="btn btn-success">‚ûï Aggiungi Prodotto Manualmente</a>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#prodottiConsigliatiModal">
            üí° Prodotti Consigliati
        </button>
    </div>

    <!-- Griglia prodotti 3x3 -->
    <div id="grigliaProdotti" class="row row-cols-3 g-3">
        {% set max_slots = 9 %}
        {% for i in range(max_slots) %}
            {% set prodotto = prodotti[i] if i < prodotti|length else None %}
            <div class="col">
                <div class="card shadow-sm text-center h-100" style="padding:3px; border:1px solid #ddd;">
                    <div style="flex:1; display:flex; align-items:center; justify-content:center; height:100px; overflow:hidden;">
                        {% if prodotto and prodotto['immagine'] %}
                            <img src="{{ url_for('serve_prodotto_file', filename=prodotto['immagine']) }}"
                                 alt="{{ prodotto['nome'] }}"
                                 style="max-width:130px; max-height:100px; object-fit:contain;">
                        {% else %}
                            <img src="{{ url_for('static', filename='no-image.png') }}"
                                 alt="Vuoto"
                                 style="max-width:130px; max-height:100px; object-fit:contain; opacity:0.4;">
                        {% endif %}
                    </div>
                    <div style="text-align:center; font-size:12px; margin-top:3px; color:black; min-height:18px;">
                        {% if prodotto %}{{ prodotto['nome'] }}{% else %}<em>Vuoto</em>{% endif %}
                    </div>
                    <div style="text-align:center; font-size:14px; font-weight:bold; color:{% if prodotto %}{{ prodotto['colore_prezzo']|default('red') }}{% else %}gray{% endif %}; margin-top:2px;">
                        {% if prodotto %}‚Ç¨ {{ "%.2f"|format(prodotto['prezzo']) }}{% endif %}
                    </div>
                    <div class="d-flex justify-content-center gap-2 mt-1">
                        {% if prodotto %}
                        <a href="{{ url_for('modifica_prodotto_volantino', prodotto_id=prodotto['id']) }}"
                           class="btn btn-warning btn-sm" title="Modifica">‚úèÔ∏è</a>
                        <button type="button" class="btn btn-danger btn-sm rimuoviProdotto" title="Rimuovi">üóë</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- MODAL PRODOTTI CONSIGLIATI -->
<div class="modal fade" id="prodottiConsigliatiModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üí° Prodotti Consigliati</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <input type="text" id="searchProdottiConsigliati" class="form-control"
                 placeholder="üîç Cerca prodotto per nome...">
        </div>

        {% if prodotti_precedenti %}
            <div class="row row-cols-2 row-cols-md-3 g-3" id="listaProdottiConsigliati">
                {% for p in prodotti_precedenti %}
                    <div class="col prodotto-consigliato" data-nome="{{ p['nome']|lower }}">
                        <div class="card h-100 text-center p-2 shadow-sm">
                            <img src="{{ url_for('serve_prodotto_file', filename=p['immagine']) }}"
                                 class="img-fluid mb-2"
                                 style="max-height:100px; object-fit:contain;">
                            <div class="fw-bold">{{ p['nome'] }}</div>
                            <input type="number" class="form-control mt-1"
                                   placeholder="Prezzo ‚Ç¨"
                                   value="{{ "%.2f"|format(p['prezzo_default']) }}"
                                   data-id="{{ p['id'] }}">
                            <button type="button"
                                    class="btn btn-primary btn-sm mt-2 w-100 aggiungiConsigliato"
                                    data-id="{{ p['id'] }}"
                                    data-nome="{{ p['nome'] }}"
                                    data-immagine="{{ p['immagine'] }}">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-muted">Nessun prodotto consigliato disponibile.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchProdottiConsigliati');
    const prodottiCards = document.querySelectorAll('.prodotto-consigliato');

    // Ricerca
    searchInput?.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        prodottiCards.forEach(card => {
            card.style.display = card.dataset.nome.includes(query) ? '' : 'none';
        });
    });

    // Aggiungi prodotto consigliato
    document.querySelectorAll('.aggiungiConsigliato').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const nome = btn.dataset.nome;
            const img = btn.dataset.immagine;
            const prezzo = parseFloat(btn.previousElementSibling.value).toFixed(2);

            const res = await fetch(`/volantini/{{ volantino['id'] }}/aggiungi_consigliato`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id, prezzo })
            });
            const data = await res.json();
            if (data.status !== "ok") { alert("‚ùå " + data.msg); return; }

            const slots = Array.from(document.querySelectorAll('#grigliaProdotti .col'));
            const slot = slots.find(c => c.querySelector('img[alt="Vuoto"]'));
            if (!slot) { alert('‚ùå Tutti i 9 slot sono occupati!'); return; }

            slot.querySelector('img').src = `/uploads/volantino_prodotti/${img}`;
            slot.querySelector('img').alt = nome;
            slot.querySelector('div:nth-child(2)').textContent = nome;
            slot.querySelector('div:nth-child(3)').textContent = `‚Ç¨ ${prezzo}`;
            const actionsDiv = slot.querySelector('.d-flex');
            actionsDiv.innerHTML = `
                <a href="/volantini/prodotto/modifica/${data.id}" class="btn btn-warning btn-sm" title="Modifica">‚úèÔ∏è</a>
                <button type="button" class="btn btn-danger btn-sm rimuoviProdotto" title="Rimuovi">üóë</button>
            `;
            actionsDiv.querySelector('button').addEventListener('click', () => location.reload());
        });
    });

    // Rimuovi prodotto manuale
    document.querySelectorAll('.rimuoviProdotto').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const slot = e.target.closest('.col');
            const link = slot.querySelector('a');
            if (!link) return;
            const id = link.href.split('/').pop();
            if (!confirm('Vuoi rimuovere questo prodotto?')) return;

            const res = await fetch(`/volantini/prodotto/elimina/${id}`, { method: 'POST' });
            const result = await res.json();
            if (result.status === "ok") {
                slot.querySelector('img').src = `/static/no-image.png`;
                slot.querySelector('img').alt = 'Vuoto';
                slot.querySelector('div:nth-child(2)').innerHTML = '<em>Vuoto</em>';
                slot.querySelector('div:nth-child(3)').textContent = '';
                slot.querySelector('.d-flex').innerHTML = '';
            } else alert('Errore: ' + result.msg);
        });
    });
});
</script>

{% endblock %}
