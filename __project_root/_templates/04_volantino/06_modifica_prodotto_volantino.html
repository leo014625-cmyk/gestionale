{% extends "01_base.html" %}

{% block title %}Modifica {{ prodotto['nome'] }} - Volantino{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm rounded-4 p-4">
        <h2 class="mb-4">‚úèÔ∏è Modifica Prodotto: 
            <span class="text-primary">{{ prodotto['nome'] }}</span>
        </h2>

        <div class="row g-4">
            <!-- FORM INPUTS -->
            <div class="col-lg-6">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome prodotto</label>
                        <input type="text" class="form-control" id="nome" name="nome"
                               value="{{ prodotto['nome'] }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="prezzo" class="form-label">Prezzo (‚Ç¨)</label>
                        <input type="number" class="form-control" id="prezzo" name="prezzo"
                               step="0.01" min="0" value="{{ prodotto['prezzo'] }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="immagine" class="form-label">Immagine prodotto</label>
                        <input type="file" class="form-control" id="immagine" name="immagine" accept="image/*">
                        <div class="form-text">
                            Seleziona un file solo se vuoi sostituire l'immagine.
                            Sar√† adattata automaticamente alla cella della griglia.
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="lascia_vuota" name="lascia_vuota"
                               {% if prodotto['lascia_vuota']|default(0) %}checked{% endif %}>
                        <label class="form-check-label" for="lascia_vuota">
                            üö´ Lascia la box vuota (invisibile ma con spazio occupato)
                        </label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">üíæ Salva modifiche</button>
                        <a href="{{ url_for('modifica_volantino', volantino_id=prodotto['volantino_id']) }}" 
                           class="btn btn-secondary flex-grow-1">‚Ü©Ô∏è Torna al volantino</a>
                    </div>
                </form>
            </div>

            <!-- PREVIEW GRIGLIA -->
            <div class="col-lg-6">
                <h5 class="mb-3">Anteprima Volantino</h5>
                <div id="previewGrid" class="d-grid gap-3" style="grid-template-columns: repeat(3, 1fr);">
                    
                    {% for p in volantino_prodotti %}
                    <div class="border rounded-3 p-2 text-center" style="width:200px; height:230px; background:#fff; 
                        {% if p['id'] == prodotto['id'] %}background:#e9f7ff;{% endif %}">
                        <img src="{{ url_for('static', filename='uploads/volantino_prodotti/' ~ p['immagine']) if p['immagine'] else 'https://via.placeholder.com/180x120?text=No+Image' }}"
                             style="max-width:180px; max-height:120px; object-fit:contain;" class="mb-2">
                        <div class="fw-semibold text-truncate" style="font-size:14px;">{{ p['nome'] }}</div>
                        <div class="text-danger fw-bold" style="font-size:18px;">
                            ‚Ç¨ {{ '%.2f'|format(p['prezzo']) if p['prezzo'] is not none else '0.00' }}
                        </div>
                    </div>
                    {% endfor %}

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const inputFile = document.getElementById("immagine");
    const inputNome = document.getElementById("nome");
    const inputPrezzo = document.getElementById("prezzo");

    // Seleziona il prodotto corrente nella preview
    const currentCard = document.querySelector("#previewGrid > div[style*='e9f7ff']"); 
    const previewImg = currentCard.querySelector("img");
    const previewNome = currentCard.querySelector("div.fw-semibold");
    const previewPrezzo = currentCard.querySelector("div.text-danger");

    inputFile.addEventListener("change", function() {
        const file = this.files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = function(e){
                previewImg.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    inputNome.addEventListener("input", function() {
        previewNome.textContent = this.value || "Nome prodotto";
    });

    inputPrezzo.addEventListener("input", function() {
        const val = parseFloat(this.value);
        previewPrezzo.textContent = "‚Ç¨ " + (isNaN(val) ? "0.00" : val.toFixed(2));
    });
});
</script>
{% endblock %}
