{% extends "01_base.html" %}
{% block content %}

<div class="container py-5">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <h2 class="fw-bold">ğŸ–Œ Editor Volantino - {{ volantino['titolo'] }}</h2>
      <a href="{{ url_for('visualizza_volantino', volantino_id=volantino['id']) }}" 
         class="btn btn-secondary d-flex align-items-center gap-2 rounded-4">
         â¬… Torna alla visualizzazione
      </a>
  </div>

  <!-- PULSANTI GLOBALI -->
  <div class="mb-4 d-flex gap-2 flex-wrap">
    <button id="salvaCanvas" class="btn btn-success d-flex align-items-center gap-2 rounded-4">ğŸ’¾ Salva Layout</button>
    <button id="resetCanvas" class="btn btn-warning d-flex align-items-center gap-2 rounded-4">ğŸ”„ Reset</button>
    <button id="downloadPng" class="btn btn-info d-flex align-items-center gap-2 rounded-4">ğŸ–¼ Scarica PNG</button>
    <button id="downloadPdf" class="btn btn-danger d-flex align-items-center gap-2 rounded-4">ğŸ“„ Scarica PDF</button>
  </div>

  <!-- CONTROLLI GRIGLIA -->
  <div class="row row-cols-1 row-cols-md-2 g-3 mb-4">
    <div>
      <label class="form-label fw-semibold">ğŸ” Zoom Griglia: <span id="zoomGridValue">100%</span></label>
      <input type="range" id="zoomGrid" class="form-range rounded-4" min="50" max="200" value="100">
    </div>
    <div>
      <label class="form-label fw-semibold">ğŸ“¦ Zoom Box Prodotto: <span id="zoomBoxValue">100%</span></label>
      <input type="range" id="zoomBox" class="form-range rounded-4" min="50" max="200" value="100">
    </div>
  </div>

  <!-- CANVAS -->
  <div class="editor-wrapper text-center border rounded-4 p-3 shadow-sm bg-light" style="overflow:auto;">
    <canvas id="volantinoCanvas"></canvas>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const canvas = new fabric.Canvas("volantinoCanvas", { preserveObjectStacking: true });
  canvas.setWidth(1000); canvas.setHeight(1400);

  // Sfondo
  {% if volantino['sfondo'] %}
  fabric.Image.fromURL("{{ url_for('static', filename='uploads/volantini/' ~ volantino['sfondo']) }}", function(img){
      img.scaleToWidth(canvas.getWidth());
      canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
  });
  {% else %}
  canvas.setBackgroundColor("#f9f9f9", canvas.renderAll.bind(canvas));
  {% endif %}

  const volantinoProdotti = [
    {% for p in volantino_prodotti %}
    {
      url: "{{ url_for('static', filename='uploads/volantino_prodotti/' ~ p['immagine']) if p['immagine'] else '' }}",
      nome: "{{ p['nome']|e }}",
      prezzo: "{{ '%.2f'|format(p['prezzo']) if p['prezzo'] is not none else '' }}",
      x: {{ p.get('pos_x', 0) }},
      y: {{ p.get('pos_y', 0) }},
      w: {{ p.get('width', 200) }},
      h: {{ p.get('height', 230) }},
      lasciaVuota: {{ 1 if p['lascia_vuota'] else 0 }}
    },
    {% endfor %}
  ];

  function creaBoxProdotto(p) {
    return new Promise(resolve => {
      const elements = [];
      const textHeight = 80;
      const imgHeight = p.h - textHeight;

      function aggiungiTesti() {
        const nomeText = new fabric.Textbox(p.nome||"", {
          fontSize:14, fontWeight:"bold", width:p.w-20, textAlign:"center",
          top:p.h-65, left:p.w/2, originX:"center", selectable:false, evented:false
        });
        const prezzoText = new fabric.Text(p.prezzo?"â‚¬ "+p.prezzo:"", {
          fontSize:22, fill:"red", fontWeight:"bold",
          top:p.h-30, left:p.w/2, originX:"center", textAlign:"center", selectable:false, evented:false
        });
        const line = new fabric.Line([5, p.h-5, p.w-5, p.h-5], { stroke:"#800020", strokeWidth:2, selectable:false, evented:false });

        elements.push(nomeText, prezzoText, line);
        const group = new fabric.Group(elements, {
          left: p.x, top: p.y, width: p.w, height: p.h,
          hasControls: true, hasBorders: true, lockRotation: true
        });
        resolve(group);
      }

      if(p.url && p.lasciaVuota!==1){
        fabric.Image.fromURL(p.url, function(img){
          const scale = Math.min((p.w-20)/img.width, imgHeight/img.height, 1);
          img.set({ scaleX:scale, scaleY:scale, left:(p.w-img.width*scale)/2, top:0, selectable:false, evented:false });
          elements.push(img);
          aggiungiTesti();
        }, { crossOrigin: "anonymous" });
      } else {
        const rect = new fabric.Rect({ left:0, top:0, width:p.w, height:p.h, fill:"transparent", stroke:"transparent", selectable:false });
        elements.push(rect);
        aggiungiTesti();
      }
    });
  }

  // Carica tutti i prodotti con maniglie per ridimensionamento
  Promise.all(volantinoProdotti.map(p=>creaBoxProdotto(p))).then(groups=>{
    groups.forEach(g=>{
      g.set({ selectable:true, hasControls:true, cornerSize:12 });
      canvas.add(g);
    });
    canvas.renderAll();
  });

  // ZOOM griglia
  document.getElementById("zoomGrid").addEventListener("input", e=>{
    const scale = e.target.value/100;
    canvas.getObjects().forEach(o=>{
      if(o.type==="group") o.scaleX = scale, o.scaleY = scale;
    });
    document.getElementById("zoomGridValue").textContent = e.target.value+"%";
    canvas.renderAll();
  });

  // ZOOM box prodotto
  document.getElementById("zoomBox").addEventListener("input", e=>{
    const scale = e.target.value/100;
    canvas.getObjects().forEach(o=>{
      if(o.type==="group") o.set({ scaleX:scale, scaleY:scale });
    });
    document.getElementById("zoomBoxValue").textContent = e.target.value+"%";
    canvas.renderAll();
  });

  // RESET
  document.getElementById("resetCanvas").addEventListener("click", ()=>{
    if(confirm("Sei sicuro di voler resettare il layout?")) location.reload();
  });

  // SALVA layout con posizione e dimensioni individuali
  document.getElementById("salvaCanvas").addEventListener("click", ()=>{
    const layout = canvas.getObjects().filter(o=>o.type==="group").map(o=>{
      return {
        left: o.left, top: o.top,
        width: o.width*o.scaleX, height: o.height*o.scaleY,
        scaleX: o.scaleX, scaleY: o.scaleY
      };
    });
    fetch("{{ url_for('salva_layout_volantino', volantino_id=volantino['id']) }}", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ layout })
    }).then(res=>res.json()).then(data=>alert(data.message))
      .catch(err=>alert("Errore salvataggio: "+err));
  });

  // DOWNLOAD PNG
  document.getElementById("downloadPng").addEventListener("click", ()=>{
    const dataURL = canvas.toDataURL({ format:"png", quality:1 });
    const link = document.createElement("a"); link.href=dataURL; link.download="volantino.png"; link.click();
  });

  // DOWNLOAD PDF
  document.getElementById("downloadPdf").addEventListener("click", ()=>{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","pt",[canvas.getWidth(), canvas.getHeight()]);
    pdf.addImage(canvas.toDataURL({ format:"png", quality:1 }), "PNG", 0, 0, canvas.getWidth(), canvas.getHeight());
    pdf.save("volantino.pdf");
  });

});
</script>

{% endblock %}
