{% extends "01_base.html" %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4">🖌 Editor Volantino</h2>

  <!-- Pulsanti globali -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="{{ url_for('visualizza_volantino', volantino_id=volantino['id']) }}" class="btn btn-secondary">⬅ Torna alla visualizzazione</a>
    <button id="salvaCanvas" class="btn btn-success">💾 Salva Layout</button>
    <button id="resetCanvas" class="btn btn-warning">🔄 Reset</button>
    <button id="downloadPng" class="btn btn-info">🖼 Scarica PNG</button>
    <button id="downloadPdf" class="btn btn-danger">📄 Scarica PDF</button>
  </div>

  <!-- Controlli zoom -->
  <div class="mb-4">
    <label class="form-label">🔍 Zoom Griglia: <span id="zoomGridValue">75%</span></label>
    <input type="range" id="zoomGrid" class="form-range" min="50" max="200" value="75">
  </div>

  <div class="mb-4">
    <label class="form-label">📦 Zoom Box Prodotto: <span id="zoomBoxValue">109%</span></label>
    <input type="range" id="zoomBox" class="form-range" min="50" max="200" value="109">
  </div>

  <!-- Controlli posizione griglia -->
  <div class="mb-4 d-flex gap-3 align-items-center flex-wrap">
    <div>
      <label for="gridPosX" class="form-label">📍 Posizione X:</label>
      <input type="number" id="gridPosX" class="form-control" value="180" step="5">
    </div>
    <div>
      <label for="gridPosY" class="form-label">📍 Posizione Y:</label>
      <input type="number" id="gridPosY" class="form-control" value="390" step="5">
    </div>
  </div>

  <!-- Canvas -->
  <div class="editor-wrapper text-center">
    <canvas id="volantinoCanvas"></canvas>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const canvas = new fabric.Canvas("volantinoCanvas", {
    preserveObjectStacking: true,
    selection: false,
  });
  canvas.setWidth(1000);
  canvas.setHeight(1400);

  // --- Sfondo volantino ---
  {% if volantino['sfondo_url'] %}
  fabric.Image.fromURL("{{ volantino['sfondo_url'] }}", function(img) {
    img.scaleToWidth(canvas.getWidth());
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
  }, { crossOrigin: "anonymous" });
  {% else %}
  canvas.setBackgroundColor("#f9f9f9", canvas.renderAll.bind(canvas));
  {% endif %}

  // --- Prodotti dal DB ---
  const volantinoProdotti = [
    {% for p in volantino_prodotti %}
    {
      url: "{% if p['immagine'] %}{{ url_for('serve_prodotto_file', filename=p['immagine']) }}{% else %}{{ url_for('static', filename='no-image.png') }}{% endif %}",
      nome: "{{ p['nome']|e }}",
      prezzo: "{{ '%.2f'|format(p['prezzo']) if p['prezzo'] is not none else '' }}",
      lasciaVuota: {{ 1 if p['lascia_vuota'] else 0 }}
    },
    {% endfor %}
  ];

  // 🔹 Funzioni principali da implementare:
  // 1. creaProdotto(url, nome, prezzo, x, y)
  // 2. buildGrid()
  // 3. gestione zoom griglia e box
  // 4. reset canvas
  // 5. salva layout via fetch POST
  // 6. download PNG e PDF

  // Nota: Puoi importare il codice già esistente per creare e posizionare prodotti
});
</script>
{% endblock %}
