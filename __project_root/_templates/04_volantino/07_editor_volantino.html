{% extends "01_base.html" %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4">🖌 Editor Volantino</h2>

  <!-- Pulsanti globali -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="{{ url_for('visualizza_volantino', volantino_id=volantino['id']) }}" class="btn btn-secondary">⬅ Torna alla visualizzazione</a>
    <button id="salvaCanvas" class="btn btn-success">💾 Salva Layout</button>
    <button id="resetCanvas" class="btn btn-warning">🔄 Reset</button>
    <button id="downloadPng" class="btn btn-info">🖼 Scarica PNG</button>
    <button id="downloadPdf" class="btn btn-danger">📄 Scarica PDF</button>
  </div>

  <!-- Controlli zoom -->
  <div class="mb-4">
    <label class="form-label">🔍 Zoom Griglia: <span id="zoomGridValue">75%</span></label>
    <input type="range" id="zoomGrid" class="form-range" min="50" max="200" value="75">
  </div>

  <div class="mb-4">
    <label class="form-label">📦 Zoom Box Prodotto: <span id="zoomBoxValue">109%</span></label>
    <input type="range" id="zoomBox" class="form-range" min="50" max="200" value="109">
  </div>

  <!-- Controlli posizione griglia -->
  <div class="mb-4 d-flex gap-3 align-items-center flex-wrap">
    <div>
      <label for="gridPosX" class="form-label">📍 Posizione X:</label>
      <input type="number" id="gridPosX" class="form-control" value="50" step="5">
    </div>
    <div>
      <label for="gridPosY" class="form-label">📍 Posizione Y:</label>
      <input type="number" id="gridPosY" class="form-control" value="50" step="5">
    </div>
  </div>

  <!-- Canvas -->
  <div class="editor-wrapper text-center">
    <canvas id="volantinoCanvas"></canvas>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const canvas = new fabric.Canvas("volantinoCanvas", { preserveObjectStacking: true, selection: false });
  canvas.setWidth(1000);
  canvas.setHeight(1400);

  let gridScale = parseInt(document.getElementById("zoomGrid").value)/100;
  let boxScale = parseInt(document.getElementById("zoomBox").value)/100;
  let startX = parseInt(document.getElementById("gridPosX").value);
  let startY = parseInt(document.getElementById("gridPosY").value);

  const objects = {{ volantino["layout_json"]|safe }}.objects || [];
  const sfondoURL = "{{ url_for('static', filename='uploads/volantini/' ~ volantino['sfondo_filename']) if volantino['sfondo_filename'] else '' }}";

  function addProduct(obj) {
    return new Promise((resolve) => {
      const metadata = obj.metadata || {};
      const url = metadata.filename
        ? "{{ url_for('static', filename='uploads/volantino_prodotti/') }}" + metadata.filename
        : "{{ url_for('static', filename='no-image.png') }}";

      fabric.Image.fromURL(url, function(img) {
        img.set({ left: 0, top: 0, width: 200*boxScale, height: 240*boxScale });
        const nomeText = new fabric.Text(metadata.nome || "", {
          left: 100*boxScale,
          top: 190*boxScale,
          fontSize: 14*boxScale,
          originX: "center",
          textAlign: "center"
        });
        const prezzoText = new fabric.Text(metadata.prezzo ? `€ ${metadata.prezzo}` : "", {
          left: 100*boxScale,
          top: 215*boxScale,
          fontSize: 18*boxScale,
          fill: "red",
          originX: "center",
          textAlign: "center"
        });
        const group = new fabric.Group([img, nomeText, prezzoText], {
          left: (obj.left || startX) * gridScale,
          top: (obj.top || startY) * gridScale,
          width: 200*boxScale,
          height: 240*boxScale
        });
        canvas.add(group);
        resolve();
      }, { crossOrigin: "anonymous" });
    });
  }

  async function buildGrid() {
    canvas.clear();

    if (sfondoURL) {
      fabric.Image.fromURL(sfondoURL, async function(img) {
        img.scaleToWidth(canvas.getWidth());
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
        for (const obj of objects) await addProduct(obj);
        canvas.renderAll();
      }, { crossOrigin: "anonymous" });
    } else {
      canvas.setBackgroundColor("#f9f9f9", canvas.renderAll.bind(canvas));
      for (const obj of objects) await addProduct(obj);
      canvas.renderAll();
    }
  }

  buildGrid();

  // --- Gestione input ---
  document.getElementById("zoomGrid").addEventListener("input", function() { gridScale = this.value/100; document.getElementById("zoomGridValue").innerText = this.value+"%"; buildGrid(); });
  document.getElementById("zoomBox").addEventListener("input", function() { boxScale = this.value/100; document.getElementById("zoomBoxValue").innerText = this.value+"%"; buildGrid(); });
  document.getElementById("gridPosX").addEventListener("input", function() { startX = parseInt(this.value); buildGrid(); });
  document.getElementById("gridPosY").addEventListener("input", function() { startY = parseInt(this.value); buildGrid(); });

  // --- Reset ---
  document.getElementById("resetCanvas").addEventListener("click", function() {
    document.getElementById("zoomGrid").value = 75;
    document.getElementById("zoomBox").value = 109;
    document.getElementById("gridPosX").value = 50;
    document.getElementById("gridPosY").value = 50;
    gridScale = 0.75;
    boxScale = 1.09;
    startX = 50;
    startY = 50;
    buildGrid();
  });

  // --- Salva layout ---
  document.getElementById("salvaCanvas").addEventListener("click", async function() {
    const layout = canvas.getObjects().map(group => {
      if (group.type === "group") {
        return {
          left: group.left,
          top: group.top,
          width: group.width * group.scaleX,
          height: group.height * group.scaleY,
          objects: group._objects.map(obj => ({
            type: obj.type,
            text: obj.text || "",
            left: obj.left,
            top: obj.top,
            fontSize: obj.fontSize,
            fill: obj.fill || "#000"
          )),
          metadata: objects.find(vp => vp.metadata && vp.metadata.nome === group._objects[1].text)?.metadata || {}
        };
      }
    }).filter(x => x);

    const res = await fetch("/volantini/{{ volantino['id'] }}/salva_layout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ layout })
    });
    const data = await res.json();
    alert(data.success ? data.message : "Errore: " + data.message);
  });

  // --- Download ---
  document.getElementById("downloadPng").addEventListener("click", function() {
    const link = document.createElement("a");
    link.href = canvas.toDataURL({ format: "png" });
    link.download = "volantino.png";
    link.click();
  });
  document.getElementById("downloadPdf").addEventListener("click", function() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: [canvas.width, canvas.height] });
    pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, canvas.width, canvas.height);
    pdf.save("volantino.pdf");
  });
});
</script>

{% endblock %}
