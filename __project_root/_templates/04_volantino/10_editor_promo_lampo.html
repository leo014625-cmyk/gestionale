{% extends "01_base.html" %}
{% block content %}

<div class="container-fluid mt-4">
  <h2 class="mb-3">ðŸ–Œ Editor Promo Lampo</h2>

  <!-- ðŸ”§ Pannello strumenti in alto -->
  <div class="card p-3 shadow-sm mb-3">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <!-- Resto dei controlli come primaâ€¦ -->
    </div>
  </div>

  <!-- Area editor -->
  <div class="text-center position-relative">
    <canvas id="promoCanvas"></canvas>
    <div id="centerTip" class="position-absolute top-50 start-50 translate-middle bg-success text-white p-1 rounded d-none">Centrato!</div>
    <div class="mt-3">
      <a href="{{ url_for('lista_volantini_completa') }}" class="btn btn-secondary">â¬… Torna alla lista</a>
    </div>
  </div>
</div>

<!-- Librerie -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const canvas = new fabric.Canvas("promoCanvas", { preserveObjectStacking: true });
  canvas.setWidth(1000);
  canvas.setHeight(1400);
  let selectedObj = null;
  const centerX = canvas.getWidth()/2;
  const centerY = canvas.getHeight()/2;
  const tolerance = 5;

  const lineH = new fabric.Line([centerX,0,centerX,canvas.getHeight()], { stroke:'rgba(0,0,0,0.3)', selectable:false, evented:false });
  const lineV = new fabric.Line([0,centerY,canvas.getWidth(),centerY], { stroke:'rgba(0,0,0,0.3)', selectable:false, evented:false });
  canvas.add(lineH,lineV);
  const centerTip = document.getElementById("centerTip");

  function checkCenter(obj){
    const objCenterX = obj.left + (obj.width*obj.scaleX)/2;
    const objCenterY = obj.top + (obj.height*obj.scaleY)/2;
    let horiz = Math.abs(objCenterX - centerX) <= tolerance;
    let vert = Math.abs(objCenterY - centerY) <= tolerance;
    obj.set({ stroke:(horiz||vert)?'lime':null, strokeWidth:(horiz||vert)?2:0 });
    canvas.renderAll();
    if(horiz && vert){ centerTip.classList.remove("d-none"); setTimeout(()=>centerTip.classList.add("d-none"),1000); }
  }

  // ðŸ”¹ Carica sfondo/layout con fallback
  {% if promo['layout'] %}
    canvas.loadFromJSON(`{{ promo['layout']|safe }}`, canvas.renderAll.bind(canvas));
  {% else %}
    {% set bg_image = promo['sfondo'] if promo['sfondo'] else 'no-image.png' %}
    fabric.Image.fromURL("{{ url_for('static', filename='uploads/promolampo/' ~ bg_image) }}", function(img) {
      img.scaleToWidth(canvas.getWidth());
      canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
    });
  {% endif %}

  // --- Resto dello script come prima: aggiungi immagini, testo, prezzo, salvataggio ecc. ---
});
</script>

{% endblock %}
