{% extends "01_base.html" %}
{% block content %}

<div class="container-fluid mt-4">
  <h2 class="mb-3">üñå Editor Promo Lampo</h2>

  <!-- üîß Pannello strumenti in alto -->
  <div class="card p-3 shadow-sm mb-3">
    <div class="d-flex flex-wrap gap-3 align-items-center">

      <!-- Aggiungi immagine -->
      <div>
        <label class="form-label small mb-1">üñº Immagine</label>
        <input type="file" id="addImage" class="form-control form-control-sm" accept="image/*">
      </div>

      <!-- Aggiungi testo -->
      <div style="min-width:220px">
        <label class="form-label small mb-1">üìù Testo</label>
        <textarea id="newText" class="form-control form-control-sm" rows="2" placeholder="Scrivi e aggiungi"></textarea>
        <button id="addText" class="btn btn-primary btn-sm mt-1 w-100">‚ûï Aggiungi</button>
        <div class="mt-1">
          <label class="form-label small mb-0">üé® Colore testo</label>
          <input type="color" id="fontColor" class="form-control form-control-color form-control-sm" value="#000000">
          <button id="toggleBold" class="btn btn-sm btn-outline-dark mt-1 w-100">B Grassetto</button>
        </div>
      </div>

      <!-- Aggiungi prezzo -->
      <div style="min-width:150px">
        <label class="form-label small mb-1">üí∂ Prezzo</label>
        <input type="text" id="priceValue" class="form-control form-control-sm" placeholder="0.00">
        <input type="color" id="priceColor" class="form-control form-control-color form-control-sm mt-1" value="#FF6600">
        <select id="priceShape" class="form-select form-select-sm mt-1">
          <option value="circle">Cerchio</option>
          <option value="roundedRect">Rettangolo arrotondato</option>
          <option value="ellipse">Ellisse</option>
        </select>
        <button id="addPrice" class="btn btn-warning btn-sm mt-1 w-100">‚ûï Aggiungi Prezzo</button>
      </div>

      <!-- Posizione -->
      <div>
        <label class="form-label small mb-1">üìç X</label>
        <input type="number" id="posX" class="form-control form-control-sm" value="0" style="width:90px">
      </div>
      <div>
        <label class="form-label small mb-1">üìç Y</label>
        <input type="number" id="posY" class="form-control form-control-sm" value="0" style="width:90px">
      </div>

      <!-- Scala -->
      <div>
        <label class="form-label small mb-1">üîç Scala (%)</label>
        <input type="number" id="scaleObj" class="form-control form-control-sm" value="100" min="10" max="300" step="5" style="width:100px">
      </div>

      <!-- Dimensione testo -->
      <div>
        <label class="form-label small mb-1">üî† Font size</label>
        <input type="number" id="fontSize" class="form-control form-control-sm" value="28" min="8" max="100" style="width:90px">
      </div>

      <!-- Larghezza testo -->
      <div>
        <label class="form-label small mb-1">‚ÜîÔ∏è Larghezza</label>
        <input type="number" id="textWidth" class="form-control form-control-sm" value="300" min="50" max="800" style="width:100px">
      </div>

      <!-- Pulsanti azione -->
      <div class="d-flex gap-2">
        <button id="deleteObj" class="btn btn-danger btn-sm">üóë Elimina</button>
        <button id="resetCanvas" class="btn btn-warning btn-sm">üîÑ Reset</button>
        <button id="downloadPng" class="btn btn-info btn-sm">üñº PNG</button>
        <button id="downloadPdf" class="btn btn-danger btn-sm">üìÑ PDF</button>
        <button id="saveLayout" class="btn btn-success btn-sm">üíæ Salva Layout</button>
      </div>
    </div>
  </div>

  <!-- Area editor -->
  <div class="text-center position-relative">
    <canvas id="promoCanvas"></canvas>
    <div id="centerTip" class="position-absolute top-50 start-50 translate-middle bg-success text-white p-1 rounded d-none">Centrato!</div>
    <div class="mt-3">
      <a href="{{ url_for('lista_volantini_completa') }}" class="btn btn-secondary">‚¨Ö Torna alla lista</a>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const canvas = new fabric.Canvas("promoCanvas", { preserveObjectStacking: true });
  canvas.setWidth(1000);
  canvas.setHeight(1400);
  let selectedObj = null;
  const centerX = canvas.getWidth()/2;
  const centerY = canvas.getHeight()/2;
  const tolerance = 5;

  const lineH = new fabric.Line([centerX,0,centerX,canvas.getHeight()], { stroke:'rgba(0,0,0,0.3)', selectable:false, evented:false });
  const lineV = new fabric.Line([0,centerY,canvas.getWidth(),centerY], { stroke:'rgba(0,0,0,0.3)', selectable:false, evented:false });
  canvas.add(lineH,lineV);
  const centerTip = document.getElementById("centerTip");

  function checkCenter(obj){
    const objCenterX = obj.left + (obj.width*obj.scaleX)/2;
    const objCenterY = obj.top + (obj.height*obj.scaleY)/2;
    let horiz = Math.abs(objCenterX - centerX) <= tolerance;
    let vert = Math.abs(objCenterY - centerY) <= tolerance;
    obj.set({ stroke:(horiz||vert)?'lime':null, strokeWidth:(horiz||vert)?2:0 });
    canvas.renderAll();
    if(horiz && vert){ centerTip.classList.remove("d-none"); setTimeout(()=>centerTip.classList.add("d-none"),1000); }
  }

  // --- Caricamento sfondo e elementi principali ---
  {% set bg_image = promo['sfondo'] if promo['sfondo'] else 'no-image.png' %}
  fabric.Image.fromURL("{{ url_for('static', filename='uploads/promolampo/' ~ bg_image) }}", function(img) {
    img.scaleToWidth(canvas.getWidth());
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

    // --- Aggiungi immagine prodotto ---
    {% if promo['immagine'] %}
    fabric.Image.fromURL("{{ url_for('static', filename='uploads/promolampo/' ~ promo['immagine']) }}", function(prodImg){
      prodImg.scaleToWidth(400);
      prodImg.set({ left:300, top:300 });
      canvas.add(prodImg);
    });
    {% endif %}

    // --- Aggiungi nome prodotto ---
    {% if promo['nome'] %}
    const nameText = new fabric.Textbox("{{ promo['nome'] }}", {
      left: 50,
      top: 50,
      fontSize: 48,
      fill: "#000",
      fontWeight: "bold",
      width: 900
    });
    canvas.add(nameText);
    {% endif %}

    // --- Aggiungi prezzo ---
    {% if promo['prezzo'] %}
    const radius = 50;
    const color = "#FF6600";
    const shapeObj = new fabric.Circle({ radius, fill: color, originX:'center', originY:'center' });
    const priceText = new fabric.Text("{{ promo['prezzo'] }}‚Ç¨", { fontSize:33, fill:'white', fontWeight:'bold', originX:'center', originY:'center', textAlign:'center' });
    const priceGroup = new fabric.Group([shapeObj, priceText], { left:800, top:300, originX:'center', originY:'center' });
    canvas.add(priceGroup);
    {% endif %}
  });

  // Il resto dello script rimane invariato (aggiungi testo, immagini, prezzo, selezione, download, ecc.)
  // ...

});
</script>

{% endblock %}
