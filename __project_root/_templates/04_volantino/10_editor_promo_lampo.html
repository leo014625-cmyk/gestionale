{% extends "01_base.html" %}
{% block content %}

<div class="container-fluid mt-4">
  <h2 class="mb-3">🖌 Editor Promo Lampo</h2>

  <!-- 🔧 Pannello strumenti -->
  <div class="card p-3 shadow-sm mb-3">
    <div class="d-flex flex-wrap gap-3 align-items-center">

      <!-- Aggiungi immagine -->
      <div>
        <label class="form-label small mb-1">🖼 Immagine</label>
        <input type="file" id="addImage" class="form-control form-control-sm" accept="image/*">
      </div>

      <!-- Aggiungi testo -->
      <div style="min-width:220px">
        <label class="form-label small mb-1">📝 Testo</label>
        <textarea id="newText" class="form-control form-control-sm" rows="2" placeholder="Scrivi e aggiungi"></textarea>
        <button id="addText" class="btn btn-primary btn-sm mt-1 w-100">➕ Aggiungi</button>
        <div class="mt-1">
          <label class="form-label small mb-0">🎨 Colore testo</label>
          <input type="color" id="fontColor" class="form-control form-control-color form-control-sm" value="#000000">
          <button id="toggleBold" class="btn btn-sm btn-outline-dark mt-1 w-100">B Grassetto</button>
        </div>
      </div>

      <!-- Aggiungi prezzo -->
      <div style="min-width:150px">
        <label class="form-label small mb-1">💶 Prezzo</label>
        <input type="text" id="priceValue" class="form-control form-control-sm" placeholder="0.00">
        <input type="color" id="priceColor" class="form-control form-control-color form-control-sm mt-1" value="#FF6600">
        <select id="priceShape" class="form-select form-select-sm mt-1">
          <option value="circle">Cerchio</option>
          <option value="roundedRect">Rettangolo arrotondato</option>
          <option value="ellipse">Ellisse</option>
        </select>
        <button id="addPrice" class="btn btn-warning btn-sm mt-1 w-100">➕ Aggiungi Prezzo</button>
      </div>

      <!-- Posizione -->
      <div>
        <label class="form-label small mb-1">📍 X</label>
        <input type="number" id="posX" class="form-control form-control-sm" value="0" style="width:90px">
      </div>
      <div>
        <label class="form-label small mb-1">📍 Y</label>
        <input type="number" id="posY" class="form-control form-control-sm" value="0" style="width:90px">
      </div>

      <!-- Scala -->
      <div>
        <label class="form-label small mb-1">🔍 Scala (%)</label>
        <input type="number" id="scaleObj" class="form-control form-control-sm" value="100" min="10" max="300" step="5" style="width:100px">
      </div>

      <!-- Dimensione testo -->
      <div>
        <label class="form-label small mb-1">🔠 Font size</label>
        <input type="number" id="fontSize" class="form-control form-control-sm" value="28" min="8" max="100" style="width:90px">
      </div>

      <!-- Larghezza testo -->
      <div>
        <label class="form-label small mb-1">↔️ Larghezza</label>
        <input type="number" id="textWidth" class="form-control form-control-sm" value="300" min="50" max="800" style="width:100px">
      </div>

      <!-- Pulsanti azione -->
      <div class="d-flex gap-2">
        <button id="deleteObj" class="btn btn-danger btn-sm">🗑 Elimina</button>
        <button id="resetCanvas" class="btn btn-warning btn-sm">🔄 Reset</button>
        <button id="downloadPng" class="btn btn-info btn-sm">🖼 PNG</button>
        <button id="downloadPdf" class="btn btn-danger btn-sm">📄 PDF</button>
        <button id="saveLayout" class="btn btn-success btn-sm">💾 Salva Layout</button>
      </div>
    </div>
  </div>

  <!-- Area editor -->
  <div class="text-center position-relative">
    <canvas id="promoCanvas"></canvas>
    <div class="mt-3">
      <a href="{{ url_for('lista_volantini_completa') }}" class="btn btn-secondary">⬅ Torna alla lista</a>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const canvas = new fabric.Canvas("promoCanvas", { preserveObjectStacking: true });
  canvas.setWidth(1000);
  canvas.setHeight(1400);
  let selectedObj = null;

  // Carica sfondo e oggetti iniziali
  {% set bg_image = promo['sfondo'] if promo['sfondo'] else 'no-image.png' %}
  fabric.Image.fromURL("{{ url_for('static', filename='uploads/promolampo/' ~ bg_image) }}", function(img) {
    img.scaleToWidth(canvas.getWidth());
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

    {% if promo['immagine'] %}
    fabric.Image.fromURL("{{ url_for('static', filename='uploads/promolampo/' ~ promo['immagine']) }}", function(prodImg){
      prodImg.scaleToWidth(400);
      prodImg.set({ left:300, top:300 });
      canvas.add(prodImg);
    });
    {% endif %}

    {% if promo['nome'] %}
    const nameText = new fabric.Textbox("{{ promo['nome'] }}", {
      left: 50, top: 50, fontSize: 48, fill: "#000", fontWeight: "bold", width: 900
    });
    canvas.add(nameText);
    {% endif %}

    {% if promo['prezzo'] %}
    const radius = 50;
    const color = "#FF6600";
    const shapeObj = new fabric.Circle({ radius, fill: color, originX:'center', originY:'center' });
    const priceText = new fabric.Text("{{ promo['prezzo'] }}€", { fontSize:33, fill:'white', fontWeight:'bold', originX:'center', originY:'center', textAlign:'center' });
    const priceGroup = new fabric.Group([shapeObj, priceText], { left:800, top:300, originX:'center', originY:'center' });
    canvas.add(priceGroup);
    {% endif %}
  });

  // 🔹 Selezione oggetti
  canvas.on("selection:created", e => selectedObj = e.selected[0]);
  canvas.on("selection:updated", e => selectedObj = e.selected[0]);
  canvas.on("selection:cleared", () => selectedObj = null);

  // 🔹 Aggiungi testo
  document.getElementById("addText").addEventListener("click", () => {
    const textVal = document.getElementById("newText").value;
    if(!textVal) return;
    const text = new fabric.Textbox(textVal, {
      left: 100, top: 100, fontSize: parseInt(document.getElementById("fontSize").value),
      fill: document.getElementById("fontColor").value, width: parseInt(document.getElementById("textWidth").value)
    });
    canvas.add(text);
  });

  // 🔹 Aggiungi immagine
  document.getElementById("addImage").addEventListener("change", e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = f => {
      fabric.Image.fromURL(f.target.result, img => {
        img.scaleToWidth(300);
        img.set({ left:200, top:200 });
        canvas.add(img);
      });
    };
    reader.readAsDataURL(file);
  });

  // 🔹 Aggiungi prezzo
  document.getElementById("addPrice").addEventListener("click", () => {
    const value = document.getElementById("priceValue").value;
    if(!value) return;
    const color = document.getElementById("priceColor").value;
    const shape = document.getElementById("priceShape").value;
    let shapeObj;
    if(shape === "circle") shapeObj = new fabric.Circle({ radius:50, fill:color, originX:'center', originY:'center' });
    if(shape === "ellipse") shapeObj = new fabric.Ellipse({ rx:70, ry:50, fill:color, originX:'center', originY:'center' });
    if(shape === "roundedRect") shapeObj = new fabric.Rect({ width:120, height:70, rx:20, ry:20, fill:color, originX:'center', originY:'center' });
    const priceText = new fabric.Text(value+"€", { fontSize:32, fill:"white", fontWeight:"bold", originX:'center', originY:'center' });
    const group = new fabric.Group([shapeObj, priceText], { left:400, top:400 });
    canvas.add(group);
  });

  // 🔹 Bold toggle
  document.getElementById("toggleBold").addEventListener("click", () => {
    if(selectedObj && selectedObj.type === "textbox"){
      selectedObj.set("fontWeight", selectedObj.fontWeight === "bold" ? "normal" : "bold");
      canvas.renderAll();
    }
  });

  // 🔹 Cambia colore testo
  document.getElementById("fontColor").addEventListener("input", e => {
    if(selectedObj && selectedObj.type === "textbox"){
      selectedObj.set("fill", e.target.value);
      canvas.renderAll();
    }
  });

  // 🔹 Posizione
  document.getElementById("posX").addEventListener("input", e => { if(selectedObj){ selectedObj.left = parseInt(e.target.value); canvas.renderAll(); }});
  document.getElementById("posY").addEventListener("input", e => { if(selectedObj){ selectedObj.top = parseInt(e.target.value); canvas.renderAll(); }});

  // 🔹 Scala
  document.getElementById("scaleObj").addEventListener("input", e => {
    if(selectedObj){
      const scale = parseInt(e.target.value)/100;
      selectedObj.scaleX = scale;
      selectedObj.scaleY = scale;
      canvas.renderAll();
    }
  });

  // 🔹 Font size e larghezza testo
  document.getElementById("fontSize").addEventListener("input", e => { if(selectedObj && selectedObj.type==="textbox"){ selectedObj.set("fontSize", parseInt(e.target.value)); canvas.renderAll(); }});
  document.getElementById("textWidth").addEventListener("input", e => { if(selectedObj && selectedObj.type==="textbox"){ selectedObj.set("width", parseInt(e.target.value)); canvas.renderAll(); }});

  // 🔹 Elimina
  document.getElementById("deleteObj").addEventListener("click", () => { if(selectedObj){ canvas.remove(selectedObj); selectedObj=null; }});

  // 🔹 Reset
  document.getElementById("resetCanvas").addEventListener("click", () => { canvas.clear(); });

  // 🔹 Download PNG
  document.getElementById("downloadPng").addEventListener("click", () => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL({ format:"png" });
    link.download = "promo.png";
    link.click();
  });

  // 🔹 Download PDF
  document.getElementById("downloadPdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","pt","a4");
    pdf.addImage(canvas.toDataURL({ format:"png" }), "PNG", 0, 0, 595, 842);
    pdf.save("promo.pdf");
  });

  // 🔹 Salva Layout (serializza oggetti in JSON)
  document.getElementById("saveLayout").addEventListener("click", () => {
    const layout = JSON.stringify(canvas.toJSON());
    console.log("💾 Layout salvato:", layout);
    alert("Layout salvato in console log! (da integrare con backend)");
  });
});
</script>

{% endblock %}
