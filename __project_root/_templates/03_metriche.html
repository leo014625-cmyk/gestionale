<div class="row g-4">

  <!-- Clienti totali -->
  <div class="col-12 col-md-2">
    <div class="card metric-card text-center p-3 h-100 shadow-sm" style="height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center">
        <i class="bi bi-people-fill fs-1 text-primary mb-2"></i>
        <h6>Clienti Totali</h6>
        <h2 class="fw-bold mb-0 text-dark">
          {{ clienti|length if clienti is defined else 0 }}
        </h2>
      </div>
    </div>
  </div>

  <!-- Fatturato totale -->
  <div class="col-12 col-md-2">
    <div class="card metric-card text-center p-3 h-100 shadow-sm" style="height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center">
        <i class="bi bi-cash-stack fs-1 text-success mb-2"></i>
        <h6>Fatturato Totale</h6>
        <h2 class="fw-bold mb-0 text-dark">
          € {{ clienti|map(attribute='fatturato_totale')|sum|default(0)|float|round(2) }}
        </h2>
      </div>
    </div>
  </div>

  <!-- Media per cliente -->
  <div class="col-12 col-md-2">
    <div class="card metric-card text-center p-3 h-100 shadow-sm" style="height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center">
        <i class="bi bi-bar-chart-line fs-1 text-info mb-2"></i>
        <h6>Media per Cliente</h6>
        {% set totale = clienti|map(attribute='fatturato_totale')|sum %}
        <h2 class="fw-bold mb-0 text-dark">
          € {{ (totale / (clienti|length) if clienti|length > 0 else 0) | round(2) }}
        </h2>
      </div>
    </div>
  </div>

  <!-- Mini grafico fatturato per zona (a barre) -->
  <div class="col-12 col-md-3">
    <div class="card metric-card text-center p-3 h-100 shadow-sm" style="height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center">
        <i class="bi bi-bar-chart-fill fs-1 text-warning mb-2"></i>
        <h6>Fatturato per Zona</h6>
        <canvas id="miniFatturatoZonaChart" height="90"></canvas>
      </div>
    </div>
  </div>

  <!-- Crescita mensile -->
  <div class="col-12 col-md-3">
    <div class="card metric-card text-center p-3 h-100 shadow-sm" style="height: 220px;">
      <div class="card-body d-flex flex-column justify-content-center">
        <i class="bi bi-graph-up-arrow fs-1 mb-2" id="trendIcon"></i>
        <h6>Crescita Mensile</h6>
        <h2 id="trendPercent" class="fw-bold mb-0 text-dark">--</h2>
        <p class="text-muted small mb-0">rispetto al mese precedente</p>
      </div>
    </div>
  </div>

</div>

<!-- Script grafici -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // ===== Mini grafico per zona (a barre) =====
  const fatturatoZona = {{ fatturato_per_zona|default({})|tojson }};
  if (Object.keys(fatturatoZona).length > 0) {
    const ctx = document.getElementById('miniFatturatoZonaChart').getContext('2d');
    const colori = ['#4a90e2','#50e3c2','#f5a623','#e94e77','#7b61ff','#b8e986'];
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(fatturatoZona),
        datasets: [{
          label: '€',
          data: Object.values(fatturatoZona),
          backgroundColor: colori,
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: '#6c757d', font: { size: 11 } } },
          y: { grid: { display: false }, ticks: { display: false } }
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // ===== Crescita mensile =====
  const fatturatoMensile = {{ fatturato_mensile|default({})|tojson }};
  const mesi = Object.keys(fatturatoMensile);
  if (mesi.length >= 2) {
    const meseCorrente = mesi[mesi.length - 1];
    const mesePrecedente = mesi[mesi.length - 2];
    const valoreCorrente = fatturatoMensile[meseCorrente];
    const valorePrecedente = fatturatoMensile[mesePrecedente];
    const diff = valorePrecedente > 0 ? ((valoreCorrente - valorePrecedente) / valorePrecedente * 100).toFixed(1) : 0;
    
    const trend = document.getElementById("trendPercent");
    const icon = document.getElementById("trendIcon");
    trend.textContent = (diff >= 0 ? '+' : '') + diff + '%';
    trend.classList.remove('text-success','text-danger');
    trend.classList.add(diff >= 0 ? 'text-success' : 'text-danger');
    icon.classList.remove('text-success','text-danger','bi-graph-up-arrow','bi-graph-down-arrow');
    icon.classList.add(diff >= 0 ? 'text-success' : 'text-danger');
    icon.classList.add(diff >= 0 ? 'bi-graph-up-arrow' : 'bi-graph-down-arrow');
  }
})();
</script>
