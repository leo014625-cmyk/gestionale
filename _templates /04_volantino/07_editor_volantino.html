{% extends "01_base.html" %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4">üñå Editor Volantino</h2>

  <!-- Pulsanti globali -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="{{ url_for('visualizza_volantino', volantino_id=volantino['id']) }}" class="btn btn-secondary">‚¨Ö Torna alla visualizzazione</a>
    <button id="salvaCanvas" class="btn btn-success">üíæ Salva Layout</button>
    <button id="resetCanvas" class="btn btn-warning">üîÑ Reset</button>
    <button id="downloadPng" class="btn btn-info">üñº Scarica PNG</button>
    <button id="downloadPdf" class="btn btn-danger">üìÑ Scarica PDF</button>
  </div>

  <!-- Controlli zoom -->
  <div class="mb-4">
    <label class="form-label">üîç Zoom Griglia: <span id="zoomGridValue">75%</span></label>
    <input type="range" id="zoomGrid" class="form-range" min="50" max="200" value="75">
  </div>

  <div class="mb-4">
    <label class="form-label">üì¶ Zoom Box Prodotto: <span id="zoomBoxValue">109%</span></label>
    <input type="range" id="zoomBox" class="form-range" min="50" max="200" value="109">
  </div>

  <!-- üîπ Controlli posizione griglia -->
  <div class="mb-4 d-flex gap-3 align-items-center flex-wrap">
    <div>
      <label for="gridPosX" class="form-label">üìç Posizione X:</label>
      <input type="number" id="gridPosX" class="form-control" value="180" step="5">
    </div>
    <div>
      <label for="gridPosY" class="form-label">üìç Posizione Y:</label>
      <input type="number" id="gridPosY" class="form-control" value="390" step="5">
    </div>
  </div>

  <!-- Canvas -->
  <div class="editor-wrapper text-center">
    <canvas id="volantinoCanvas"></canvas>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const canvas = new fabric.Canvas("volantinoCanvas", {
    preserveObjectStacking: true,
    selection: false,
  });
  canvas.setWidth(1000);
  canvas.setHeight(1400);

  // --- Sfondo volantino ---
  {% if volantino['sfondo'] %}
  fabric.Image.fromURL("{{ url_for('static', filename='uploads/volantini/' ~ volantino['sfondo']) }}", function(img) {
    img.scaleToWidth(canvas.getWidth());
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
  });
  {% else %}
  canvas.setBackgroundColor("#f9f9f9", canvas.renderAll.bind(canvas));
  {% endif %}

  // --- Prodotti dal DB ---
  const volantinoProdotti = [
    {% for p in volantino_prodotti %}
    {
      url: "{{ url_for('static', filename='uploads/volantino_prodotti/' ~ p['immagine']) if p['immagine'] else '' }}",
      nome: "{{ p['nome']|e }}",
      prezzo: "{{ '%.2f'|format(p['prezzo']) if p['prezzo'] is not none else '' }}",
      lasciaVuota: {{ 1 if p['lascia_vuota'] else 0 }}
    },
    {% endfor %}
  ];

  // --- Funzione crea prodotto allineata dal basso ---
function creaProdotto(url, nome, prezzo, x, y, cellW, cellH) {
  return new Promise((resolve) => {
    const elements = [];

    const textAreaHeight = 80; // spazio fisso per nome + prezzo
    const imgAreaHeight = cellH - textAreaHeight; // area fissa per immagine

    function addTexts() {
      // Nome prodotto - posizione sempre fissa dal basso
      const textNome = new fabric.Textbox(nome || "", {
        fontSize: 14,
        fill: "black",
        fontWeight: "bold",
        width: cellW - 20,
        top: cellH - 65, // distanza fissa dal basso
        left: cellW / 2,
        originX: "center",
        textAlign: "center",
        selectable: false,
        evented: false
      });

      // Prezzo prodotto - posizione sempre fissa dal basso
      const textPrezzo = new fabric.Text(prezzo ? "‚Ç¨ " + prezzo : "", {
        fontSize: 22,
        fill: "red",
        fontWeight: "bold",
        top: cellH - 30, // distanza fissa dal basso
        left: cellW / 2,
        originX: "center",
        textAlign: "center",
        selectable: false,
        evented: false
      });

      // Linea decorativa
      const line = new fabric.Line([5, cellH - 5, cellW - 5, cellH - 5], {
        stroke: "#800020",
        strokeWidth: 2,
        selectable: false,
        evented: false
      });

      elements.push(textNome, textPrezzo, line);

      const group = new fabric.Group(elements, {
        left: x,
        top: y,
        width: cellW,
        height: cellH,
        selectable: false
      });

      resolve(group);
    }

    if (url) {
      fabric.Image.fromURL(url, function(fabricImg) {
        const scaleX = (cellW - 20) / fabricImg.width;
        const scaleY = imgAreaHeight / fabricImg.height;
        const scale = Math.min(scaleX, scaleY, 1); // scala per stare dentro la box

        const imgWidthScaled = fabricImg.width * scale;
        const imgHeightScaled = fabricImg.height * scale;

        // Immagine posizionata in alto della sua area (lascia spazio per testo in basso)
        fabricImg.set({
          scaleX: scale,
          scaleY: scale,
          left: (cellW - imgWidthScaled) / 2,
          top: 0, // parte dall‚Äôalto della box immagine
          selectable: false,
          evented: false
        });

        elements.push(fabricImg);
        addTexts();
      }, { crossOrigin: "anonymous" });
    } else {
      addTexts();
    }
      function addTexts() {
        const textNome = new fabric.Textbox(nome || "", {
          fontSize: 14,
          fill: "black",
          fontWeight: "bold",
          top: cellH - 65,
          left: cellW / 2,
          width: cellW - 20,
          originX: "center",
          textAlign: "center"
        });

        const textPrezzo = new fabric.Text(prezzo ? "‚Ç¨ " + prezzo : "", {
          fontSize: 22,
          fill: "red",
          fontWeight: "bold",
          top: cellH - 30,
          left: cellW / 2,
          originX: "center",
          textAlign: "center"
        });

        const line = new fabric.Line(
          [5, cellH - 5, cellW - 5, cellH - 5],
          { stroke: "#800020", strokeWidth: 2, selectable: false, evented: false }
        );

        elements.push(textNome, textPrezzo, line);

        const group = new fabric.Group(elements, {
          left: x,
          top: y,
          width: cellW,
          height: cellH,
          selectable: false
        });
        resolve(group);
      }
    });
  }

  // --- Crea griglia 3x3 ---
  const cols = 3, rows = 3;
  const maxSlots = cols * rows;
  const baseCellW = 200, baseCellH = 240;
  const marginX = 30, marginY = 30;
  let gridGroup;
  let currentBoxScale = 1.09;

  function buildGrid(boxScale=1) {
    const promises = [];
    for (let i = 0; i < maxSlots; i++) {
      let col = i % cols;
      let row = Math.floor(i / cols);
      let x = col * (baseCellW + marginX);
      let y = row * (baseCellH + marginY);

      if (volantinoProdotti[i]) {
        const p = volantinoProdotti[i];
        if (p.lasciaVuota === 1) {
          const rect = new fabric.Rect({
            left: x,
            top: y,
            width: baseCellW * boxScale,
            height: baseCellH * boxScale,
            fill: "transparent",
            stroke: "transparent",
            selectable: false
          });
          promises.push(Promise.resolve(rect));
        } else {
          promises.push(
            creaProdotto(
              p.url, p.nome, p.prezzo,
              x, y,
              baseCellW * boxScale, baseCellH * boxScale
            )
          );
        }
      } else {
        const rect = new fabric.Rect({
          left: x,
          top: y,
          width: baseCellW * boxScale,
          height: baseCellH * boxScale,
          fill: "transparent",
          stroke: "transparent",
          selectable: false
        });
        promises.push(Promise.resolve(rect));
      }
    }
    return Promise.all(promises);
  }

  // --- Inizializza griglia (posizione iniziale X=180, Y=390) ---
  buildGrid(currentBoxScale).then(objects => {
    gridGroup = new fabric.Group(objects, { left: 180, top: 390, selectable: true });
    canvas.add(gridGroup);
    canvas.renderAll();
  });

  // --- Slider zoom griglia ---
  document.getElementById("zoomGrid").addEventListener("input", (e) => {
    if (gridGroup) {
      const scale = e.target.value / 100;
      gridGroup.scaleX = scale;
      gridGroup.scaleY = scale;
      document.getElementById("zoomGridValue").textContent = e.target.value + "%";
      canvas.renderAll();
    }
  });

  // --- Slider zoom box ---
  document.getElementById("zoomBox").addEventListener("input", (e) => {
    currentBoxScale = e.target.value / 100;
    document.getElementById("zoomBoxValue").textContent = e.target.value + "%";
    canvas.remove(gridGroup);
    buildGrid(currentBoxScale).then(objects => {
      gridGroup = new fabric.Group(objects, {
        left: parseInt(document.getElementById("gridPosX").value) || 180,
        top: parseInt(document.getElementById("gridPosY").value) || 390,
        selectable: true
      });
      canvas.add(gridGroup);
      canvas.renderAll();
    });
  });

  // --- Controlli posizione griglia ---
  document.getElementById("gridPosX").addEventListener("input", (e) => {
    if (gridGroup) {
      gridGroup.left = parseInt(e.target.value) || 0;
      canvas.renderAll();
    }
  });

  document.getElementById("gridPosY").addEventListener("input", (e) => {
    if (gridGroup) {
      gridGroup.top = parseInt(e.target.value) || 0;
      canvas.renderAll();
    }
  });

  // --- Reset ---
  document.getElementById("resetCanvas").addEventListener("click", () => {
    if (confirm("Sei sicuro di voler resettare il layout?")) {
      location.reload();
    }
  });

  // --- Salva layout ---
  document.getElementById("salvaCanvas").addEventListener("click", () => {
    const json = canvas.toJSON(["metadata"]);
    fetch("{{ url_for('salva_layout_volantino', volantino_id=volantino['id']) }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ layout: json })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
    })
    .catch(err => alert("Errore salvataggio: " + err));
  });

  // --- Scarica PNG ---
  document.getElementById("downloadPng").addEventListener("click", () => {
    const dataURL = canvas.toDataURL({ format: "png", quality: 1 });
    const link = document.createElement("a");
    link.href = dataURL;
    link.download = "volantino.png";
    link.click();
  });

  // --- Scarica PDF ---
  document.getElementById("downloadPdf").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "pt", [canvas.getWidth(), canvas.getHeight()]);
    const dataURL = canvas.toDataURL({ format: "png", quality: 1 });
    pdf.addImage(dataURL, "PNG", 0, 0, canvas.getWidth(), canvas.getHeight());
    pdf.save("volantino.pdf");
  });
});
</script>
{% endblock %}


